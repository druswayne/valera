{% extends "base.html" %}

{% block title %}–†–µ–π–¥ –±–æ—Å—Å–∞ - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', Arial, sans-serif;
    background: linear-gradient(135deg, #8b0000 0%, #ff4500 100%);
    min-height: 100vh;
    padding: 10px;
}

.raid-boss-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 25px;
    background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
    border-radius: 25px;
    border: 4px solid #dc143c;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
}

.boss-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
    border-radius: 20px;
    color: white;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.boss-header h1 {
    font-size: 48px;
    margin-bottom: 15px;
    text-shadow: 3px 3px 0px #000;
    font-weight: bold;
    letter-spacing: 2px;
}

.boss-animation-container {
    margin: 20px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: auto;
    overflow: visible;
}

.boss-animation {
    width: auto;
    height: 400px;
    object-fit: contain;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
}

.boss-health-bar {
    margin-top: 20px;
    background: #333;
    border-radius: 25px;
    height: 40px;
    overflow: hidden;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
    border: 3px solid #000;
}

.boss-health-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff0000 0%, #ff4500 50%, #ff6b6b 100%);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    color: white;
    text-shadow: 2px 2px 0px #000;
}

.boss-rewards {
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    border-radius: 15px;
    border: 3px solid #ff8c00;
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}

.boss-rewards h3 {
    font-size: 24px;
    margin: 0 0 15px 0;
    color: #8b0000;
    text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.5);
    text-align: center;
    font-weight: bold;
}

.boss-rewards-content {
    font-size: 18px;
    color: #333;
    line-height: 1.6;
    white-space: pre-wrap;
    text-align: center;
}

.class-damage-table {
    margin-bottom: 30px;
    background: #fff;
    padding: 20px;
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 3px solid #d4c5b0;
}

.class-damage-table h2 {
    color: #8b6fa8;
    font-size: 28px;
    margin-bottom: 20px;
    text-align: center;
    text-shadow: 1px 1px 0px #e8d5c4;
}

.class-damage-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.class-damage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    border: 2px solid #d4c5b0;
    transition: all 0.3s ease;
}

.class-damage-item:hover {
    border-color: #8b6fa8;
    box-shadow: 0 3px 10px rgba(139, 111, 168, 0.2);
}

.class-name {
    font-size: 18px;
    font-weight: bold;
    color: #8b6fa8;
}

.damage-value {
    font-size: 20px;
    font-weight: bold;
    color: #dc143c;
}

.battle-button-container {
    text-align: center;
    margin: 40px 0;
}

.battle-btn {
    background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
    color: white;
    border: none;
    padding: 25px 50px;
    border-radius: 25px;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(220, 20, 60, 0.4);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 0px #000;
    border: 4px solid #000;
}

.battle-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 35px rgba(220, 20, 60, 0.6);
}

.battle-btn:active {
    transform: translateY(-2px) scale(1.02);
}

.battle-btn:disabled {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    opacity: 0.7;
}

.inactive-message {
    text-align: center;
    padding: 15px;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    border-radius: 15px;
    border: 3px solid #e65100;
    box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
}

.inactive-message p {
    margin: 0;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
}

.task-card {
    background: #fff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 3px solid #d4c5b0;
    margin-top: 30px;
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
    max-width: 100%;
}

.task-title {
    color: #7a8fb8;
    font-size: 32px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
}

.task-description {
    color: #333;
    font-size: 18px;
    line-height: 1.8;
    margin-bottom: 20px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.task-image {
    max-width: 100%;
    height: auto;
    border-radius: 20px;
    margin: 20px auto;
    display: block;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    border: 3px solid #d4c5b0;
}

.task-form {
    background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c4 100%);
    padding: 30px;
    border-radius: 20px;
    margin-top: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 3px solid #c8a2c8;
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
    max-width: 100%;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    color: #333;
    margin-bottom: 10px;
    font-size: 20px;
    font-weight: bold;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 18px;
    border-radius: 15px;
    border: 3px solid #a8b8d0;
    background-color: #fff;
    color: #333;
    font-size: 18px;
    font-family: 'Comic Sans MS', Arial, sans-serif;
    transition: all 0.3s ease;
    box-sizing: border-box;
    max-width: 100%;
    word-wrap: break-word;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #8b6fa8;
    box-shadow: 0 0 15px rgba(139, 111, 168, 0.3);
    transform: scale(1.02);
}

.submit-btn {
    background: linear-gradient(135deg, #8b9dc8 0%, #9b8fb8 100%);
    color: #fff;
    border: none;
    padding: 18px 40px;
    border-radius: 15px;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    box-shadow: 0 5px 15px rgba(139, 157, 200, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(139, 157, 200, 0.4);
}

.submit-btn:disabled {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    cursor: not-allowed;
    opacity: 0.6;
    transform: none;
    box-shadow: none;
}

.message-box {
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
}

.message-success {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border: 3px solid #2e7d32;
}

.message-error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    color: white;
    border: 3px solid #c62828;
}

.message-info {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
    border: 3px solid #1565C0;
}

.retry-btn {
    background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
    color: #fff;
    border: none;
    padding: 20px 50px;
    border-radius: 25px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: 0 8px 25px rgba(220, 20, 60, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 0px #000;
    border: 4px solid #000;
    display: inline-block;
    animation: pulse 2s infinite;
    white-space: nowrap;
    max-width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.retry-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 35px rgba(220, 20, 60, 0.7);
    background: linear-gradient(135deg, #ff1744 0%, #b71c1c 100%);
}

.retry-btn:active {
    transform: translateY(-2px) scale(1.02);
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 8px 25px rgba(220, 20, 60, 0.5);
    }
    50% {
        box-shadow: 0 8px 35px rgba(220, 20, 60, 0.8);
    }
}

.no-boss-message {
    text-align: center;
    padding: 60px 20px;
    color: #666;
    font-size: 24px;
}

.defeated-boss {
    text-align: center;
    padding: 40px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border-radius: 20px;
    margin-top: 30px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.defeated-boss h2 {
    font-size: 36px;
    margin-bottom: 15px;
    text-shadow: 2px 2px 0px #2e7d32;
}

.defeated-boss p {
    font-size: 20px;
    margin: 10px 0;
}

@media (max-width: 768px) {
    body {
        padding: 5px;
    }
    
    .raid-boss-container {
        margin: 10px auto;
        padding: 15px;
        border-radius: 20px;
        border-width: 3px;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
    .modal-overlay {
        padding: 15px;
    }
    
    .modal-content {
        padding: 25px;
        width: 95%;
        max-width: 450px;
        border-radius: 20px;
        border-width: 2px;
    }
    
    .modal-title {
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .modal-close {
        width: 35px;
        height: 35px;
        font-size: 24px;
        top: 10px;
        right: 10px;
    }
    
    .boss-header {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 15px;
    }
    
    .boss-header h1 {
        font-size: 28px;
        margin-bottom: 12px;
        letter-spacing: 1px;
    }
    
    .boss-health-bar {
        height: 35px;
        border-radius: 20px;
        border-width: 2px;
        margin-top: 15px;
    }
    
    .boss-health-fill {
        font-size: 16px;
    }
    
    .boss-animation-container {
        height: auto;
        margin: 15px 0;
    }
    
    .boss-animation {
        height: 300px;
    }
    
    .boss-rewards {
        margin-top: 15px;
        padding: 15px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .boss-rewards h3 {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .boss-rewards-content {
        font-size: 16px;
    }
    
    .class-damage-table {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 15px;
        border-width: 2px;
    }
    
    .class-damage-table h2 {
        font-size: 22px;
        margin-bottom: 15px;
    }
    
    .class-damage-item {
        padding: 12px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        box-sizing: border-box;
    }
    
    .class-name {
        font-size: 16px;
        flex: 1;
        word-wrap: break-word;
    }
    
    .damage-value {
        font-size: 18px;
        flex-shrink: 0;
        text-align: right;
        word-wrap: break-word;
        white-space: nowrap;
    }
    
    .battle-button-container {
        margin: 30px 0;
    }
    
    .battle-btn {
        padding: 18px 30px;
        font-size: 22px;
        letter-spacing: 1px;
        border-width: 3px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
    }
    
    .task-card {
        padding: 20px;
        border-radius: 15px;
        border-width: 2px;
        margin-top: 20px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .task-title {
        font-size: 22px;
        margin-bottom: 15px;
    }
    
    .task-description {
        font-size: 16px;
        margin-bottom: 15px;
        line-height: 1.6;
    }
    
    .task-image {
        max-width: 100%;
        border-radius: 15px;
        border-width: 2px;
        margin: 15px auto;
    }
    
    .task-form {
        padding: 20px;
        border-radius: 15px;
        border-width: 2px;
        margin-top: 15px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group select {
        padding: 14px;
        font-size: 16px;
        border-radius: 12px;
        border-width: 2px;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
    }
    
    .submit-btn {
        padding: 16px 30px;
        font-size: 18px;
        border-radius: 12px;
    }
    
    .message-box {
        padding: 18px;
        font-size: 18px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .retry-btn {
        padding: 16px 30px;
        font-size: 18px;
        border-radius: 20px;
        width: auto;
        max-width: calc(100% - 40px);
        letter-spacing: 1px;
        border-width: 3px;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .defeated-boss {
        padding: 30px 20px;
        border-radius: 15px;
    }
    
    .defeated-boss h2 {
        font-size: 28px;
        margin-bottom: 12px;
    }
    
    .defeated-boss p {
        font-size: 16px;
        margin: 8px 0;
    }
    
    .no-boss-message {
        padding: 40px 15px;
        font-size: 18px;
    }
    
    .no-boss-message h2 {
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .inactive-message {
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .inactive-message p {
        font-size: 16px;
    }
    
    .inactive-message p:last-child {
        font-size: 13px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 3px;
    }
    
    .raid-boss-container {
        margin: 5px auto;
        padding: 12px;
        border-radius: 15px;
        border-width: 2px;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .modal-overlay {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
    }
    
    .modal-content {
        padding: 20px;
        width: calc(100% - 20px);
        max-width: 100%;
        border-radius: 15px;
        border-width: 2px;
        margin: 0;
        max-height: calc(100vh - 40px);
    }
    
    .modal-title {
        font-size: 20px;
        margin-bottom: 15px;
        padding-right: 40px;
    }
    
    .modal-close {
        width: 32px;
        height: 32px;
        font-size: 20px;
        top: 8px;
        right: 8px;
    }
    
    .form-group label {
        font-size: 16px;
    }
    
    .form-group input {
        font-size: 16px;
        padding: 12px;
    }
    
    .form-group small {
        font-size: 11px;
    }
    
    .submit-btn {
        font-size: 18px;
        padding: 14px 25px;
    }
    
    .boss-header {
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 12px;
    }
    
    .boss-header h1 {
        font-size: 24px;
        margin-bottom: 10px;
        letter-spacing: 0.5px;
    }
    
    .boss-health-bar {
        height: 30px;
        border-radius: 15px;
        border-width: 2px;
        margin-top: 12px;
    }
    
    .boss-health-fill {
        font-size: 14px;
    }
    
    .boss-animation-container {
        height: auto;
        margin: 12px 0;
    }
    
    .boss-animation {
        height: 240px;
    }
    
    .boss-rewards {
        margin-top: 12px;
        padding: 12px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .boss-rewards h3 {
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    .boss-rewards-content {
        font-size: 15px;
    }
    
    .class-damage-table {
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .class-damage-table h2 {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .class-damage-item {
        padding: 10px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .class-name {
        font-size: 15px;
        flex: 1;
    }
    
    .damage-value {
        font-size: 16px;
        flex-shrink: 0;
        text-align: right;
        white-space: nowrap;
    }
    
    .battle-button-container {
        margin: 20px 0;
    }
    
    .battle-btn {
        padding: 15px 20px;
        font-size: 18px;
        letter-spacing: 0.5px;
        border-width: 2px;
        border-radius: 20px;
    }
    
    .task-card {
        padding: 15px;
        border-radius: 12px;
        border-width: 2px;
        margin-top: 15px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .task-title {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .task-description {
        font-size: 15px;
        margin-bottom: 12px;
        line-height: 1.5;
    }
    
    .task-image {
        border-radius: 12px;
        border-width: 2px;
        margin: 12px auto;
    }
    
    .task-form {
        padding: 15px;
        border-radius: 12px;
        border-width: 2px;
        margin-top: 12px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-size: 15px;
        margin-bottom: 6px;
    }
    
    .form-group input,
    .form-group select {
        padding: 12px;
        font-size: 15px;
        border-radius: 10px;
        border-width: 2px;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
    }
    
    .submit-btn {
        padding: 14px 25px;
        font-size: 16px;
        border-radius: 10px;
        letter-spacing: 0.5px;
    }
    
    .message-box {
        padding: 15px;
        font-size: 16px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .retry-btn {
        padding: 14px 25px;
        font-size: 16px;
        border-radius: 18px;
        letter-spacing: 0.5px;
        border-width: 3px;
        width: auto;
        max-width: calc(100% - 30px);
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .defeated-boss {
        padding: 25px 15px;
        border-radius: 12px;
    }
    
    .defeated-boss h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .defeated-boss p {
        font-size: 15px;
        margin: 6px 0;
    }
    
    .no-boss-message {
        padding: 30px 12px;
        font-size: 16px;
    }
    
    .no-boss-message h2 {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .inactive-message {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .inactive-message p {
        font-size: 15px;
    }
    
    .inactive-message p:last-child {
        font-size: 12px;
    }
}

@media (max-width: 360px) {
    .boss-header h1 {
        font-size: 20px;
    }
    
    .boss-health-bar {
        height: 28px;
    }
    
    .boss-health-fill {
        font-size: 12px;
    }
    
    .boss-animation-container {
        height: auto;
        margin: 10px 0;
    }
    
    .boss-animation {
        height: 200px;
    }
    
    .class-damage-table h2 {
        font-size: 18px;
    }
    
    .class-name {
        font-size: 14px;
        flex: 1;
    }
    
    .damage-value {
        font-size: 15px;
        flex-shrink: 0;
        text-align: right;
        white-space: nowrap;
    }
    
    .battle-btn {
        padding: 12px 18px;
        font-size: 16px;
    }
    
    .task-title {
        font-size: 18px;
    }
    
    .task-description {
        font-size: 14px;
    }
    
    .form-group label {
        font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
        padding: 10px;
        font-size: 14px;
    }
    
    .submit-btn {
        padding: 12px 20px;
        font-size: 15px;
    }
    
    .message-box {
        font-size: 15px;
        padding: 12px;
    }
    
    .defeated-boss h2 {
        font-size: 20px;
    }
    
    .defeated-boss p {
        font-size: 14px;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    .modal-overlay {
        padding: 5px;
        padding-top: 15px;
    }
    
    .modal-content {
        padding: 15px;
        width: calc(100% - 10px);
        border-radius: 12px;
        max-height: calc(100vh - 30px);
    }
    
    .modal-title {
        font-size: 18px;
        margin-bottom: 12px;
        padding-right: 35px;
    }
    
    .modal-close {
        width: 28px;
        height: 28px;
        font-size: 18px;
        top: 5px;
        right: 5px;
    }
    
    .form-group label {
        font-size: 14px;
    }
    
    .form-group input {
        font-size: 14px;
        padding: 10px;
    }
    
    .form-group small {
        font-size: 10px;
    }
    
    .submit-btn {
        font-size: 16px;
        padding: 12px 20px;
    }
}

.user-progress {
    margin: 20px 0;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    border-radius: 15px;
    border: 3px solid #2e7d32;
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    text-align: center;
}

.user-progress-content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.progress-label {
    font-size: 18px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
}

    .progress-value {
        font-size: 20px;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
        padding: 5px 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .change-name-btn {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        border: 2px solid rgba(255, 255, 255, 0.35);
        padding: 6px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        white-space: nowrap;
    }

    .change-name-btn:hover {
        background: rgba(255, 255, 255, 0.28);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-1px);
    }

    .change-name-btn:active {
        transform: translateY(0);
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
        justify-content: center;
        align-items: center;
        z-index: 10000; /* –í—ã—Å–æ–∫–∏–π z-index —á—Ç–æ–±—ã –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        padding: 10px;
        box-sizing: border-box;
        overflow-y: auto;
    }
    
    .modal-overlay.show {
        display: flex !important;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 25px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        position: relative;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        border: 3px solid #c8a2c8;
        box-sizing: border-box;
        max-height: 90vh;
        overflow-y: auto;
        margin: auto;
    }
    
    .modal-content .form-group {
        margin-bottom: 20px;
    }
    
    .modal-content .form-group label {
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    .modal-content .form-group input {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    .modal-content .submit-btn {
        width: 100%;
        padding: 15px;
        font-size: 18px;
    }
    
    .modal-title {
        color: #8b6fa8;
        font-size: 28px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        text-shadow: 1px 1px 0px #e8d5c4;
        word-wrap: break-word;
    }
    
    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: linear-gradient(135deg, #d4a5a5 0%, #c89595 100%);
        border: none;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border-radius: 50%;
        font-weight: bold;
        box-shadow: 0 3px 8px rgba(212, 165, 165, 0.3);
        z-index: 10;
        box-sizing: border-box;
    }
    
    .modal-close:hover {
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 5px 12px rgba(212, 165, 165, 0.5);
    }
    
    .modal-close:active {
        transform: rotate(90deg) scale(0.95);
    }

@media (max-width: 768px) {
    .user-progress {
        margin: 15px 0;
        padding: 12px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .progress-label {
        font-size: 16px;
    }
    
    .progress-value {
        font-size: 18px;
        padding: 4px 12px;
        border-radius: 8px;
    }
}

@media (max-width: 480px) {
    .user-progress {
        margin: 12px 0;
        padding: 10px;
        border-radius: 10px;
    }
    
    .user-progress-content {
        flex-direction: column;
        gap: 8px;
    }
    
    .progress-label {
        font-size: 15px;
    }
    
    .progress-value {
        font-size: 16px;
        padding: 3px 10px;
    }

    .change-name-btn {
        width: 100%;
        max-width: 320px;
        padding: 10px 14px;
        font-size: 15px;
        border-radius: 12px;
        white-space: normal;
    }
}

@media (max-width: 360px) {
    .user-progress {
        margin: 10px 0;
        padding: 8px;
    }
    
    .progress-label {
        font-size: 14px;
    }
    
    .progress-value {
        font-size: 15px;
        padding: 2px 8px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="raid-boss-container">
    {% if not boss %}
    <div class="no-boss-message">
        <h2>–†–µ–π–¥ –±–æ—Å—Å–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</h2>
        <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –≤–∫–ª—é—á–∏–ª —Ä–µ–π–¥ –±–æ—Å—Å–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∑–∂–µ!</p>
    </div>
    {% else %}
    {% set total_health = boss.tasks|sum(attribute='points') %}
    {% set current_health = boss.get_current_health() %}
    {% set health_percent = (current_health / total_health * 100) if total_health > 0 else 0 %}
    <div class="boss-header">
        <h1>{{ boss.name }}</h1>
        <div class="boss-health-bar">
            <div class="boss-health-fill" id="healthFill" style="width: {{ health_percent|round(2) }}%;">
                <span id="healthText" data-current="{{ current_health }}" data-total="{{ total_health }}">{{ current_health }}/{{ total_health }}</span>
            </div>
        </div>
        <div class="boss-animation-container">
            {% set initial_boss_frame = (boss_animation_frames[0] if boss_animation_frames and boss_animation_frames|length > 0 else url_for('static', filename='animation/boss/1.png')) %}
            <img id="bossAnimation" class="boss-animation" src="{{ initial_boss_frame }}" alt="–ë–æ—Å—Å">
        </div>
        {% if boss.rewards_list %}
        <div class="boss-rewards">
            <h3>üéÅ –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –ø–æ–±–µ–¥—É:</h3>
            <div class="boss-rewards-content">{{ boss.rewards_list }}</div>
        </div>
        {% endif %}
    </div>
    
    {% if boss.is_active %}
    <div class="user-progress" id="userProgress" style="display: none;">
        <div class="user-progress-content">
            <span class="progress-label">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:</span>
            <span class="progress-value" id="progressValue">0/0</span>
            <span class="progress-label" id="userNameLabel" style="display: none;">–ò–º—è: <span id="userNameValue"></span></span>
            <button type="button" class="change-name-btn" id="changeNameBtn" onclick="showChangeNameModal()" style="display: none;">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</button>
        </div>
    </div>
    {% endif %}
    
    <div class="class-damage-table">
        <h2>–£—Ä–æ–Ω</h2>
        <div class="class-damage-list" id="classDamageList">
            {% for class_obj in classes %}
            <div class="class-damage-item">
                <span class="class-name">{{ class_obj.name }}</span>
                <span class="damage-value" data-class-id="{{ class_obj.id }}">{{ class_damage.get(class_obj.id, 0) }} —É—Ä–æ–Ω–∞</span>
            </div>
            {% endfor %}
            {% if not classes %}
            <p style="text-align: center; color: #999; padding: 20px;">–ù–µ—Ç –∫–ª–∞—Å—Å–æ–≤</p>
            {% endif %}
        </div>
    </div>
    
    <div class="battle-button-container" id="battleButtonContainer">
        {% if not boss.is_active %}
        <div class="inactive-message">
            <p>‚ö†Ô∏è –†–µ–π–¥ –±–æ—Å—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</p>
            <p style="font-size: 14px; margin-top: 5px; opacity: 0.9;">–°—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–π–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
        </div>
        {% endif %}
        <button class="battle-btn" id="battleBtn" {% if not boss.is_active %}disabled{% endif %}>
            {% if boss.is_active %}‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è{% else %}–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù{% endif %}
        </button>
    </div>
    
    <div id="taskCard" style="display: none;">
        <div class="task-card">
            <h2 class="task-title" id="taskTitle"></h2>
            <div class="task-description" id="taskDescription"></div>
            <img id="taskImage" class="task-image" style="display: none;" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            
            <form class="task-form" id="taskForm" onsubmit="submitAnswer(event)">
                <input type="hidden" id="taskId" value="">
                <div class="form-group">
                    <label for="className">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label>
                    <select id="className" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>
                        {% for class_obj in classes %}
                        <option value="{{ class_obj.id }}">{{ class_obj.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="answer">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                    <input type="text" id="answer" required placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç">
                </div>
                <button type="submit" class="submit-btn" id="submitBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            </form>
        </div>
    </div>
    
    <div id="messageBox"></div>
    
    <div id="defeatedBox" style="display: none;">
        <div class="defeated-boss">
            <h2>üéâ –ë–û–°–° –ü–û–ë–ï–ñ–î–ï–ù! üéâ</h2>
            <p>–í—Å–µ –∑–∞–¥–∞—á–∏ —Ä–µ—à–µ–Ω—ã!</p>
            <p>–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —Ä–µ–π–¥–µ!</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ -->
<div class="modal-overlay" id="nameModal" style="display: none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeNameModal()">&times;</button>
        <h2 class="modal-title">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</h2>
        <form id="nameForm" onsubmit="saveUserName(event)">
            <div class="form-group">
                <label for="userNameInput">–§–∞–º–∏–ª–∏—è –∏ –ò–º—è:</label>
                <input type="text" id="userNameInput" required placeholder="–í–≤–µ–¥–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è" autocomplete="off" maxlength="200">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px; word-wrap: break-word;">
                    –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞. –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ —Ç–æ—á–∫–∏.
                </small>
            </div>
            <button type="submit" class="submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –°–ø–∏—Å–æ–∫ –∫–∞–¥—Ä–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –±–æ—Å—Å–∞ –±–µ—Ä—ë–º —Å —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —Ä–µ–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–∞–º –≤ static/animation/boss/)
const BOSS_ANIMATION_FRAMES = {{ (boss_animation_frames or [])|tojson }};

let currentTask = null;
let bossId = {{ boss.id if boss else 'null' }};
let bossIsActive = {% if boss and boss.is_active %}true{% else %}false{% endif %};
let resumeBattleAfterNameSave = false;

function formatNumber(value) {
    const num = Number(value);
    if (!Number.isFinite(num)) return String(value);
    return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 0 }).format(num);
}

function setBossHealthText(currentHealth, totalHealth) {
    const el = document.getElementById('healthText');
    if (!el) return;
    el.dataset.current = String(currentHealth);
    el.dataset.total = String(totalHealth);
    el.textContent = `${formatNumber(currentHealth)}/${formatNumber(totalHealth)}`;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É–∫–∞–º–∏
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function setCookie(name, value, days = null) {
    // –ï—Å–ª–∏ days = null, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É–∫–∏ –±–µ–∑ —Å—Ä–æ–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫)
    let expires = '';
    if (days !== null) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = `expires=${date.toUTCString()};`;
    } else {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ (20 –ª–µ—Ç)
        const date = new Date();
        date.setTime(date.getTime() + (20 * 365 * 24 * 60 * 60 * 1000));
        expires = `expires=${date.toUTCString()};`;
    }
    document.cookie = `${name}=${value};${expires}path=/`;
}

function getBossProgress() {
    const correctAnswers = parseInt(getCookie('boss_correct_answers') || '0');
    const totalAnswers = parseInt(getCookie('boss_total_answers') || '0');
    return { correctAnswers, totalAnswers };
}

function updateBossProgress(isCorrect) {
    const progress = getBossProgress();
    const newTotal = progress.totalAnswers + 1;
    const newCorrect = isCorrect ? progress.correctAnswers + 1 : progress.correctAnswers;
    
    setCookie('boss_correct_answers', newCorrect.toString());
    setCookie('boss_total_answers', newTotal.toString());
    
    return { correctAnswers: newCorrect, totalAnswers: newTotal };
}

function displayProgress() {
    if (!bossIsActive) {
        const progressDiv = document.getElementById('userProgress');
        if (progressDiv) {
            progressDiv.style.display = 'none';
        }
        return;
    }
    
    const progress = getBossProgress();
    const progressDiv = document.getElementById('userProgress');
    const progressValue = document.getElementById('progressValue');
    const userNameLabel = document.getElementById('userNameLabel');
    const userNameValue = document.getElementById('userNameValue');
    const changeNameBtn = document.getElementById('changeNameBtn');
    
    if (progressDiv && progressValue) {
        const savedUserName = getCookie('boss_user_name');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ò–õ–ò —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è (–¥–∞–∂–µ –ø—Ä–∏ 0/0)
        if (progress.totalAnswers > 0 || (savedUserName && savedUserName.trim() !== '')) {
            progressValue.textContent = `${progress.correctAnswers}/${progress.totalAnswers}`;
            progressDiv.style.display = 'block';

            if (savedUserName && userNameLabel && userNameValue) {
                userNameValue.textContent = savedUserName;
                userNameLabel.style.display = 'inline';
            } else if (userNameLabel) {
                userNameLabel.style.display = 'none';
            }

            if (changeNameBtn) {
                changeNameBtn.style.display = (savedUserName && savedUserName.trim() !== '') ? 'inline-block' : 'none';
            }
        } else {
            progressDiv.style.display = 'none';
        }
    }
}

function startBattle() {
    if (!bossId || bossId === 'null' || bossId === null) {
        alert('–ë–æ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    if (!bossIsActive) {
        alert('–†–µ–π–¥ –±–æ—Å—Å–∞ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –°—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const savedUserId = getCookie('boss_user_id');
    const savedUserName = getCookie('boss_user_name');
    
    if (!savedUserId || !savedUserName) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        resumeBattleAfterNameSave = true;
        showNameModal();
        return;
    }
    
    // –ï—Å–ª–∏ –∏–º—è –µ—Å—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
    proceedWithBattle();
}

function showNameModal() {
    const nameModal = document.getElementById('nameModal');
    if (!nameModal) {
        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }

    const modalTitle = nameModal.querySelector('.modal-title');
    if (modalTitle) {
        modalTitle.textContent = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è';
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    nameModal.classList.add('show');
    nameModal.style.display = 'flex';
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–∏–¥–∏–º–æ
    setTimeout(() => {
        const userNameInput = document.getElementById('userNameInput');
        if (userNameInput) {
            userNameInput.value = '';
            userNameInput.focus();
        }
    }, 100);
}

function showChangeNameModal() {
    const nameModal = document.getElementById('nameModal');
    if (!nameModal) {
        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }

    resumeBattleAfterNameSave = false;

    const modalTitle = nameModal.querySelector('.modal-title');
    if (modalTitle) {
        modalTitle.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è';
    }

    nameModal.classList.add('show');
    nameModal.style.display = 'flex';

    setTimeout(() => {
        const userNameInput = document.getElementById('userNameInput');
        if (userNameInput) {
            userNameInput.value = (getCookie('boss_user_name') || '').trim();
            userNameInput.focus();
            userNameInput.select();
        }
    }, 100);
}

function closeNameModal() {
    const nameModal = document.getElementById('nameModal');
    if (nameModal) {
        nameModal.classList.remove('show');
        nameModal.style.display = 'none';
    }
}

function validateUserName(name) {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π)
    if (!name || !name.trim()) {
        return { valid: false, error: '–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' };
    }
    
    name = name.trim();
    
    if (name.length < 2) {
        return { valid: false, error: '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞' };
    }
    
    if (name.length > 200) {
        return { valid: false, error: '–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤' };
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    const dangerousPatterns = /[<>'"\/\\]|javascript:|onerror=|onclick=/i;
    if (dangerousPatterns.test(name)) {
        return { valid: false, error: '–ò–º—è —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã' };
    }
    
    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ —Ç–æ—á–∫–∏
    const validPattern = /^[–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9\s\-\.]+$/;
    if (!validPattern.test(name)) {
        return { valid: false, error: '–ò–º—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ —Ç–æ—á–∫–∏' };
    }
    
    return { valid: true, error: null };
}

function saveUserName(event) {
    event.preventDefault();
    const nameInput = document.getElementById('userNameInput');
    const name = nameInput.value.trim();
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    const validation = validateUserName(name);
    if (!validation.valid) {
        alert(validation.error);
        nameInput.focus();
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const currentUserId = getCookie('boss_user_id');
    fetch('/api/raid-boss/save-user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            user_id: currentUserId ? parseInt(currentUserId) : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—É–∫–∏ —Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏
            setCookie('boss_user_id', data.user_id.toString(), null);
            setCookie('boss_user_name', data.user_name, null);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeNameModal();

            // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            displayProgress();

            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ –∫–Ω–æ–ø–∫–æ–π "–°—Ä–∞–∂–∞—Ç—å—Å—è"
            if (resumeBattleAfterNameSave) {
                resumeBattleAfterNameSave = false;
                proceedWithBattle();
            } else {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è" –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const battleBtn = document.getElementById('battleBtn');
                if (battleBtn) {
                    battleBtn.disabled = !bossIsActive;
                    battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
                }
            }
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    });
}

function proceedWithBattle() {
    const battleBtn = document.getElementById('battleBtn');
    if (!battleBtn) {
        return;
    }
    
    battleBtn.disabled = true;
    battleBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    
    const taskCard = document.getElementById('taskCard');
    const messageBox = document.getElementById('messageBox');
    if (taskCard) taskCard.style.display = 'none';
    if (messageBox) messageBox.innerHTML = '';
    
    fetch('/api/raid-boss/task')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.boss_defeated) {
                    showDefeatedMessage();
                } else {
                    showTask(data.task);
                }
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                if (battleBtn) {
                    battleBtn.disabled = !bossIsActive;
                    battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
                }
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            if (battleBtn) {
                battleBtn.disabled = !bossIsActive;
                battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
            }
        });
}

function showTask(task) {
    currentTask = task;
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskTitle').textContent = task.title;
    document.getElementById('taskDescription').textContent = task.description || '';
    
    if (task.image_filename) {
        document.getElementById('taskImage').src = `/uploads/tasks/${task.image_filename}`;
        document.getElementById('taskImage').style.display = 'block';
    } else {
        document.getElementById('taskImage').style.display = 'none';
    }
    
    document.getElementById('taskForm').reset();
    document.getElementById('taskCard').style.display = 'block';
    document.getElementById('messageBox').innerHTML = '';
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è" –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞
    const battleButtonContainer = document.getElementById('battleButtonContainer');
    if (battleButtonContainer) {
        battleButtonContainer.style.display = 'none';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞
    document.getElementById('taskForm').style.display = 'block';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø–æ—Å–ª–µ reset —Ñ–æ—Ä–º–∞ –ø—É—Å—Ç–∞—è)
    setTimeout(validateForm, 0);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∑–∞–¥–∞—á–µ
    document.getElementById('taskCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function validateForm() {
    const className = document.getElementById('className');
    const answer = document.getElementById('answer');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!className || !answer || !submitBtn) {
        return;
    }
    
    const classId = className.value;
    const answerValue = answer.value.trim();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å
    if (classId && answerValue) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
}

function submitAnswer(event) {
    event.preventDefault();
    
    const taskId = document.getElementById('taskId').value;
    const classId = document.getElementById('className').value;
    const classNameSelect = document.getElementById('className');
    const classNameText = classNameSelect.options[classNameSelect.selectedIndex].text;
    const answer = document.getElementById('answer').value.trim();
    
    if (!taskId || !classId || !answer) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const savedUserId = getCookie('boss_user_id');
    const savedUserName = getCookie('boss_user_name');
    
    const submitBtn = event.target.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    fetch('/api/raid-boss/submit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            task_id: parseInt(taskId),
            class_id: parseInt(classId),
            user_name: savedUserName || classNameText,
            user_id: savedUserId ? parseInt(savedUserId) : null,
            answer: answer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message;
            
            // –ï—Å–ª–∏ –≤—ã–ø–∞–ª –¥—Ä–æ–ø, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–º
            if (data.drop_reward && data.drop_reward.drop_name) {
                message += `\nüéÅ –í–∞–º –≤—ã–ø–∞–ª –¥—Ä–æ–ø: ${data.drop_reward.drop_name}!`;
            }
            
            showMessage(data.correct ? 'success' : 'error', message);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫—É–∫–∏
            if (data.update_progress) {
                const progress = updateBossProgress(data.is_correct);
                displayProgress();
            }
            
            if (data.correct) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è
            setTimeout(() => {
                showRetryButton();
            }, 2000);
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
            validateForm(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
        submitBtn.disabled = false;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
        validateForm(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
    });
}

function showMessage(type, message) {
    const messageBox = document.getElementById('messageBox');
    const messageClass = type === 'success' ? 'message-success' : (type === 'error' ? 'message-error' : 'message-info');
    
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br> –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const formattedMessage = message.replace(/\n/g, '<br>');
    
    messageBox.innerHTML = `
        <div class="message-box ${messageClass}">
            ${formattedMessage}
        </div>
    `;
    
    if (type === 'error') {
        // –ü—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞—á–∏
        document.getElementById('taskCard').style.display = 'none';
    } else {
        // –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É
        document.getElementById('taskForm').style.display = 'none';
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
    messageBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showRetryButton() {
    const messageBox = document.getElementById('messageBox');
    const retryContainer = document.createElement('div');
    retryContainer.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px; box-sizing: border-box; overflow: hidden;';
    retryContainer.innerHTML = `
        <button class="retry-btn" onclick="resetBattle()">
            üîÑ –ü–†–ò–ù–Ø–¢–¨ –£–ß–ê–°–¢–ò–ï –ï–©–ï –†–ê–ó üîÑ
        </button>
    `;
    messageBox.appendChild(retryContainer);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–Ω–æ–ø–∫–µ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    setTimeout(() => {
        retryContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function resetBattle() {
    document.getElementById('taskCard').style.display = 'none';
    document.getElementById('messageBox').innerHTML = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è" —Å–Ω–æ–≤–∞
    const battleButtonContainer = document.getElementById('battleButtonContainer');
    if (battleButtonContainer) {
        battleButtonContainer.style.display = 'block';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è"
    const battleBtn = document.getElementById('battleBtn');
    if (battleBtn) {
        battleBtn.disabled = !bossIsActive;
        battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
    const taskForm = document.getElementById('taskForm');
    if (taskForm) {
        taskForm.style.display = 'block';
    }
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
    }
    currentTask = null;
}

function showDefeatedMessage() {
    document.getElementById('defeatedBox').style.display = 'block';
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π "–°—Ä–∞–∂–∞—Ç—å—Å—è"
    const battleButtonContainer = document.getElementById('battleButtonContainer');
    if (battleButtonContainer) {
        battleButtonContainer.style.display = 'none';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞
    const taskCard = document.getElementById('taskCard');
    if (taskCard) {
        taskCard.style.display = 'none';
    }
}

function updateStats() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Å—Å–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Å—Å–∞)
    if (!bossId) {
        return;
    }
    
    fetch(`/api/raid-boss/stats?boss_id=${bossId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
                const currentHealth = data.boss.current_health;
                const totalHealth = data.boss.total_health;
                const healthPercent = totalHealth > 0 ? (currentHealth / totalHealth) * 100 : 0;
                
                document.getElementById('healthFill').style.width = healthPercent + '%';
                setBossHealthText(currentHealth, totalHealth);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–Ω –ø–æ –∫–ª–∞—Å—Å–∞–º
                const classDamageList = document.getElementById('classDamageList');
                Object.keys(data.class_damage).forEach(classId => {
                    const damageElement = document.querySelector(`[data-class-id="${classId}"]`);
                    if (damageElement) {
                        damageElement.textContent = data.class_damage[classId].damage + ' —É—Ä–æ–Ω–∞';
                    }
                });
                
                // –ï—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ = 0, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ
                if (currentHealth <= 0) {
                    showDefeatedMessage();
                }
            }
        })
        .catch(error => {
            // –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞
        });
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Å—Å–∞)
if (bossId) {
    setInterval(updateStats, 20000);
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateStats();
}

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞–¥—Ä–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –±–æ—Å—Å–∞ –ø–æ —Å–ø–∏—Å–∫—É URL
function preloadBossAnimationFrames(frameUrls, callback) {
    if (!Array.isArray(frameUrls) || frameUrls.length === 0) {
        if (callback) callback();
        return;
    }

    let done = 0;
    const total = frameUrls.length;
    const onDone = () => {
        done += 1;
        if (done >= total && callback) callback();
    };

    frameUrls.forEach((src) => {
        const img = new Image();
        img.onload = onDone;
        img.onerror = onDone;
        img.src = src;
    });
}

// –ê–Ω–∏–º–∞—Ü–∏—è –±–æ—Å—Å–∞
let bossAnimationIntervalId = null;
function startBossAnimation(frameUrls) {
    const bossAnimation = document.getElementById('bossAnimation');
    if (!bossAnimation) return;

    if (!Array.isArray(frameUrls) || frameUrls.length === 0) return;

    // –ù–µ —Å–æ–∑–¥–∞—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–π–º–µ—Ä–æ–≤, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ
    if (bossAnimationIntervalId) {
        clearInterval(bossAnimationIntervalId);
        bossAnimationIntervalId = null;
    }

    let idx = 0;
    bossAnimation.src = frameUrls[0];

    // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–¥—Ä–æ–≤:
    // –¥–µ—Ä–∂–∏–º –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, –∫–∞–∫ —Ä–∞–Ω—å—à–µ (6 * 100ms = 600ms).
    const TARGET_LOOP_MS = 600;
    const MIN_FRAME_INTERVAL_MS = 30;  // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ/–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ
    const MAX_FRAME_INTERVAL_MS = 350; // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –º–∞–ª–æ–º —á–∏—Å–ª–µ –∫–∞–¥—Ä–æ–≤
    const rawInterval = Math.round(TARGET_LOOP_MS / frameUrls.length);
    const frameInterval = Math.max(MIN_FRAME_INTERVAL_MS, Math.min(MAX_FRAME_INTERVAL_MS, rawInterval));
    bossAnimationIntervalId = setInterval(function() {
        idx = (idx + 1) % frameUrls.length;
        bossAnimation.src = frameUrls[idx];
    }, frameInterval);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ (—Å–µ—Ä–≤–µ—Ä –º–æ–≥ –æ—Ç–¥–∞—Ç—å –±–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π —Ç—ã—Å—è—á)
    const initialHealthText = document.getElementById('healthText');
    if (initialHealthText && initialHealthText.dataset) {
        const current = initialHealthText.dataset.current;
        const total = initialHealthText.dataset.total;
        if (current !== undefined && total !== undefined) {
            setBossHealthText(current, total);
        }
    }

    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–¥—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –±–æ—Å—Å–∞, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    preloadBossAnimationFrames(BOSS_ANIMATION_FRAMES, function() {
        startBossAnimation(BOSS_ANIMATION_FRAMES);
    });
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    displayProgress();
    
    const className = document.getElementById('className');
    const answer = document.getElementById('answer');
    
    if (className) {
        className.addEventListener('change', validateForm);
    }
    if (answer) {
        answer.addEventListener('input', validateForm);
        answer.addEventListener('keyup', validateForm);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —Å—Ä–∞–∂–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
    const battleBtn = document.getElementById('battleBtn');
    if (battleBtn) {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–≤—è–∑–∞–Ω
        battleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            startBattle();
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    const nameModal = document.getElementById('nameModal');
    if (nameModal) {
        nameModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeNameModal();
            }
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (nameModal && (nameModal.classList.contains('show') || nameModal.style.display === 'flex')) {
                closeNameModal();
            }
        }
    });
});
</script>
{% endblock %}
