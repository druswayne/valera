{% extends "base.html" %}

{% block title %}–†–µ–π–¥ –±–æ—Å—Å–∞ - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<style>
* {
    box-sizing: border-box;
}

body {
    font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', Arial, sans-serif;
    background: linear-gradient(135deg, #8b0000 0%, #ff4500 100%);
    min-height: 100vh;
    padding: 10px;
}

.raid-boss-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 25px;
    background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
    border-radius: 25px;
    border: 4px solid #dc143c;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
}

.boss-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
    border-radius: 20px;
    color: white;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.boss-header h1 {
    font-size: 48px;
    margin-bottom: 15px;
    text-shadow: 3px 3px 0px #000;
    font-weight: bold;
    letter-spacing: 2px;
}

.boss-animation-container {
    margin: 20px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: auto;
    overflow: visible;
}

.boss-animation {
    width: auto;
    height: 400px;
    object-fit: contain;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
}

.boss-health-bar {
    margin-top: 20px;
    background: #333;
    border-radius: 25px;
    height: 40px;
    overflow: hidden;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
    border: 3px solid #000;
}

.boss-health-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff0000 0%, #ff4500 50%, #ff6b6b 100%);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 18px;
    color: white;
    text-shadow: 2px 2px 0px #000;
}

.boss-rewards {
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    border-radius: 15px;
    border: 3px solid #ff8c00;
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
}

.boss-rewards h3 {
    font-size: 24px;
    margin: 0 0 15px 0;
    color: #8b0000;
    text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.5);
    text-align: center;
    font-weight: bold;
}

.boss-rewards-content {
    font-size: 18px;
    color: #333;
    line-height: 1.6;
    white-space: pre-wrap;
    text-align: center;
}

.class-damage-table {
    margin-bottom: 30px;
    background: #fff;
    padding: 20px;
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 3px solid #d4c5b0;
}

.class-damage-table h2 {
    color: #8b6fa8;
    font-size: 28px;
    margin-bottom: 20px;
    text-align: center;
    text-shadow: 1px 1px 0px #e8d5c4;
}

.class-damage-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.class-damage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    border: 2px solid #d4c5b0;
    transition: all 0.3s ease;
}

.class-damage-item:hover {
    border-color: #8b6fa8;
    box-shadow: 0 3px 10px rgba(139, 111, 168, 0.2);
}

.class-name {
    font-size: 18px;
    font-weight: bold;
    color: #8b6fa8;
}

.damage-value {
    font-size: 20px;
    font-weight: bold;
    color: #dc143c;
}

.battle-button-container {
    text-align: center;
    margin: 40px 0;
}

.battle-btn {
    background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
    color: white;
    border: none;
    padding: 25px 50px;
    border-radius: 25px;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(220, 20, 60, 0.4);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 0px #000;
    border: 4px solid #000;
}

.battle-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 35px rgba(220, 20, 60, 0.6);
}

.battle-btn:active {
    transform: translateY(-2px) scale(1.02);
}

.battle-btn:disabled {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    opacity: 0.7;
}

.inactive-message {
    text-align: center;
    padding: 15px;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    border-radius: 15px;
    border: 3px solid #e65100;
    box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
}

.inactive-message p {
    margin: 0;
    font-weight: bold;
    font-size: 18px;
    text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
}

.task-card {
    background: #fff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 3px solid #d4c5b0;
    margin-top: 30px;
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
    max-width: 100%;
}

.task-title {
    color: #7a8fb8;
    font-size: 32px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
}

.task-description {
    color: #333;
    font-size: 18px;
    line-height: 1.8;
    margin-bottom: 20px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.task-image {
    max-width: 100%;
    height: auto;
    border-radius: 20px;
    margin: 20px auto;
    display: block;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    border: 3px solid #d4c5b0;
}

.task-form {
    background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c4 100%);
    padding: 30px;
    border-radius: 20px;
    margin-top: 20px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 3px solid #c8a2c8;
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
    max-width: 100%;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    color: #333;
    margin-bottom: 10px;
    font-size: 20px;
    font-weight: bold;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 18px;
    border-radius: 15px;
    border: 3px solid #a8b8d0;
    background-color: #fff;
    color: #333;
    font-size: 18px;
    font-family: 'Comic Sans MS', Arial, sans-serif;
    transition: all 0.3s ease;
    box-sizing: border-box;
    max-width: 100%;
    word-wrap: break-word;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #8b6fa8;
    box-shadow: 0 0 15px rgba(139, 111, 168, 0.3);
    transform: scale(1.02);
}

.submit-btn {
    background: linear-gradient(135deg, #8b9dc8 0%, #9b8fb8 100%);
    color: #fff;
    border: none;
    padding: 18px 40px;
    border-radius: 15px;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    box-shadow: 0 5px 15px rgba(139, 157, 200, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(139, 157, 200, 0.4);
}

.submit-btn:disabled {
    background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    cursor: not-allowed;
    opacity: 0.6;
    transform: none;
    box-shadow: none;
}

.message-box {
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    box-sizing: border-box;
    overflow: hidden;
    word-wrap: break-word;
}

.message-success {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border: 3px solid #2e7d32;
}

.message-error {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    color: white;
    border: 3px solid #c62828;
}

.message-info {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: white;
    border: 3px solid #1565C0;
}

.retry-btn {
    background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
    color: #fff;
    border: none;
    padding: 20px 50px;
    border-radius: 25px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 20px;
    box-shadow: 0 8px 25px rgba(220, 20, 60, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 2px 2px 0px #000;
    border: 4px solid #000;
    display: inline-block;
    animation: pulse 2s infinite;
    white-space: nowrap;
    max-width: 100%;
    box-sizing: border-box;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.retry-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 35px rgba(220, 20, 60, 0.7);
    background: linear-gradient(135deg, #ff1744 0%, #b71c1c 100%);
}

.retry-btn:active {
    transform: translateY(-2px) scale(1.02);
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 8px 25px rgba(220, 20, 60, 0.5);
    }
    50% {
        box-shadow: 0 8px 35px rgba(220, 20, 60, 0.8);
    }
}

.no-boss-message {
    text-align: center;
    padding: 60px 20px;
    color: #666;
    font-size: 24px;
}

.defeated-boss {
    text-align: center;
    padding: 40px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border-radius: 20px;
    margin-top: 30px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.defeated-boss h2 {
    font-size: 36px;
    margin-bottom: 15px;
    text-shadow: 2px 2px 0px #2e7d32;
}

.defeated-boss p {
    font-size: 20px;
    margin: 10px 0;
}

@media (max-width: 768px) {
    body {
        padding: 5px;
    }
    
    .raid-boss-container {
        margin: 10px auto;
        padding: 15px;
        border-radius: 20px;
        border-width: 3px;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
    .modal-overlay {
        padding: 15px;
    }
    
    .modal-content {
        padding: 25px;
        width: 95%;
        max-width: 450px;
        border-radius: 20px;
        border-width: 2px;
    }
    
    .modal-title {
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .modal-close {
        width: 35px;
        height: 35px;
        font-size: 24px;
        top: 10px;
        right: 10px;
    }
    
    .boss-header {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 15px;
    }
    
    .boss-header h1 {
        font-size: 28px;
        margin-bottom: 12px;
        letter-spacing: 1px;
    }
    
    .boss-health-bar {
        height: 35px;
        border-radius: 20px;
        border-width: 2px;
        margin-top: 15px;
    }
    
    .boss-health-fill {
        font-size: 16px;
    }
    
    .boss-animation-container {
        height: auto;
        margin: 15px 0;
    }
    
    .boss-animation {
        height: 300px;
    }
    
    .boss-rewards {
        margin-top: 15px;
        padding: 15px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .boss-rewards h3 {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .boss-rewards-content {
        font-size: 16px;
    }
    
    .class-damage-table {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 15px;
        border-width: 2px;
    }
    
    .class-damage-table h2 {
        font-size: 22px;
        margin-bottom: 15px;
    }
    
    .class-damage-item {
        padding: 12px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        box-sizing: border-box;
    }
    
    .class-name {
        font-size: 16px;
        flex: 1;
        word-wrap: break-word;
    }
    
    .damage-value {
        font-size: 18px;
        flex-shrink: 0;
        text-align: right;
        word-wrap: break-word;
        white-space: nowrap;
    }
    
    .battle-button-container {
        margin: 30px 0;
    }
    
    .battle-btn {
        padding: 18px 30px;
        font-size: 22px;
        letter-spacing: 1px;
        border-width: 3px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        word-wrap: break-word;
    }
    
    .task-card {
        padding: 20px;
        border-radius: 15px;
        border-width: 2px;
        margin-top: 20px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .task-title {
        font-size: 22px;
        margin-bottom: 15px;
    }
    
    .task-description {
        font-size: 16px;
        margin-bottom: 15px;
        line-height: 1.6;
    }
    
    .task-image {
        max-width: 100%;
        border-radius: 15px;
        border-width: 2px;
        margin: 15px auto;
    }
    
    .task-form {
        padding: 20px;
        border-radius: 15px;
        border-width: 2px;
        margin-top: 15px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .form-group input,
    .form-group select {
        padding: 14px;
        font-size: 16px;
        border-radius: 12px;
        border-width: 2px;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
    }
    
    .submit-btn {
        padding: 16px 30px;
        font-size: 18px;
        border-radius: 12px;
    }
    
    .message-box {
        padding: 18px;
        font-size: 18px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .retry-btn {
        padding: 16px 30px;
        font-size: 18px;
        border-radius: 20px;
        width: auto;
        max-width: calc(100% - 40px);
        letter-spacing: 1px;
        border-width: 3px;
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .defeated-boss {
        padding: 30px 20px;
        border-radius: 15px;
    }
    
    .defeated-boss h2 {
        font-size: 28px;
        margin-bottom: 12px;
    }
    
    .defeated-boss p {
        font-size: 16px;
        margin: 8px 0;
    }
    
    .no-boss-message {
        padding: 40px 15px;
        font-size: 18px;
    }
    
    .no-boss-message h2 {
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .inactive-message {
        padding: 12px;
        margin-bottom: 12px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .inactive-message p {
        font-size: 16px;
    }
    
    .inactive-message p:last-child {
        font-size: 13px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 3px;
    }
    
    .raid-boss-container {
        margin: 5px auto;
        padding: 12px;
        border-radius: 15px;
        border-width: 2px;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .modal-overlay {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
    }
    
    .modal-content {
        padding: 20px;
        width: calc(100% - 20px);
        max-width: 100%;
        border-radius: 15px;
        border-width: 2px;
        margin: 0;
        max-height: calc(100vh - 40px);
    }
    
    .modal-title {
        font-size: 20px;
        margin-bottom: 15px;
        padding-right: 40px;
    }
    
    .modal-close {
        width: 32px;
        height: 32px;
        font-size: 20px;
        top: 8px;
        right: 8px;
    }
    
    .form-group label {
        font-size: 16px;
    }
    
    .form-group input {
        font-size: 16px;
        padding: 12px;
    }
    
    .form-group small {
        font-size: 11px;
    }
    
    .submit-btn {
        font-size: 18px;
        padding: 14px 25px;
    }
    
    .boss-header {
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 12px;
    }
    
    .boss-header h1 {
        font-size: 24px;
        margin-bottom: 10px;
        letter-spacing: 0.5px;
    }
    
    .boss-health-bar {
        height: 30px;
        border-radius: 15px;
        border-width: 2px;
        margin-top: 12px;
    }
    
    .boss-health-fill {
        font-size: 14px;
    }
    
    .boss-animation-container {
        height: auto;
        margin: 12px 0;
    }
    
    .boss-animation {
        height: 240px;
    }
    
    .boss-rewards {
        margin-top: 12px;
        padding: 12px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .boss-rewards h3 {
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    .boss-rewards-content {
        font-size: 15px;
    }
    
    .class-damage-table {
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .class-damage-table h2 {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .class-damage-item {
        padding: 10px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .class-name {
        font-size: 15px;
        flex: 1;
    }
    
    .damage-value {
        font-size: 16px;
        flex-shrink: 0;
        text-align: right;
        white-space: nowrap;
    }
    
    .battle-button-container {
        margin: 20px 0;
    }
    
    .battle-btn {
        padding: 15px 20px;
        font-size: 18px;
        letter-spacing: 0.5px;
        border-width: 2px;
        border-radius: 20px;
    }
    
    .task-card {
        padding: 15px;
        border-radius: 12px;
        border-width: 2px;
        margin-top: 15px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .task-title {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .task-description {
        font-size: 15px;
        margin-bottom: 12px;
        line-height: 1.5;
    }
    
    .task-image {
        border-radius: 12px;
        border-width: 2px;
        margin: 12px auto;
    }
    
    .task-form {
        padding: 15px;
        border-radius: 12px;
        border-width: 2px;
        margin-top: 12px;
        box-sizing: border-box;
        overflow: hidden;
        max-width: 100%;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        font-size: 15px;
        margin-bottom: 6px;
    }
    
    .form-group input,
    .form-group select {
        padding: 12px;
        font-size: 15px;
        border-radius: 10px;
        border-width: 2px;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
    }
    
    .submit-btn {
        padding: 14px 25px;
        font-size: 16px;
        border-radius: 10px;
        letter-spacing: 0.5px;
    }
    
    .message-box {
        padding: 15px;
        font-size: 16px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .retry-btn {
        padding: 14px 25px;
        font-size: 16px;
        border-radius: 18px;
        letter-spacing: 0.5px;
        border-width: 3px;
        width: auto;
        max-width: calc(100% - 30px);
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .defeated-boss {
        padding: 25px 15px;
        border-radius: 12px;
    }
    
    .defeated-boss h2 {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .defeated-boss p {
        font-size: 15px;
        margin: 6px 0;
    }
    
    .no-boss-message {
        padding: 30px 12px;
        font-size: 16px;
    }
    
    .no-boss-message h2 {
        font-size: 20px;
        margin-bottom: 12px;
    }
    
    .inactive-message {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        border-width: 2px;
    }
    
    .inactive-message p {
        font-size: 15px;
    }
    
    .inactive-message p:last-child {
        font-size: 12px;
    }
}

@media (max-width: 360px) {
    .boss-header h1 {
        font-size: 20px;
    }
    
    .boss-health-bar {
        height: 28px;
    }
    
    .boss-health-fill {
        font-size: 12px;
    }
    
    .boss-animation-container {
        height: auto;
        margin: 10px 0;
    }
    
    .boss-animation {
        height: 200px;
    }
    
    .class-damage-table h2 {
        font-size: 18px;
    }
    
    .class-name {
        font-size: 14px;
        flex: 1;
    }
    
    .damage-value {
        font-size: 15px;
        flex-shrink: 0;
        text-align: right;
        white-space: nowrap;
    }
    
    .battle-btn {
        padding: 12px 18px;
        font-size: 16px;
    }
    
    .task-title {
        font-size: 18px;
    }
    
    .task-description {
        font-size: 14px;
    }
    
    .form-group label {
        font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
        padding: 10px;
        font-size: 14px;
    }
    
    .submit-btn {
        padding: 12px 20px;
        font-size: 15px;
    }
    
    .message-box {
        font-size: 15px;
        padding: 12px;
    }
    
    .defeated-boss h2 {
        font-size: 20px;
    }
    
    .defeated-boss p {
        font-size: 14px;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    .modal-overlay {
        padding: 5px;
        padding-top: 15px;
    }
    
    .modal-content {
        padding: 15px;
        width: calc(100% - 10px);
        border-radius: 12px;
        max-height: calc(100vh - 30px);
    }
    
    .modal-title {
        font-size: 18px;
        margin-bottom: 12px;
        padding-right: 35px;
    }
    
    .modal-close {
        width: 28px;
        height: 28px;
        font-size: 18px;
        top: 5px;
        right: 5px;
    }
    
    .form-group label {
        font-size: 14px;
    }
    
    .form-group input {
        font-size: 14px;
        padding: 10px;
    }
    
    .form-group small {
        font-size: 10px;
    }
    
    .submit-btn {
        font-size: 16px;
        padding: 12px 20px;
    }
}

.user-progress {
    margin: 20px 0;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    border-radius: 15px;
    border: 3px solid #2e7d32;
    box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    text-align: center;
}

.user-progress-content {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.progress-label {
    font-size: 18px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
}

    .progress-value {
        font-size: 20px;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
        padding: 5px 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .change-name-btn {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        border: 2px solid rgba(255, 255, 255, 0.35);
        padding: 6px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        white-space: nowrap;
    }

    .change-name-btn:hover {
        background: rgba(255, 255, 255, 0.28);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-1px);
    }

    .change-name-btn:active {
        transform: translateY(0);
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
        justify-content: center;
        align-items: center;
        z-index: 10000; /* –í—ã—Å–æ–∫–∏–π z-index —á—Ç–æ–±—ã –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        padding: 10px;
        box-sizing: border-box;
        overflow-y: auto;
    }
    
    .modal-overlay.show {
        display: flex !important;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 25px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        position: relative;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        border: 3px solid #c8a2c8;
        box-sizing: border-box;
        max-height: 90vh;
        overflow-y: auto;
        margin: auto;
    }
    
    .modal-content .form-group {
        margin-bottom: 20px;
    }
    
    .modal-content .form-group label {
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    .modal-content .form-group input {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    .modal-content .submit-btn {
        width: 100%;
        padding: 15px;
        font-size: 18px;
    }
    
    .modal-title {
        color: #8b6fa8;
        font-size: 28px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        text-shadow: 1px 1px 0px #e8d5c4;
        word-wrap: break-word;
    }
    
    .modal-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: linear-gradient(135deg, #d4a5a5 0%, #c89595 100%);
        border: none;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border-radius: 50%;
        font-weight: bold;
        box-shadow: 0 3px 8px rgba(212, 165, 165, 0.3);
        z-index: 10;
        box-sizing: border-box;
    }
    
    .modal-close:hover {
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 5px 12px rgba(212, 165, 165, 0.5);
    }
    
    .modal-close:active {
        transform: rotate(90deg) scale(0.95);
    }

@media (max-width: 768px) {
    .user-progress {
        margin: 15px 0;
        padding: 12px;
        border-radius: 12px;
        border-width: 2px;
    }
    
    .progress-label {
        font-size: 16px;
    }
    
    .progress-value {
        font-size: 18px;
        padding: 4px 12px;
        border-radius: 8px;
    }
}

@media (max-width: 480px) {
    .user-progress {
        margin: 12px 0;
        padding: 10px;
        border-radius: 10px;
    }
    
    .user-progress-content {
        flex-direction: column;
        gap: 8px;
    }
    
    .progress-label {
        font-size: 15px;
    }
    
    .progress-value {
        font-size: 16px;
        padding: 3px 10px;
    }

    .change-name-btn {
        width: 100%;
        max-width: 320px;
        padding: 10px 14px;
        font-size: 15px;
        border-radius: 12px;
        white-space: normal;
    }
}

@media (max-width: 360px) {
    .user-progress {
        margin: 10px 0;
        padding: 8px;
    }
    
    .progress-label {
        font-size: 14px;
    }
    
    .progress-value {
        font-size: 15px;
        padding: 2px 8px;
    }
}

/* ==================== –î–†–û–ü: –°–£–ù–î–£–ö ==================== */
.drop-modal-content {
    max-width: 520px;
}

.drop-chest-stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 18px;
    padding: 10px 0 0 0;
}

.drop-chest-wrap {
    position: relative;
    width: 260px;
    max-width: 70vw;
    display: grid;
    place-items: center;
    padding: 10px;
}

.drop-chest-wrap::before {
    content: none;
}

.drop-fireworks {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2; /* –Ω–∞–¥ —Å—É–Ω–¥—É–∫–æ–º, –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
}

.drop-chest-wrap.drop-theme-medium img.drop-chest-fallback {
    /* —Å—Ä–µ–¥–Ω–∏–π —à–∞–Ω—Å: –∞–º–µ—Ç–∏—Å—Ç–æ–≤—ã–π */
    filter: hue-rotate(250deg) saturate(1.55) brightness(1.06) contrast(1.08);
}

.drop-chest-wrap.drop-theme-very-low img.drop-chest-fallback {
    /* –Ω–∏–∑–∫–∏–π —à–∞–Ω—Å: –∞–ª–º–∞–∑–Ω—ã–π (—Ü–∏–∞–Ω/–ª–µ–¥—è–Ω–æ–π) */
    filter: hue-rotate(195deg) saturate(2.25) brightness(1.18) contrast(1.12);
}

.drop-chest {
    width: 100%;
    height: auto;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    transform-origin: 50% 80%;
    user-select: none;
    -webkit-user-drag: none;
}

.drop-chest.opening {
    animation: dropChestPop 2000ms ease-in-out;
}

.drop-chest.opened {
    transform: translateY(-4px) scale(1.03);
    filter: drop-shadow(0 10px 25px rgba(255, 215, 0, 0.35)) brightness(1.08);
}

.drop-chest.opened + .drop-result {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* —É–±—Ä–∞–ª–∏ —Å–≤–µ—á–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ —Å—É–Ω–¥—É–∫–∞ */

.drop-result {
    position: relative;
    z-index: 3; /* –ø–æ–≤–µ—Ä—Ö —Å–∞–ª—é—Ç–∞ */
    font-size: 20px;
    font-weight: bold;
    color: #333;
    text-align: center;
    opacity: 0;
    transform: translateY(8px) scale(0.98);
    transition: opacity 300ms ease, transform 300ms ease;
    line-height: 1.4;
    padding: 10px 12px;
    border-radius: 14px;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 237, 78, 0.25) 100%);
    border: 2px solid rgba(255, 140, 0, 0.45);
    box-shadow: 0 8px 22px rgba(255, 215, 0, 0.12);
}

.drop-subhint {
    margin-top: 10px;
    text-align: center;
    color: #666;
    font-size: 14px;
}

/* 3D-—Ä–µ–Ω–¥–µ—Ä —Å—É–Ω–¥—É–∫–∞ (three.js) */
.drop-chest-3d {
    width: 100%;
    height: 320px; /* —á—Ç–æ–±—ã —Å—É–Ω–¥—É–∫ –±—ã–ª –≤–∏–¥–µ–Ω —Ü–µ–ª–∏–∫–æ–º */
    display: block;
}

.drop-chest-3d canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
    border-radius: 12px;
}

.drop-chest-fallback {
    display: none;
}

#dropChestFallback.waiting {
    display: block;
    animation: dropChestSpin 2000ms linear forwards;
}

#dropChestFallback.opening {
    display: block;
    animation: dropChestPop 2000ms ease-in-out;
}

/* —É–±—Ä–∞–ª–∏ —Å–≤–µ—á–µ–Ω–∏–µ –∏–∑ —Å—É–Ω–¥—É–∫–∞ */

@keyframes dropChestSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* dropChestShake —É–¥–∞–ª—ë–Ω (—Ç—Ä—è—Å–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) */

@keyframes dropChestPop {
    0% { filter: drop-shadow(0 0 0 rgba(255, 215, 0, 0)) brightness(1); }
    60% { filter: drop-shadow(0 14px 30px rgba(255, 215, 0, 0.25)) brightness(1.05); }
    100% { filter: drop-shadow(0 10px 25px rgba(255, 215, 0, 0.35)) brightness(1.08); }
}
</style>
{% endblock %}

{% block content %}
<div class="raid-boss-container">
    {% if not boss %}
    <div class="no-boss-message">
        <h2>–†–µ–π–¥ –±–æ—Å—Å–∞ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</h2>
        <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –≤–∫–ª—é—á–∏–ª —Ä–µ–π–¥ –±–æ—Å—Å–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∑–∂–µ!</p>
    </div>
    {% else %}
    {% set total_health = boss.tasks|sum(attribute='points') %}
    {% set current_health = boss.get_current_health() %}
    {% set health_percent = (current_health / total_health * 100) if total_health > 0 else 0 %}
    <div class="boss-header">
        <h1>{{ boss.name }}</h1>
        <div class="boss-health-bar">
            <div class="boss-health-fill" id="healthFill" style="width: {{ health_percent|round(2) }}%;">
                <span id="healthText" data-current="{{ current_health }}" data-total="{{ total_health }}">{{ current_health }}/{{ total_health }}</span>
            </div>
        </div>
        <div class="boss-animation-container">
            {% set initial_boss_frame = (boss_animation_frames[0] if boss_animation_frames and boss_animation_frames|length > 0 else url_for('static', filename='animation/boss/1.png')) %}
            <img id="bossAnimation" class="boss-animation" src="{{ initial_boss_frame }}" alt="–ë–æ—Å—Å">
        </div>
        {% if boss.rewards_list %}
        <div class="boss-rewards">
            <h3>üéÅ –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –ø–æ–±–µ–¥—É:</h3>
            <div class="boss-rewards-content">{{ boss.rewards_list }}</div>
        </div>
        {% endif %}
    </div>
    
    {% if boss.is_active %}
    <div class="user-progress" id="userProgress" style="display: none;">
        <div class="user-progress-content">
            <span class="progress-label">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:</span>
            <span class="progress-value" id="progressValue">0/0</span>
            <span class="progress-label" id="userNameLabel" style="display: none;">–ò–º—è: <span id="userNameValue"></span></span>
            <button type="button" class="change-name-btn" id="changeNameBtn" onclick="showChangeNameModal()" style="display: none;">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</button>
        </div>
    </div>
    {% endif %}
    
    <div class="class-damage-table">
        <h2>–£—Ä–æ–Ω</h2>
        <div class="class-damage-list" id="classDamageList">
            {% for class_obj in classes %}
            <div class="class-damage-item">
                <span class="class-name">{{ class_obj.name }}</span>
                <span class="damage-value" data-class-id="{{ class_obj.id }}">{{ class_damage.get(class_obj.id, 0) }} —É—Ä–æ–Ω–∞</span>
            </div>
            {% endfor %}
            {% if not classes %}
            <p style="text-align: center; color: #999; padding: 20px;">–ù–µ—Ç –∫–ª–∞—Å—Å–æ–≤</p>
            {% endif %}
        </div>
    </div>
    
    <div class="battle-button-container" id="battleButtonContainer">
        {% if not boss.is_active %}
        <div class="inactive-message">
            <p>‚ö†Ô∏è –†–µ–π–¥ –±–æ—Å—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</p>
            <p style="font-size: 14px; margin-top: 5px; opacity: 0.9;">–°—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–π–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
        </div>
        {% endif %}
        <button class="battle-btn" id="battleBtn" {% if not boss.is_active %}disabled{% endif %}>
            {% if boss.is_active %}‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è{% else %}–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù{% endif %}
        </button>
    </div>
    
    <div id="taskCard" style="display: none;">
        <div class="task-card">
            <h2 class="task-title" id="taskTitle"></h2>
            <div class="task-description" id="taskDescription"></div>
            <img id="taskImage" class="task-image" style="display: none;" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            
            <form class="task-form" id="taskForm" onsubmit="submitAnswer(event)">
                <input type="hidden" id="taskId" value="">
                <div class="form-group">
                    <label for="className">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label>
                    <select id="className" required>
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>
                        {% for class_obj in classes %}
                        <option value="{{ class_obj.id }}">{{ class_obj.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="answer">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                    <input type="text" id="answer" required placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç">
                </div>
                <button type="submit" class="submit-btn" id="submitBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            </form>
        </div>
    </div>
    
    <div id="messageBox"></div>
    
    <div id="defeatedBox" style="display: none;">
        <div class="defeated-boss">
            <h2>üéâ –ë–û–°–° –ü–û–ë–ï–ñ–î–ï–ù! üéâ</h2>
            <p>–í—Å–µ –∑–∞–¥–∞—á–∏ —Ä–µ—à–µ–Ω—ã!</p>
            <p>–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ —Ä–µ–π–¥–µ!</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ -->
<div class="modal-overlay" id="nameModal" style="display: none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeNameModal()">&times;</button>
        <h2 class="modal-title">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è</h2>
        <form id="nameForm" onsubmit="saveUserName(event)">
            <div class="form-group">
                <label for="userNameInput">–§–∞–º–∏–ª–∏—è –∏ –ò–º—è:</label>
                <input type="text" id="userNameInput" required placeholder="–í–≤–µ–¥–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è" autocomplete="off" maxlength="200">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px; word-wrap: break-word;">
                    –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞. –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ —Ç–æ—á–∫–∏.
                </small>
            </div>
            <button type="submit" class="submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ -->
<div class="modal-overlay" id="focusWarningModal" style="display: none;">
    <div class="modal-content">
        <h2 class="modal-title">–í–Ω–∏–º–∞–Ω–∏–µ</h2>
        <div style="color:#333; font-size: 18px; line-height: 1.6; text-align: center;">
            –í—ã –±—ã–ª–∏ –≤–Ω–µ –≤–∫–ª–∞–¥–∫–∏ –±–æ–ª–µ–µ 5 —Å–µ–∫—É–Ω–¥.<br>
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑
            <span id="focusWarningCountdown" style="font-weight: bold;">2</span> —Å–µ–∫.
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥—Ä–æ–ø–∞ (—Å—É–Ω–¥—É–∫) -->
<div class="modal-overlay" id="dropModal" style="display: none;">
    <div class="modal-content drop-modal-content">
        <button class="modal-close" onclick="closeDropModal()">&times;</button>
        <h2 class="modal-title" id="dropTitle">üéÅ –î—Ä–æ–ø –ø–æ–ª—É—á–µ–Ω!</h2>
        <div class="drop-chest-stage">
            <div class="drop-chest-wrap" id="dropChestWrap" role="button" tabindex="0" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫">
                <div id="dropChest" class="drop-chest drop-chest-3d" aria-hidden="true"></div>
                <img id="dropChestFallback" class="drop-chest drop-chest-fallback" src="{{ url_for('static', filename='box.png') }}" alt="–°—É–Ω–¥—É–∫">
                <canvas id="dropFireworks" class="drop-fireworks" aria-hidden="true"></canvas>
                <div class="drop-result" id="dropResult"></div>
            </div>
            <div class="drop-subhint">–°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏‚Ä¶</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
// –ó–∞—â–∏—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º (–≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á–∏):
// –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞/—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã–ª–∞ –≤–Ω–µ —Ñ–æ–∫—É—Å–∞ > 5 —Å–µ–∫—É–Ω–¥ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º.
window.bossFocusProtection = (function () {
    const MAX_INACTIVE_MS = 5000;
    const RELOAD_DELAY_MS = 2000;

    let armed = false;
    let hiddenSince = null;
    let reloadTriggered = false;
    let reloadTimeoutId = null;
    let countdownIntervalId = null;

    function cleanupFocusWarningTimers() {
        if (countdownIntervalId) {
            clearInterval(countdownIntervalId);
            countdownIntervalId = null;
        }
        if (reloadTimeoutId) {
            clearTimeout(reloadTimeoutId);
            reloadTimeoutId = null;
        }
    }

    function markHidden() {
        if (!armed || reloadTriggered) return;
        if (hiddenSince === null) hiddenSince = Date.now();
    }

    function showFocusWarningAndScheduleReload() {
        const modal = document.getElementById('focusWarningModal');
        const countdownEl = document.getElementById('focusWarningCountdown');

        cleanupFocusWarningTimers();

        if (modal) {
            modal.classList.add('show');
            modal.style.display = 'flex';
        }

        const start = Date.now();
        const updateCountdown = () => {
            const remainingMs = Math.max(0, RELOAD_DELAY_MS - (Date.now() - start));
            const remainingSec = Math.max(0, Math.ceil(remainingMs / 1000));
            if (countdownEl) countdownEl.textContent = String(remainingSec);
            if (remainingMs <= 0 && countdownIntervalId) {
                clearInterval(countdownIntervalId);
                countdownIntervalId = null;
            }
        };

        updateCountdown();
        countdownIntervalId = setInterval(updateCountdown, 200);
        reloadTimeoutId = setTimeout(() => {
            cleanupFocusWarningTimers();
            window.location.reload();
        }, RELOAD_DELAY_MS);
    }

    function checkAndReload() {
        if (!armed || reloadTriggered) return;
        if (hiddenSince === null) return;

        const inactiveMs = Date.now() - hiddenSince;
        if (inactiveMs > MAX_INACTIVE_MS) {
            reloadTriggered = true;
            showFocusWarningAndScheduleReload();
            return;
        }

        // –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
        hiddenSince = null;
    }

    function onVisibilityChange() {
        if (document.hidden) markHidden();
        else checkAndReload();
    }

    function arm() {
        if (armed) return;
        armed = true;
        hiddenSince = null;
        reloadTriggered = false;

        document.addEventListener('visibilitychange', onVisibilityChange);
        window.addEventListener('blur', markHidden);
        window.addEventListener('focus', checkAndReload);
    }

    function disarm() {
        if (!armed) return;
        armed = false;
        hiddenSince = null;
        reloadTriggered = false;
        cleanupFocusWarningTimers();

        document.removeEventListener('visibilitychange', onVisibilityChange);
        window.removeEventListener('blur', markHidden);
        window.removeEventListener('focus', checkAndReload);
    }

    return { arm, disarm };
})();

// –°–ø–∏—Å–æ–∫ –∫–∞–¥—Ä–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –±–æ—Å—Å–∞ –±–µ—Ä—ë–º —Å —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —Ä–µ–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–∞–º –≤ static/animation/boss/)
const BOSS_ANIMATION_FRAMES = {{ (boss_animation_frames or [])|tojson }};

let currentTask = null;
let bossId = {{ boss.id if boss else 'null' }};
let bossIsActive = {% if boss and boss.is_active %}true{% else %}false{% endif %};
let resumeBattleAfterNameSave = false;

// ==================== –î–†–û–ü: –°–£–ù–î–£–ö (UI) ====================
const DROP_AUTO_OPEN_DELAY_MS = 2000; // –æ–∂–∏–¥–∞–Ω–∏–µ (—Ç—Ä—è—Å–∫–∞) –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
const DROP_OPEN_ANIMATION_MS = 2000;  // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è
let dropStartOpenTimeoutId = null;
let dropRevealTimeoutId = null;
let dropChest3D = null;
let dropFireworks = null;

function normalizeDropProbability(value) {
    const raw = String(value ?? '').trim().toLowerCase();
    if (!raw) return 'high';
    if (raw === 'very_low' || raw === 'very-low' || raw === 'low' || raw === '–Ω–∏–∑–∫–∏–π' || raw === '–Ω–∏–∑–∫–∞—è' || raw.includes('–æ—á–µ–Ω—å')) return 'very_low';
    if (raw === 'medium' || raw === '—Å—Ä–µ–¥–Ω–∏–π' || raw === '—Å—Ä–µ–¥–Ω—è—è') return 'medium';
    return 'high';
}

function applyDropThemeToDom(chestWrap, probability) {
    if (!chestWrap) return;
    chestWrap.classList.remove('drop-theme-high', 'drop-theme-medium', 'drop-theme-very-low');
    const p = normalizeDropProbability(probability);
    const cls = p === 'very_low' ? 'drop-theme-very-low' : `drop-theme-${p}`;
    chestWrap.classList.add(cls);
}

function clearDropTheme(chestWrap) {
    if (!chestWrap) return;
    chestWrap.classList.remove('drop-theme-high', 'drop-theme-medium', 'drop-theme-very-low');
}

function createChestFireworks(canvas) {
    const ctx = canvas.getContext('2d', { alpha: true });
    if (!ctx) return null;

    let running = false;
    let rafId = null;
    let lastTs = 0;
    let w = 1;
    let h = 1;
    let dpr = 1;
    let ro = null;

    const rockets = [];
    const particles = [];

    const COLORS = [
        [255, 90, 90],
        [255, 214, 102],
        [125, 211, 252],
        [167, 243, 208],
        [196, 181, 253],
        [252, 165, 165]
    ];

    const rand = (min, max) => min + Math.random() * (max - min);
    const pickColor = () => COLORS[Math.floor(Math.random() * COLORS.length)];

    function resize() {
        const cw = Math.max(1, canvas.clientWidth);
        const ch = Math.max(1, canvas.clientHeight);
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        w = cw;
        h = ch;
        canvas.width = Math.round(cw * dpr);
        canvas.height = Math.round(ch * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function explode(x, y, base) {
        const count = Math.floor(rand(26, 38));
        for (let i = 0; i < count; i++) {
            const a = (Math.PI * 2 * i) / count + rand(-0.15, 0.15);
            const sp = rand(1.8, 3.6);
            particles.push({
                x,
                y,
                vx: Math.cos(a) * sp,
                vy: Math.sin(a) * sp,
                g: rand(2.6, 3.4),
                life: rand(0.75, 1.25),
                age: 0,
                r: base.r,
                gC: base.g,
                b: base.b
            });
        }
    }

    function launch(originX, originY) {
        const [r, g, b] = pickColor();
        rockets.push({
            x: originX,
            y: originY,
            vx: rand(-0.35, 0.35),
            vy: rand(-6.2, -7.6),
            t: 0,
            explodeAt: rand(0.48, 0.68),
            r, g, b
        });
    }

    function step(ts) {
        if (!running) return;
        if (!lastTs) lastTs = ts;
        const dt = Math.min(34, ts - lastTs) / 1000;
        lastTs = ts;

        ctx.clearRect(0, 0, w, h);

        // –†–∞–∫–µ—Ç—ã (–≤—ã—Å—Ç—Ä–µ–ª—ã)
        for (let i = rockets.length - 1; i >= 0; i--) {
            const r = rockets[i];
            r.t += dt;
            r.vy += 5.0 * dt;
            r.x += r.vx * 60 * dt;
            r.y += r.vy * 60 * dt;

            ctx.globalCompositeOperation = 'lighter';
            ctx.strokeStyle = `rgba(${r.r},${r.g},${r.b},0.65)`;
            ctx.lineWidth = 2.0;
            ctx.beginPath();
            ctx.moveTo(r.x, r.y);
            ctx.lineTo(r.x - r.vx * 22, r.y - r.vy * 0.5);
            ctx.stroke();
            ctx.globalCompositeOperation = 'source-over';

            if (r.t >= r.explodeAt || r.vy > -1.0) {
                explode(r.x, r.y, r);
                rockets.splice(i, 1);
            }
        }

        // –í—Å–ø—ã—à–∫–∏
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.age += dt;
            const k = Math.max(0, 1 - p.age / p.life);
            p.vy += p.g * 60 * dt * 0.06;
            p.x += p.vx * 60 * dt;
            p.y += p.vy * 60 * dt;

            ctx.fillStyle = `rgba(${p.r},${p.gC},${p.b},${0.9 * k})`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 2.2, 0, Math.PI * 2);
            ctx.fill();

            if (p.age >= p.life || p.y > h + 40 || p.x < -40 || p.x > w + 40) {
                particles.splice(i, 1);
            }
        }

        if (rockets.length === 0 && particles.length === 0) {
            stop();
            return;
        }

        rafId = requestAnimationFrame(step);
    }

    function start() {
        if (running) return;
        running = true;
        lastTs = 0;
        resize();
        ro = new ResizeObserver(() => resize());
        ro.observe(canvas);
        rafId = requestAnimationFrame(step);
    }

    function stop() {
        running = false;
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
        lastTs = 0;
        rockets.length = 0;
        particles.length = 0;
        try { ro?.disconnect?.(); } catch (e) { /* noop */ }
        ro = null;
        try { ctx.clearRect(0, 0, w, h); } catch (e) { /* noop */ }
    }

    function shootFromChest() {
        start();
        const ox = w * 0.5;
        const oy = h * 0.52; // –ø—Ä–∏–º–µ—Ä–Ω–æ ‚Äú–∏–∑–Ω—É—Ç—Ä–∏‚Äù —Å—É–Ω–¥—É–∫–∞
        launch(ox + rand(-6, 6), oy);
        setTimeout(() => launch(ox + rand(-10, 10), oy), 120);
        setTimeout(() => launch(ox + rand(-8, 8), oy), 240);
    }

    return { start, stop, shootFromChest };
}

function stopDropFireworks() {
    try { dropFireworks?.stop?.(); } catch (e) { /* noop */ }
    dropFireworks = null;
}

function playDropFireworks() {
    const canvas = document.getElementById('dropFireworks');
    if (!canvas) return;
    stopDropFireworks();
    dropFireworks = createChestFireworks(canvas);
    dropFireworks?.shootFromChest?.();
}

function initDropChest3D() {
    const container = document.getElementById('dropChest');
    const fallback = document.getElementById('dropChestFallback');

    if (!container) return;
    if (!window.THREE) {
        // three.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback
        if (fallback) fallback.style.display = 'block';
        container.style.display = 'none';
        return;
    }

    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ WebGL
    try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) throw new Error('no-webgl');
    } catch (e) {
        if (fallback) fallback.style.display = 'block';
        container.style.display = 'none';
        return;
    }

    // –°–æ–∑–¥–∞—ë–º —Ä–µ–Ω–¥–µ—Ä –æ–¥–∏–Ω —Ä–∞–∑
    if (dropChest3D) return;

    const THREE = window.THREE;
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(35, 1, 0.1, 100);
    camera.position.set(0, 2.35, 6.2);
    camera.lookAt(0, 0.25, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    container.innerHTML = '';
    container.appendChild(renderer.domElement);

    // –°–≤–µ—Ç
    const hemi = new THREE.HemisphereLight(0xffffff, 0x2b2b2b, 1.05);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 1.1);
    dir.position.set(3.5, 6, 4);
    scene.add(dir);

    // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã (low-poly/–º—É–ª—å—Ç—è—à–Ω–æ)
    const woodLightMat = new THREE.MeshStandardMaterial({ color: 0xb6763a, roughness: 0.85, metalness: 0.03, flatShading: true });
    const woodDarkMat = new THREE.MeshStandardMaterial({ color: 0x7b4b24, roughness: 0.9, metalness: 0.02, flatShading: true });
    const metalGoldMat = new THREE.MeshStandardMaterial({ color: 0xf2c14e, roughness: 0.35, metalness: 0.65, flatShading: true });
    const metalDarkMat = new THREE.MeshStandardMaterial({ color: 0x5b4b22, roughness: 0.55, metalness: 0.35, flatShading: true });
    const outlineMat = new THREE.MeshBasicMaterial({ color: 0x1b1b1b, side: THREE.BackSide });

    // –¢–µ–º–∞ —Å—É–Ω–¥—É–∫–∞ –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –¥—Ä–æ–ø–∞
    const CHEST_THEMES = {
        high: {
            woodLight: 0xb6763a,
            woodDark: 0x7b4b24,
            metalMain: 0xf2c14e,
            metalMainRough: 0.35,
            metalMainMetal: 0.65,
            metalDark: 0x5b4b22,
            metalDarkRough: 0.55,
            metalDarkMetal: 0.35
        },
        medium: {
            // –∞–º–µ—Ç–∏—Å—Ç–æ–≤—ã–π —Å—É–Ω–¥—É–∫
            woodLight: 0x9b59b6,
            woodDark: 0x5b2c6f,
            metalMain: 0xcbd5e1,   // —Å–µ—Ä–µ–±—Ä–æ
            metalMainRough: 0.28,
            metalMainMetal: 0.78,
            metalDark: 0x334155,
            metalDarkRough: 0.45,
            metalDarkMetal: 0.6
        },
        very_low: {
            // –∞–ª–º–∞–∑–Ω—ã–π —Å—É–Ω–¥—É–∫ (–ª–µ–¥—è–Ω–æ–π —Ü–∏–∞–Ω)
            woodLight: 0x67e8f9,
            woodDark: 0x0284c7,
            metalMain: 0xf8fafc,
            metalMainRough: 0.16,
            metalMainMetal: 0.92,
            metalDark: 0x22d3ee,
            metalDarkRough: 0.24,
            metalDarkMetal: 0.78
        }
    };

    function applyChestTheme(probability) {
        const p = normalizeDropProbability(probability);
        const t = CHEST_THEMES[p] || CHEST_THEMES.high;
        woodLightMat.color.setHex(t.woodLight);
        woodDarkMat.color.setHex(t.woodDark);
        metalGoldMat.color.setHex(t.metalMain);
        metalGoldMat.roughness = t.metalMainRough;
        metalGoldMat.metalness = t.metalMainMetal;
        metalDarkMat.color.setHex(t.metalDark);
        metalDarkMat.roughness = t.metalDarkRough;
        metalDarkMat.metalness = t.metalDarkMetal;
    }

    applyChestTheme('high');

    const addOutline = (mesh, scale = 1.045) => {
        const outline = new THREE.Mesh(mesh.geometry, outlineMat);
        outline.scale.set(scale, scale, scale);
        mesh.add(outline);
    };

    const chestGroup = new THREE.Group();
    scene.add(chestGroup);

    // –ü–æ–¥–ª–æ–∂–∫–∞/–ø–æ–¥–∏—É–º + —Ç–µ–Ω—å
    const pad = new THREE.Mesh(
        new THREE.CylinderGeometry(1.85, 1.95, 0.22, 28),
        new THREE.MeshStandardMaterial({ color: 0x2b2b2b, roughness: 0.9, metalness: 0.0, flatShading: true })
    );
    pad.position.y = -0.82;
    addOutline(pad, 1.02);
    chestGroup.add(pad);

    const padTop = new THREE.Mesh(
        new THREE.CylinderGeometry(1.75, 1.85, 0.06, 28),
        new THREE.MeshStandardMaterial({ color: 0x3a3a3a, roughness: 0.85, metalness: 0.0, flatShading: true })
    );
    padTop.position.y = -0.70;
    addOutline(padTop, 1.02);
    chestGroup.add(padTop);

    const shadow = new THREE.Mesh(
        new THREE.CircleGeometry(1.35, 28),
        new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.18 })
    );
    shadow.rotation.x = -Math.PI / 2;
    shadow.position.y = -0.60;
    chestGroup.add(shadow);

    // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é

    // ===== –°–£–ù–î–£–ö: –ø–æ–ª–æ–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ (—Å—Ç–µ–Ω–∫–∏ + –¥–Ω–æ + –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ–±—à–∏–≤–∫–∞) =====
    const OUTER_W = 2.28;
    const OUTER_H = 0.96;
    const OUTER_D = 1.56;
    const BASE_CENTER_Y = -0.02;
    const WALL_THICK = 0.14;
    const FLOOR_THICK = 0.14;
    const LINER_THICK = 0.02;

    const innerW = OUTER_W - 2 * WALL_THICK;
    const innerD = OUTER_D - 2 * WALL_THICK;
    const wallH = OUTER_H - FLOOR_THICK;
    const bottomY = BASE_CENTER_Y - OUTER_H / 2;
    const floorY = bottomY + FLOOR_THICK / 2;
    const wallY = bottomY + FLOOR_THICK + wallH / 2;

    const interiorMat = new THREE.MeshStandardMaterial({
        color: 0x2a1a0f,
        roughness: 0.98,
        metalness: 0.0,
        flatShading: true,
        // –≤–∞–∂–Ω–æ: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –∏–∑–Ω—É—Ç—Ä–∏/–ø–æ–¥ —É–≥–ª–∞–º–∏
        side: THREE.DoubleSide
    });

    // –ù–∞—Ä—É–∂–Ω—ã–µ —Å—Ç–µ–Ω–∫–∏/–¥–Ω–æ (–¥–µ—Ä–µ–≤–æ)
    const floorOuter = new THREE.Mesh(new THREE.BoxGeometry(innerW, FLOOR_THICK, innerD), woodLightMat);
    floorOuter.position.set(0, floorY, 0);
    chestGroup.add(floorOuter);

    const wallFrontOuter = new THREE.Mesh(new THREE.BoxGeometry(innerW, wallH, WALL_THICK), woodLightMat);
    wallFrontOuter.position.set(0, wallY, OUTER_D / 2 - WALL_THICK / 2);
    chestGroup.add(wallFrontOuter);

    const wallBackOuter = wallFrontOuter.clone();
    wallBackOuter.position.z = -OUTER_D / 2 + WALL_THICK / 2;
    chestGroup.add(wallBackOuter);

    const wallLeftOuter = new THREE.Mesh(new THREE.BoxGeometry(WALL_THICK, wallH, innerD), woodLightMat);
    wallLeftOuter.position.set(-OUTER_W / 2 + WALL_THICK / 2, wallY, 0);
    chestGroup.add(wallLeftOuter);

    const wallRightOuter = wallLeftOuter.clone();
    wallRightOuter.position.x = OUTER_W / 2 - WALL_THICK / 2;
    chestGroup.add(wallRightOuter);

    // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ–±—à–∏–≤–∫–∞ (—Ç—ë–º–Ω–∞—è) ‚Äî —á—Ç–æ–±—ã —Å—É–Ω–¥—É–∫ –≤—ã–≥–ª—è–¥–µ–ª –ø–æ–ª—ã–º
    const floorInner = new THREE.Mesh(new THREE.BoxGeometry(innerW, LINER_THICK, innerD), interiorMat);
    floorInner.position.set(0, floorY + FLOOR_THICK / 2 + LINER_THICK / 2 + 0.002, 0);
    chestGroup.add(floorInner);

    const innerFront = new THREE.Mesh(new THREE.BoxGeometry(innerW, wallH, LINER_THICK), interiorMat);
    innerFront.position.set(0, wallY, OUTER_D / 2 - WALL_THICK - LINER_THICK / 2 - 0.002);
    chestGroup.add(innerFront);

    const innerBack = innerFront.clone();
    innerBack.position.z = -OUTER_D / 2 + WALL_THICK + LINER_THICK / 2 + 0.002;
    chestGroup.add(innerBack);

    const innerLeft = new THREE.Mesh(new THREE.BoxGeometry(LINER_THICK, wallH, innerD), interiorMat);
    innerLeft.position.set(-OUTER_W / 2 + WALL_THICK + LINER_THICK / 2 + 0.002, wallY, 0);
    chestGroup.add(innerLeft);

    const innerRight = innerLeft.clone();
    innerRight.position.x = OUTER_W / 2 - WALL_THICK - LINER_THICK / 2 - 0.002;
    chestGroup.add(innerRight);

    // –í–µ—Ä—Ö–Ω—è—è –æ–∫–∞–Ω—Ç–æ–≤–∫–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ ‚Äî –¥–µ–ª–∞–µ–º 4 –±–æ—Ä—Ç–∏–∫–∞
    const RIM_W = OUTER_W + 0.06;
    const RIM_D = OUTER_D + 0.06;
    const RIM_H = 0.12;
    const RIM_T = 0.12;
    const rimY = bottomY + OUTER_H - RIM_H / 2;

    const rimFront = new THREE.Mesh(new THREE.BoxGeometry(RIM_W, RIM_H, RIM_T), woodDarkMat);
    rimFront.position.set(0, rimY, RIM_D / 2 - RIM_T / 2);
    addOutline(rimFront, 1.03);
    chestGroup.add(rimFront);

    const rimBack = rimFront.clone();
    rimBack.position.z = -RIM_D / 2 + RIM_T / 2;
    chestGroup.add(rimBack);

    const rimSideGeo = new THREE.BoxGeometry(RIM_T, RIM_H, RIM_D - 2 * RIM_T);
    const rimLeft = new THREE.Mesh(rimSideGeo, woodDarkMat);
    rimLeft.position.set(-RIM_W / 2 + RIM_T / 2, rimY, 0);
    addOutline(rimLeft, 1.03);
    chestGroup.add(rimLeft);

    const rimRight = rimLeft.clone();
    rimRight.position.x = RIM_W / 2 - RIM_T / 2;
    chestGroup.add(rimRight);

    const baseBottomRim = new THREE.Mesh(new THREE.BoxGeometry(2.34, 0.12, 1.62), woodDarkMat);
    baseBottomRim.position.set(0, -0.50, 0);
    addOutline(baseBottomRim);
    chestGroup.add(baseBottomRim);

    // –ü–µ—Ä–µ–¥–Ω—è—è –ø–∞–Ω–µ–ª—å + –±–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏
    const frontPanel = new THREE.Mesh(new THREE.BoxGeometry(1.92, 0.58, 0.06), woodDarkMat);
    frontPanel.position.set(0, -0.06, 0.79);
    addOutline(frontPanel, 1.035);
    chestGroup.add(frontPanel);

    const sidePanelL = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.58, 1.34), woodDarkMat);
    sidePanelL.position.set(-1.14, -0.06, 0);
    addOutline(sidePanelL, 1.035);
    chestGroup.add(sidePanelL);

    const sidePanelR = sidePanelL.clone();
    sidePanelR.position.x = 1.14;
    chestGroup.add(sidePanelR);

    // –ù–æ–∂–∫–∏
    const footGeo = new THREE.BoxGeometry(0.26, 0.18, 0.26);
    const footPositions = [
        [-0.95, -0.62, 0.62],
        [0.95, -0.62, 0.62],
        [-0.95, -0.62, -0.62],
        [0.95, -0.62, -0.62]
    ];
    footPositions.forEach(([x, y, z]) => {
        const foot = new THREE.Mesh(footGeo, woodDarkMat);
        foot.position.set(x, y, z);
        addOutline(foot, 1.04);
        chestGroup.add(foot);
    });

    // –ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ —É–≥–æ–ª–∫–∏ (–ø—Ä–æ—Å—Ç—ã–µ, –Ω–æ —á–∏—Ç–∞–µ–º—ã–µ)
    const cornerGeo = new THREE.BoxGeometry(0.16, 0.72, 0.16);
    const cornerPositions = [
        [-1.12, -0.08, 0.76],
        [1.12, -0.08, 0.76],
        [-1.12, -0.08, -0.76],
        [1.12, -0.08, -0.76]
    ];
    cornerPositions.forEach(([x, y, z]) => {
        const corner = new THREE.Mesh(cornerGeo, metalDarkMat);
        corner.position.set(x, y, z);
        addOutline(corner, 1.03);
        chestGroup.add(corner);
    });

    // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–º–µ–Ω—å (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π) + –ø–æ–ø–µ—Ä–µ—á–∏–Ω—ã
    const bandV = new THREE.Mesh(new THREE.BoxGeometry(0.26, 1.02, 0.10), metalGoldMat);
    bandV.position.set(0, -0.02, 0.79);
    addOutline(bandV, 1.03);
    chestGroup.add(bandV);

    const bandTop = new THREE.Mesh(new THREE.BoxGeometry(2.36, 0.08, 0.10), metalGoldMat);
    bandTop.position.set(0, 0.24, 0.79);
    addOutline(bandTop, 1.03);
    chestGroup.add(bandTop);

    const bandBottom = new THREE.Mesh(new THREE.BoxGeometry(2.36, 0.08, 0.10), metalGoldMat);
    bandBottom.position.set(0, -0.40, 0.79);
    addOutline(bandBottom, 1.03);
    chestGroup.add(bandBottom);

    // –ó–∞–º–æ–∫ (–ø–ª–∞—Å—Ç–∏–Ω–∞ + —è–∑—ã—á–æ–∫)
    const lockPlate = new THREE.Mesh(new THREE.BoxGeometry(0.44, 0.34, 0.10), metalDarkMat);
    lockPlate.position.set(0, 0.02, 0.86);
    addOutline(lockPlate, 1.03);
    chestGroup.add(lockPlate);

    const lockBody = new THREE.Mesh(new THREE.BoxGeometry(0.26, 0.26, 0.12), metalGoldMat);
    lockBody.position.set(0, 0.02, 0.92);
    addOutline(lockBody, 1.03);
    chestGroup.add(lockBody);

    const lockTongue = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.16, 0.06), metalGoldMat);
    lockTongue.position.set(0, -0.12, 0.95);
    addOutline(lockTongue, 1.03);
    chestGroup.add(lockTongue);

    // ===== –°–£–ù–î–£–ö: –∫—Ä—ã—à–∫–∞ (–æ–∫—Ä—É–≥–ª–∞—è, –Ω–∞ —à–∞—Ä–Ω–∏—Ä–µ) =====
    const lidPivot = new THREE.Group();
    lidPivot.position.set(0, 0.44, -0.78);
    chestGroup.add(lidPivot);

    // –ù–∏–∂–Ω—è—è "–¥–æ—Å–∫–∞" –∫—Ä—ã—à–∫–∏
    const lidBase = new THREE.Mesh(new THREE.BoxGeometry(2.28, 0.22, 1.56), woodLightMat);
    lidBase.position.set(0, 0.11, 0.78);
    addOutline(lidBase);
    lidPivot.add(lidBase);

    // –û–∫—Ä—É–≥–ª–∞—è –≤–µ—Ä—Ö—É—à–∫–∞ –∫—Ä—ã—à–∫–∏ (–ø–æ–ª—É—Ü–∏–ª–∏–Ω–¥—Ä)
    const lidCurveGeo = new THREE.CylinderGeometry(0.78, 0.78, 2.28, 18, 1, false, 0, Math.PI);
    const lidCurve = new THREE.Mesh(lidCurveGeo, woodDarkMat);
    lidCurve.rotation.z = Math.PI / 2; // –æ—Å—å –ø–æ X
    lidCurve.rotation.y = Math.PI;     // —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –¥—É–≥—É "–≤–≤–µ—Ä—Ö"
    lidCurve.position.set(0, 0.32, 0.78);
    addOutline(lidCurve, 1.03);
    lidPivot.add(lidCurve);

    // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ –∫—Ä—ã—à–∫–∏ (—á—Ç–æ–±—ã —Å—É–Ω–¥—É–∫ –≤—ã–≥–ª—è–¥–µ–ª –ø–æ–ª—ã–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
    const lidInnerBase = new THREE.Mesh(
        new THREE.BoxGeometry(2.28 - 2 * WALL_THICK, LINER_THICK, 1.56 - 2 * WALL_THICK),
        interiorMat
    );
    // –Ω–∏–∑ –∫—Ä—ã—à–∫–∏ –æ–∫–æ–ª–æ –ª–∏–Ω–∏–∏ —Å—Ç—ã–∫–∞ —Å –æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
    lidInnerBase.position.set(0, 0.02, 0.78);
    lidPivot.add(lidInnerBase);

    const lidInnerCurveGeo = new THREE.CylinderGeometry(0.74, 0.74, 2.20, 16, 1, false, 0, Math.PI);
    const lidInnerCurve = new THREE.Mesh(lidInnerCurveGeo, interiorMat);
    lidInnerCurve.rotation.z = Math.PI / 2;
    lidInnerCurve.rotation.y = Math.PI;
    lidInnerCurve.position.set(0, 0.30, 0.78);
    lidPivot.add(lidInnerCurve);

    // –ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π –æ–±—Ä—É—á –Ω–∞ –∫—Ä—ã—à–∫–µ + "–ø–µ—Ä–µ–¥–Ω—è—è –∫—Ä–æ–º–∫–∞"
    const lidBand = new THREE.Mesh(new THREE.BoxGeometry(0.26, 0.62, 0.10), metalGoldMat);
    lidBand.position.set(0, 0.22, 1.00);
    addOutline(lidBand, 1.03);
    lidPivot.add(lidBand);

    const lidFrontLip = new THREE.Mesh(new THREE.BoxGeometry(2.36, 0.10, 0.10), metalDarkMat);
    lidFrontLip.position.set(0, 0.08, 1.55);
    addOutline(lidFrontLip, 1.03);
    lidPivot.add(lidFrontLip);

    // –ü–µ—Ç–ª–∏ (–Ω–∞–º—ë–∫)
    const hingeGeo = new THREE.CylinderGeometry(0.06, 0.06, 0.34, 10);
    const hingeL = new THREE.Mesh(hingeGeo, metalDarkMat);
    hingeL.rotation.z = Math.PI / 2;
    hingeL.position.set(-0.72, 0.06, -0.02);
    addOutline(hingeL, 1.03);
    lidPivot.add(hingeL);

    const hingeR = hingeL.clone();
    hingeR.position.x = 0.72;
    lidPivot.add(hingeR);

    // –ê–Ω–∏–º–∞—Ü–∏—è
    let rafId = null;
    let visible = false;
    let openingStart = null;
    let openingDuration = DROP_OPEN_ANIMATION_MS;
    let opened = false;
    let rotating = false;
    let rotateStart = null;
    const ROTATE_DURATION_MS = DROP_AUTO_OPEN_DELAY_MS; // –≤—Ä–∞—â–µ–Ω–∏–µ —Ä–æ–≤–Ω–æ –Ω–∞ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
    let baseRotY = 0; // "–ª–∏—Ü–æ–º –≤–ø–µ—Ä—ë–¥" = 0
    let baseRotX = 0.10;
    let baseY = -0.06;
    // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é

    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

    function renderFrame(now) {
        if (!visible) return;

        // –û–∂–∏–¥–∞–Ω–∏–µ: –ø–ª–∞–≤–Ω–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥–∏—É–º–µ
        if (rotating && !opened && openingStart === null) {
            if (rotateStart === null) rotateStart = now;
            const elapsed = now - rotateStart;
            const t = Math.max(0, Math.min(1, elapsed / ROTATE_DURATION_MS));
            chestGroup.rotation.y = baseRotY + (Math.PI * 2) * t;
            if (t >= 1) {
                // –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ "–ª–∏—Ü–æ–º –≤–ø–µ—Ä—ë–¥"
                rotating = false;
                rotateStart = null;
                chestGroup.rotation.y = baseRotY;
            }
        } else {
            rotateStart = null;
            chestGroup.rotation.y = baseRotY;
        }

        // –°–ø–æ–∫–æ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ X/Z –∏ –ø–æ–∑–∏—Ü–∏–∏
        chestGroup.rotation.x = baseRotX;
        chestGroup.rotation.z = 0;
        chestGroup.position.x = 0;
        chestGroup.position.y = baseY;

        if (openingStart !== null && !opened) {
            const t = Math.min(1, (now - openingStart) / openingDuration);
            const k = easeOutCubic(t);
            lidPivot.rotation.x = -Math.PI * 0.62 * k; // ~112¬∞
            if (t >= 1) {
                opened = true;
                openingStart = null;
            }
        }

        // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é

        renderer.render(scene, camera);
        rafId = requestAnimationFrame(renderFrame);
    }

    function resize() {
        const w = Math.max(1, container.clientWidth);
        const h = Math.max(1, container.clientHeight);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h, false);
    }

    const ro = new ResizeObserver(() => resize());
    ro.observe(container);
    resize();

    // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ fallback
    if (fallback) fallback.style.display = 'none';
    container.style.display = 'block';

    dropChest3D = {
        show() {
            visible = true;
            if (!rafId) rafId = requestAnimationFrame(renderFrame);
        },
        hide() {
            visible = false;
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
        },
        reset() {
            opened = false;
            openingStart = null;
            rotating = false;
            rotateStart = null;
            // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
            lidPivot.rotation.x = 0;
            chestGroup.rotation.y = baseRotY;
            chestGroup.rotation.x = baseRotX;
            chestGroup.rotation.z = 0;
            chestGroup.position.set(0, baseY, 0);
            // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
            renderer.render(scene, camera);
        },
        startRotate() {
            rotating = true;
            rotateStart = null;
        },
        stopRotate() {
            // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —Å—Ç–∞–≤–∏–º "–ª–∏—Ü–æ–º –≤–ø–µ—Ä—ë–¥"
            rotating = false;
            rotateStart = null;
            baseRotY = 0;
            chestGroup.rotation.y = baseRotY;
        },
        startOpen(ms = DROP_OPEN_ANIMATION_MS) {
            openingDuration = ms;
            opened = false;
            openingStart = performance.now();
            // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        },
        openInstant() {
            opened = true;
            openingStart = null;
            lidPivot.rotation.x = -Math.PI * 0.62;
            renderer.render(scene, camera);
        },
        setTheme(probability) {
            applyChestTheme(probability);
            renderer.render(scene, camera);
        }
    };
}

function closeDropModal() {
    const dropModal = document.getElementById('dropModal');
    const chest = document.getElementById('dropChest');
    const chestWrap = document.getElementById('dropChestWrap');
    const result = document.getElementById('dropResult');
    const fallback = document.getElementById('dropChestFallback');
    if (dropStartOpenTimeoutId) {
        clearTimeout(dropStartOpenTimeoutId);
        dropStartOpenTimeoutId = null;
    }
    if (dropRevealTimeoutId) {
        clearTimeout(dropRevealTimeoutId);
        dropRevealTimeoutId = null;
    }

    stopDropFireworks();

    if (dropModal) {
        dropModal.classList.remove('show');
        dropModal.style.display = 'none';
    }
    if (chest) {
        chest.classList.remove('opening', 'opened');
    }
    if (chestWrap) {
        chestWrap.classList.remove('opened');
        clearDropTheme(chestWrap);
    }
    if (result) {
        result.textContent = '';
    }
    if (fallback) {
        fallback.classList.remove('waiting', 'opening');
    }

    // 3D: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä
    try {
        dropChest3D?.hide?.();
    } catch (e) {
        // noop
    }
}

function showDropChest(dropName, probability = 'high') {
    const dropModal = document.getElementById('dropModal');
    const title = document.getElementById('dropTitle');
    const chest = document.getElementById('dropChest');
    const chestWrap = document.getElementById('dropChestWrap');
    const result = document.getElementById('dropResult');
    const fallback = document.getElementById('dropChestFallback');
    if (!dropModal || !chest || !result || !chestWrap) {
        // fallback –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ DOM –Ω–µ —Å–æ–≤–ø–∞–ª
        alert(`üéÅ –î—Ä–æ–ø: ${dropName}`);
        return;
    }

    if (dropStartOpenTimeoutId) {
        clearTimeout(dropStartOpenTimeoutId);
        dropStartOpenTimeoutId = null;
    }
    if (dropRevealTimeoutId) {
        clearTimeout(dropRevealTimeoutId);
        dropRevealTimeoutId = null;
    }

    stopDropFireworks();

    if (title) title.textContent = 'üéÅ –î—Ä–æ–ø –ø–æ–ª—É—á–µ–Ω!';
    result.textContent = '';
    result.classList.remove('show');
    chest.classList.remove('opening', 'opened');
    chestWrap.classList.remove('opened');
    applyDropThemeToDom(chestWrap, probability);
    if (fallback) {
        fallback.classList.remove('waiting', 'opening');
    }

    dropModal.classList.add('show');
    dropModal.style.display = 'flex';

    // 3D: –ª–µ–Ω–∏–≤–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–Ω–¥–µ—Ä
    try {
        initDropChest3D();
        dropChest3D?.setTheme?.(probability);
        dropChest3D?.reset?.();
        dropChest3D?.show?.();
        dropChest3D?.startRotate?.();
    } catch (e) {
        // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ ‚Äî –æ—Å—Ç–∞–Ω–µ—Ç—Å—è fallback
    }

    // Fallback: —Ç—Ä—è—Å–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã
    if (fallback && fallback.style.display === 'block') {
        fallback.classList.add('waiting');
    }

    const reveal = () => {
        chest.classList.add('opened');
        chestWrap.classList.add('opened');
        result.textContent = `–í—ã–ø–∞–ª–æ: ${dropName}`;
        result.classList.add('show');
        playDropFireworks();
    };

    const startOpenAnimation = () => {
        try {
            dropChest3D?.stopRotate?.();
        } catch (e) {
            // noop
        }
        if (fallback) {
            fallback.classList.remove('waiting');
            fallback.classList.add('opening');
        }

        // –≤–∏–∑—É–∞–ª—å–Ω—ã–π "–ø–æ–ø" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        void chest.offsetWidth;
        chest.classList.add('opening');

        // 3D: –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫—Ä—ã—à–∫–∏
        try {
            dropChest3D?.startOpen?.(DROP_OPEN_ANIMATION_MS);
        } catch (e) {
            // noop
        }
        // —Å–≤–µ—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        dropRevealTimeoutId = setTimeout(reveal, DROP_OPEN_ANIMATION_MS);
    };

    // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: 2—Å —Ç—Ä—è—Å–∫–∞ -> —Å—Ç–æ–ø -> 2—Å –æ—Ç–∫—Ä—ã—Ç–∏–µ -> —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    dropStartOpenTimeoutId = setTimeout(startOpenAnimation, DROP_AUTO_OPEN_DELAY_MS);

    // –ø–æ –∫–ª–∏–∫—É/Enter/Space ‚Äî –æ—Ç–∫—Ä—ã—Ç—å —Å—Ä–∞–∑—É (—Å–∫–∏–ø –æ–∂–∏–¥–∞–Ω–∏—è)
    const openNow = () => {
        if (dropStartOpenTimeoutId) {
            clearTimeout(dropStartOpenTimeoutId);
            dropStartOpenTimeoutId = null;
        }
        if (dropRevealTimeoutId) {
            clearTimeout(dropRevealTimeoutId);
            dropRevealTimeoutId = null;
        }
        if (fallback) {
            fallback.classList.remove('waiting', 'opening');
        }
        try { dropChest3D?.stopRotate?.(); } catch (e) { /* noop */ }
        try {
            dropChest3D?.openInstant?.();
        } catch (e) {
            // noop
        }
        reveal();
    };
    chestWrap.onclick = openNow;
    chestWrap.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openNow();
        }
    };
}

function formatNumber(value) {
    const num = Number(value);
    if (!Number.isFinite(num)) return String(value);
    return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 0 }).format(num);
}

function setBossHealthText(currentHealth, totalHealth) {
    const el = document.getElementById('healthText');
    if (!el) return;
    el.dataset.current = String(currentHealth);
    el.dataset.total = String(totalHealth);
    el.textContent = `${formatNumber(currentHealth)}/${formatNumber(totalHealth)}`;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É–∫–∞–º–∏
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function setCookie(name, value, days = null) {
    // –ï—Å–ª–∏ days = null, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É–∫–∏ –±–µ–∑ —Å—Ä–æ–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫)
    let expires = '';
    if (days !== null) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = `expires=${date.toUTCString()};`;
    } else {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ (20 –ª–µ—Ç)
        const date = new Date();
        date.setTime(date.getTime() + (20 * 365 * 24 * 60 * 60 * 1000));
        expires = `expires=${date.toUTCString()};`;
    }
    document.cookie = `${name}=${value};${expires}path=/`;
}

function getBossProgress() {
    const correctAnswers = parseInt(getCookie('boss_correct_answers') || '0');
    const totalAnswers = parseInt(getCookie('boss_total_answers') || '0');
    return { correctAnswers, totalAnswers };
}

function updateBossProgress(isCorrect) {
    const progress = getBossProgress();
    const newTotal = progress.totalAnswers + 1;
    const newCorrect = isCorrect ? progress.correctAnswers + 1 : progress.correctAnswers;
    
    setCookie('boss_correct_answers', newCorrect.toString());
    setCookie('boss_total_answers', newTotal.toString());
    
    return { correctAnswers: newCorrect, totalAnswers: newTotal };
}

function displayProgress() {
    if (!bossIsActive) {
        const progressDiv = document.getElementById('userProgress');
        if (progressDiv) {
            progressDiv.style.display = 'none';
        }
        return;
    }
    
    const progress = getBossProgress();
    const progressDiv = document.getElementById('userProgress');
    const progressValue = document.getElementById('progressValue');
    const userNameLabel = document.getElementById('userNameLabel');
    const userNameValue = document.getElementById('userNameValue');
    const changeNameBtn = document.getElementById('changeNameBtn');
    
    if (progressDiv && progressValue) {
        const savedUserName = getCookie('boss_user_name');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ò–õ–ò —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è (–¥–∞–∂–µ –ø—Ä–∏ 0/0)
        if (progress.totalAnswers > 0 || (savedUserName && savedUserName.trim() !== '')) {
            progressValue.textContent = `${progress.correctAnswers}/${progress.totalAnswers}`;
            progressDiv.style.display = 'block';

            if (savedUserName && userNameLabel && userNameValue) {
                userNameValue.textContent = savedUserName;
                userNameLabel.style.display = 'inline';
            } else if (userNameLabel) {
                userNameLabel.style.display = 'none';
            }

            if (changeNameBtn) {
                changeNameBtn.style.display = (savedUserName && savedUserName.trim() !== '') ? 'inline-block' : 'none';
            }
        } else {
            progressDiv.style.display = 'none';
        }
    }
}

function startBattle() {
    if (!bossId || bossId === 'null' || bossId === null) {
        alert('–ë–æ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    if (!bossIsActive) {
        alert('–†–µ–π–¥ –±–æ—Å—Å–∞ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –°—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const savedUserId = getCookie('boss_user_id');
    const savedUserName = getCookie('boss_user_name');
    
    if (!savedUserId || !savedUserName) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        resumeBattleAfterNameSave = true;
        showNameModal();
        return;
    }
    
    // –ï—Å–ª–∏ –∏–º—è –µ—Å—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ
    proceedWithBattle();
}

function showNameModal() {
    const nameModal = document.getElementById('nameModal');
    if (!nameModal) {
        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }

    const modalTitle = nameModal.querySelector('.modal-title');
    if (modalTitle) {
        modalTitle.textContent = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è';
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    nameModal.classList.add('show');
    nameModal.style.display = 'flex';
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–∏–¥–∏–º–æ
    setTimeout(() => {
        const userNameInput = document.getElementById('userNameInput');
        if (userNameInput) {
            userNameInput.value = '';
            userNameInput.focus();
        }
    }, 100);
}

function showChangeNameModal() {
    const nameModal = document.getElementById('nameModal');
    if (!nameModal) {
        alert('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        return;
    }

    resumeBattleAfterNameSave = false;

    const modalTitle = nameModal.querySelector('.modal-title');
    if (modalTitle) {
        modalTitle.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è';
    }

    nameModal.classList.add('show');
    nameModal.style.display = 'flex';

    setTimeout(() => {
        const userNameInput = document.getElementById('userNameInput');
        if (userNameInput) {
            userNameInput.value = (getCookie('boss_user_name') || '').trim();
            userNameInput.focus();
            userNameInput.select();
        }
    }, 100);
}

function closeNameModal() {
    const nameModal = document.getElementById('nameModal');
    if (nameModal) {
        nameModal.classList.remove('show');
        nameModal.style.display = 'none';
    }
}

function validateUserName(name) {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π)
    if (!name || !name.trim()) {
        return { valid: false, error: '–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' };
    }
    
    name = name.trim();
    
    if (name.length < 2) {
        return { valid: false, error: '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞' };
    }
    
    if (name.length > 200) {
        return { valid: false, error: '–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤' };
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    const dangerousPatterns = /[<>'"\/\\]|javascript:|onerror=|onclick=/i;
    if (dangerousPatterns.test(name)) {
        return { valid: false, error: '–ò–º—è —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã' };
    }
    
    // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ —Ç–æ—á–∫–∏
    const validPattern = /^[–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9\s\-\.]+$/;
    if (!validPattern.test(name)) {
        return { valid: false, error: '–ò–º—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã –∏ —Ç–æ—á–∫–∏' };
    }
    
    return { valid: true, error: null };
}

function saveUserName(event) {
    event.preventDefault();
    const nameInput = document.getElementById('userNameInput');
    const name = nameInput.value.trim();
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    const validation = validateUserName(name);
    if (!validation.valid) {
        alert(validation.error);
        nameInput.focus();
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const currentUserId = getCookie('boss_user_id');
    fetch('/api/raid-boss/save-user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            user_id: currentUserId ? parseInt(currentUserId) : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—É–∫–∏ —Å –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –∂–∏–∑–Ω–∏
            setCookie('boss_user_id', data.user_id.toString(), null);
            setCookie('boss_user_name', data.user_name, null);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeNameModal();

            // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            displayProgress();

            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–æ –∫–Ω–æ–ø–∫–æ–π "–°—Ä–∞–∂–∞—Ç—å—Å—è"
            if (resumeBattleAfterNameSave) {
                resumeBattleAfterNameSave = false;
                proceedWithBattle();
            } else {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è" –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const battleBtn = document.getElementById('battleBtn');
                if (battleBtn) {
                    battleBtn.disabled = !bossIsActive;
                    battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
                }
            }
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    });
}

function proceedWithBattle() {
    const battleBtn = document.getElementById('battleBtn');
    if (!battleBtn) {
        return;
    }
    
    battleBtn.disabled = true;
    battleBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    
    const taskCard = document.getElementById('taskCard');
    const messageBox = document.getElementById('messageBox');
    if (taskCard) taskCard.style.display = 'none';
    if (messageBox) messageBox.innerHTML = '';
    
    fetch('/api/raid-boss/task')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.boss_defeated) {
                    showDefeatedMessage();
                } else {
                    showTask(data.task);
                }
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
                if (battleBtn) {
                    battleBtn.disabled = !bossIsActive;
                    battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
                }
            }
        })
        .catch(error => {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏');
            if (battleBtn) {
                battleBtn.disabled = !bossIsActive;
                battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
            }
        });
}

function showTask(task) {
    currentTask = task;
    document.getElementById('taskId').value = task.id;
    document.getElementById('taskTitle').textContent = task.title;
    document.getElementById('taskDescription').textContent = task.description || '';
    
    if (task.image_filename) {
        document.getElementById('taskImage').src = `/uploads/tasks/${task.image_filename}`;
        document.getElementById('taskImage').style.display = 'block';
    } else {
        document.getElementById('taskImage').style.display = 'none';
    }
    
    document.getElementById('taskForm').reset();
    document.getElementById('taskCard').style.display = 'block';
    document.getElementById('messageBox').innerHTML = '';
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è" –∫–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞
    const battleButtonContainer = document.getElementById('battleButtonContainer');
    if (battleButtonContainer) {
        battleButtonContainer.style.display = 'none';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º—ã, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ —Å–∫—Ä—ã—Ç–∞
    document.getElementById('taskForm').style.display = 'block';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø–æ—Å–ª–µ reset —Ñ–æ—Ä–º–∞ –ø—É—Å—Ç–∞—è)
    setTimeout(validateForm, 0);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∑–∞–¥–∞—á–µ
    document.getElementById('taskCard').scrollIntoView({ behavior: 'smooth', block: 'start' });

    // –í–∫–ª—é—á–∞–µ–º –∑–∞—â–∏—Ç—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –∑–∞–¥–∞—á—É
    try {
        window.bossFocusProtection?.arm?.();
    } catch (e) {
        // –ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, –µ—Å–ª–∏ –∑–∞—â–∏—Ç–∞ –Ω–µ –≤–∫–ª—é—á–∏–ª–∞—Å—å
    }
}

function validateForm() {
    const className = document.getElementById('className');
    const answer = document.getElementById('answer');
    const submitBtn = document.getElementById('submitBtn');
    
    if (!className || !answer || !submitBtn) {
        return;
    }
    
    const classId = className.value;
    const answerValue = answer.value.trim();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å
    if (classId && answerValue) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
}

function submitAnswer(event) {
    event.preventDefault();
    
    const taskId = document.getElementById('taskId').value;
    const classId = document.getElementById('className').value;
    const classNameSelect = document.getElementById('className');
    const classNameText = classNameSelect.options[classNameSelect.selectedIndex].text;
    const answer = document.getElementById('answer').value.trim();
    
    if (!taskId || !classId || !answer) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const savedUserId = getCookie('boss_user_id');
    const savedUserName = getCookie('boss_user_name');
    
    const submitBtn = event.target.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    fetch('/api/raid-boss/submit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            task_id: parseInt(taskId),
            class_id: parseInt(classId),
            user_name: savedUserName || classNameText,
            user_id: savedUserId ? parseInt(savedUserId) : null,
            answer: answer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = data.message;
            
            // –ï—Å–ª–∏ –≤—ã–ø–∞–ª –¥—Ä–æ–ø, –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–º
            if (data.drop_reward && data.drop_reward.drop_name) {
                const dropName = String(data.drop_reward.drop_name);
                showDropChest(dropName, data.drop_reward.probability);
                message += `\nüéÅ –î—Ä–æ–ø –ø–æ–ª—É—á–µ–Ω: ${dropName}`;
            }
            
            showMessage(data.correct ? 'success' : 'error', message);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫—É–∫–∏
            if (data.update_progress) {
                const progress = updateBossProgress(data.is_correct);
                displayProgress();
            }
            
            if (data.correct) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats();
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è
            setTimeout(() => {
                showRetryButton();
            }, 2000);
        } else {
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
            submitBtn.disabled = false;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
            validateForm(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞');
        submitBtn.disabled = false;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
        validateForm(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É —Å–Ω–æ–≤–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
    });
}

function showMessage(type, message) {
    const messageBox = document.getElementById('messageBox');
    const messageClass = type === 'success' ? 'message-success' : (type === 'error' ? 'message-error' : 'message-info');
    
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br> –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const formattedMessage = message.replace(/\n/g, '<br>');
    
    messageBox.innerHTML = `
        <div class="message-box ${messageClass}">
            ${formattedMessage}
        </div>
    `;
    
    if (type === 'error') {
        // –ü—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞—á–∏
        document.getElementById('taskCard').style.display = 'none';
    } else {
        // –ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É
        document.getElementById('taskForm').style.display = 'none';
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
    messageBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function showRetryButton() {
    const messageBox = document.getElementById('messageBox');
    const retryContainer = document.createElement('div');
    retryContainer.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px; box-sizing: border-box; overflow: hidden;';
    retryContainer.innerHTML = `
        <button class="retry-btn" onclick="resetBattle()">
            üîÑ –ü–†–ò–ù–Ø–¢–¨ –£–ß–ê–°–¢–ò–ï –ï–©–ï –†–ê–ó üîÑ
        </button>
    `;
    messageBox.appendChild(retryContainer);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–Ω–æ–ø–∫–µ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    setTimeout(() => {
        retryContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function resetBattle() {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é "–±–µ–∑ –∑–∞–¥–∞—á–∏" ‚Äî –∑–∞—â–∏—Ç—É –≤—ã–∫–ª—é—á–∞–µ–º
    try {
        window.bossFocusProtection?.disarm?.();
    } catch (e) {
        // noop
    }

    document.getElementById('taskCard').style.display = 'none';
    document.getElementById('messageBox').innerHTML = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è" —Å–Ω–æ–≤–∞
    const battleButtonContainer = document.getElementById('battleButtonContainer');
    if (battleButtonContainer) {
        battleButtonContainer.style.display = 'block';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°—Ä–∞–∂–∞—Ç—å—Å—è"
    const battleBtn = document.getElementById('battleBtn');
    if (battleBtn) {
        battleBtn.disabled = !bossIsActive;
        battleBtn.textContent = bossIsActive ? '‚öîÔ∏è –°–†–ê–ñ–ê–¢–¨–°–Ø ‚öîÔ∏è' : '–†–ï–ô–î –ù–ï–ê–ö–¢–ò–í–ï–ù';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ñ–æ—Ä–º—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
    const taskForm = document.getElementById('taskForm');
    if (taskForm) {
        taskForm.style.display = 'block';
    }
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç';
    }
    currentTask = null;
}

function showDefeatedMessage() {
    document.getElementById('defeatedBox').style.display = 'block';
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π "–°—Ä–∞–∂–∞—Ç—å—Å—è"
    const battleButtonContainer = document.getElementById('battleButtonContainer');
    if (battleButtonContainer) {
        battleButtonContainer.style.display = 'none';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞
    const taskCard = document.getElementById('taskCard');
    if (taskCard) {
        taskCard.style.display = 'none';
    }
}

function updateStats() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Å—Å–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Å—Å–∞)
    if (!bossId) {
        return;
    }
    
    fetch(`/api/raid-boss/stats?boss_id=${bossId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
                const currentHealth = data.boss.current_health;
                const totalHealth = data.boss.total_health;
                const healthPercent = totalHealth > 0 ? (currentHealth / totalHealth) * 100 : 0;
                
                document.getElementById('healthFill').style.width = healthPercent + '%';
                setBossHealthText(currentHealth, totalHealth);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–Ω –ø–æ –∫–ª–∞—Å—Å–∞–º
                const classDamageList = document.getElementById('classDamageList');
                Object.keys(data.class_damage).forEach(classId => {
                    const damageElement = document.querySelector(`[data-class-id="${classId}"]`);
                    if (damageElement) {
                        damageElement.textContent = data.class_damage[classId].damage + ' —É—Ä–æ–Ω–∞';
                    }
                });
                
                // –ï—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ = 0, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–±–µ–¥–µ
                if (currentHealth <= 0) {
                    showDefeatedMessage();
                }
            }
        })
        .catch(error => {
            // –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞
        });
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Å—Å–∞)
if (bossId) {
    setInterval(updateStats, 20000);
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateStats();
}

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞–¥—Ä–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏ –±–æ—Å—Å–∞ –ø–æ —Å–ø–∏—Å–∫—É URL
function preloadBossAnimationFrames(frameUrls, callback) {
    if (!Array.isArray(frameUrls) || frameUrls.length === 0) {
        if (callback) callback();
        return;
    }

    let done = 0;
    const total = frameUrls.length;
    const onDone = () => {
        done += 1;
        if (done >= total && callback) callback();
    };

    frameUrls.forEach((src) => {
        const img = new Image();
        img.onload = onDone;
        img.onerror = onDone;
        img.src = src;
    });
}

// –ê–Ω–∏–º–∞—Ü–∏—è –±–æ—Å—Å–∞
let bossAnimationIntervalId = null;
function startBossAnimation(frameUrls) {
    const bossAnimation = document.getElementById('bossAnimation');
    if (!bossAnimation) return;

    if (!Array.isArray(frameUrls) || frameUrls.length === 0) return;

    // –ù–µ —Å–æ–∑–¥–∞—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–π–º–µ—Ä–æ–≤, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ
    if (bossAnimationIntervalId) {
        clearInterval(bossAnimationIntervalId);
        bossAnimationIntervalId = null;
    }

    let idx = 0;
    bossAnimation.src = frameUrls[0];

    // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–¥—Ä–æ–≤:
    // –¥–µ—Ä–∂–∏–º –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, –∫–∞–∫ —Ä–∞–Ω—å—à–µ (6 * 100ms = 600ms).
    const TARGET_LOOP_MS = 600;
    const MIN_FRAME_INTERVAL_MS = 30;  // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ/–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω–æ
    const MAX_FRAME_INTERVAL_MS = 350; // —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –º–∞–ª–æ–º —á–∏—Å–ª–µ –∫–∞–¥—Ä–æ–≤
    const rawInterval = Math.round(TARGET_LOOP_MS / frameUrls.length);
    const frameInterval = Math.max(MIN_FRAME_INTERVAL_MS, Math.min(MAX_FRAME_INTERVAL_MS, rawInterval));
    bossAnimationIntervalId = setInterval(function() {
        idx = (idx + 1) % frameUrls.length;
        bossAnimation.src = frameUrls[idx];
    }, frameInterval);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ (—Å–µ—Ä–≤–µ—Ä –º–æ–≥ –æ—Ç–¥–∞—Ç—å –±–µ–∑ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π —Ç—ã—Å—è—á)
    const initialHealthText = document.getElementById('healthText');
    if (initialHealthText && initialHealthText.dataset) {
        const current = initialHealthText.dataset.current;
        const total = initialHealthText.dataset.total;
        if (current !== undefined && total !== undefined) {
            setBossHealthText(current, total);
        }
    }

    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–¥—Ä—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –±–æ—Å—Å–∞, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    preloadBossAnimationFrames(BOSS_ANIMATION_FRAMES, function() {
        startBossAnimation(BOSS_ANIMATION_FRAMES);
    });
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    displayProgress();
    
    const className = document.getElementById('className');
    const answer = document.getElementById('answer');
    
    if (className) {
        className.addEventListener('change', validateForm);
    }
    if (answer) {
        answer.addEventListener('input', validateForm);
        answer.addEventListener('keyup', validateForm);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —Å—Ä–∞–∂–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
    const battleBtn = document.getElementById('battleBtn');
    if (battleBtn) {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–≤—è–∑–∞–Ω
        battleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            startBattle();
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    const nameModal = document.getElementById('nameModal');
    if (nameModal) {
        nameModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeNameModal();
            }
        });
    }

    const dropModal = document.getElementById('dropModal');
    if (dropModal) {
        dropModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDropModal();
            }
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (nameModal && (nameModal.classList.contains('show') || nameModal.style.display === 'flex')) {
                closeNameModal();
            }
            if (dropModal && (dropModal.classList.contains('show') || dropModal.style.display === 'flex')) {
                closeDropModal();
            }
        }
    });
});
</script>
{% endblock %}
