{% extends "base.html" %}

{% block title %}–ë–∏—Ç–≤–∞ –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body { font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif; }

.territory-page {
    min-height: 100vh;
    background: #3d2914 linear-gradient(180deg, rgba(61,41,20,0.97) 0%, #2c1810 50%, #1a0f08 100%);
    padding: 20px;
    color: #e8dcc4;
    position: relative;
}
.territory-page::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
}
.territory-page > * { position: relative; z-index: 1; }

.territory-page h1 {
    font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
    text-align: center;
    margin: 0 0 20px;
    font-size: 2rem;
    font-weight: 700;
    color: #d4a84b;
    text-shadow: 0 0 20px rgba(212,168,75,0.3), 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 0.08em;
}

/* –õ–∏–¥–µ—Ä ‚Äî –∫–ª–∞—Å—Å, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏–π –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –æ–±–ª–∞—Å—Ç–µ–π */
.global-progress {
    max-width: 500px;
    margin: 0 auto 24px;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    border-radius: 4px;
    padding: 14px 20px;
    border: 2px solid #5c4033;
    box-shadow: inset 0 1px 0 rgba(212,168,75,0.15), 0 4px 12px rgba(0,0,0,0.4);
}

.global-progress-title {
    font-family: 'Cinzel', Georgia, serif;
    font-size: 0.85rem;
    margin-bottom: 10px;
    color: #d4a84b;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    text-align: center;
}

.global-leader-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 15px;
    color: #e8dcc4;
}

.global-class-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
    border: 2px solid #5c4033;
    box-shadow: 0 0 0 1px rgba(212,168,75,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
}

.global-class-name {
    min-width: 100px;
    font-weight: bold;
    color: #e8dcc4;
}

.global-class-heraldry {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #5c4033;
    box-shadow: 0 0 0 1px rgba(212,168,75,0.3);
    flex-shrink: 0;
}

.global-class-count {
    min-width: 70px;
    text-align: center;
    font-weight: bold;
    color: #d4a84b;
}

.global-no-leader {
    font-size: 15px;
    color: #b8a088;
    font-style: italic;
    text-align: center;
}

.capture-countdown-value {
    font-family: 'Cinzel', Georgia, serif;
    font-size: 1.8rem;
    font-weight: bold;
    color: #d4a84b;
    text-align: center;
    letter-spacing: 0.08em;
}
.capture-countdown-hint {
    font-size: 13px;
    color: #b8a088;
    text-align: center;
    margin: 10px 0 0;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–æ –∫–æ–Ω—Ü–∞ –±–∏—Ç–≤—ã */
#battleEndCountdownBlock {
    margin: 0 auto 24px;
    padding: 8px 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}
#battleEndCountdownBlock .global-progress-title {
    margin-bottom: 0;
    font-size: 0.75rem;
}
#battleEndCountdownBlock .capture-countdown-value {
    font-size: 1.1rem;
    letter-spacing: 0.05em;
}

/* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥ –∏ –∫–∞–±–∏–Ω–µ—Ç */
.territory-top-nav {
    max-width: 920px;
    margin: 0 auto 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
}
.territory-top-nav a {
    color: #d4a84b;
    text-decoration: none;
    font-weight: bold;
    padding: 10px 18px;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    border: 1px solid #5c4033;
    border-radius: 4px;
    font-family: 'Cinzel', Georgia, serif;
    font-size: 0.9rem;
    letter-spacing: 0.04em;
    transition: color 0.2s, border-color 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.territory-top-nav a:hover {
    color: #e8c86a;
    border-color: #8b6914;
    box-shadow: 0 0 12px rgba(212,168,75,0.25);
}
.territory-login-btn {
    padding: 10px 20px;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b;
    border: 2px solid #5c4033;
    border-radius: 6px;
    font-weight: bold;
    text-decoration: none;
    font-family: 'Cinzel', Georgia, serif;
}
.territory-login-btn:hover {
    color: #e8c86a;
    border-color: #8b6914;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–≥—Ä–æ–∫–µ */
.territory-player-card {
    max-width: 920px;
    margin: 0 auto 20px;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    border: 2px solid #5c4033;
    border-radius: 8px;
    padding: 14px 18px;
    box-shadow: inset 0 1px 0 rgba(212,168,75,0.12), 0 4px 12px rgba(0,0,0,0.35);
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}
.territory-player-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #5c4033;
    box-shadow: 0 0 0 1px rgba(212,168,75,0.25);
    flex-shrink: 0;
    background: #2c1810;
}
.territory-player-avatar-placeholder {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: #2c1810;
    border: 2px solid #5c4033;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    flex-shrink: 0;
}
.territory-player-main {
    flex: 1;
    min-width: 140px;
}
.territory-player-name {
    font-family: 'Cinzel', Georgia, serif;
    font-weight: bold;
    font-size: 1.05rem;
    color: #e8dcc4;
    margin: 0 0 4px;
}
.territory-player-level-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}
.territory-player-level {
    font-size: 0.85rem;
    color: #d4a84b;
    font-weight: bold;
}
.territory-player-xp-wrap {
    flex: 1;
    min-width: 80px;
    max-width: 180px;
    height: 10px;
    background: #2c1810;
    border-radius: 5px;
    overflow: hidden;
    border: 1px solid #5c4033;
}
.territory-player-xp-fill {
    height: 100%;
    background: linear-gradient(90deg, #8b6914, #d4a84b);
    border-radius: 4px;
    transition: width 0.25s ease;
}
.territory-player-stats {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    font-size: 0.8rem;
    color: #c4b098;
}
.territory-player-stats span {
    white-space: nowrap;
}
.territory-player-stats strong { color: #d4a84b; margin-right: 2px; }
.territory-player-clan {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}
.territory-player-clan-flag {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #5c4033;
    flex-shrink: 0;
    background: #2c1810;
}
.territory-player-clan-flag-placeholder {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #2c1810;
    border: 2px solid #5c4033;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
}
.territory-player-clan-name {
    font-weight: bold;
    color: #d4a84b;
    font-size: 0.9rem;
}
.territory-player-clan-name a { color: #e8c86a; text-decoration: none; }
.territory-player-clan-name a:hover { text-decoration: underline; }
.territory-player-energy {
    font-weight: bold;
    color: #d4a84b;
    font-size: 0.9rem;
    white-space: nowrap;
}
#playerClanName { font-weight: bold; color: #d4a84b; }
#playerClanName a { color: #e8c86a; }
.territory-clan-pending-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    height: 22px;
    padding: 0 5px;
    background: #8b6914;
    color: #fff;
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: bold;
    text-decoration: none;
    margin-left: 6px;
    vertical-align: middle;
    box-shadow: 0 0 8px rgba(212,168,75,0.4);
    transition: background 0.2s, box-shadow 0.2s;
}
.territory-clan-pending-badge:hover {
    background: #a67c1a;
    box-shadow: 0 0 12px rgba(212,168,75,0.5);
    color: #fff;
}
.territory-registration-disabled {
    color: #b8a088;
    font-style: italic;
    padding: 10px 16px;
}
.territory-player-card .territory-registration-disabled { margin: 0; padding: 0; }

.territory-class-select label {
    font-size: 14px;
    color: #c4b098;
    font-family: 'Cinzel', Georgia, serif;
}

.territory-class-select select {
    padding: 10px 14px;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: linear-gradient(180deg, #3d2914 0%, #2c1810 100%);
    color: #e8dcc4;
    font-size: 14px;
    cursor: pointer;
    font-family: inherit;
    min-width: 160px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
}

.territory-class-select select:focus {
    outline: none;
    border-color: #8b6914;
}

/* –ö–∞—Ä—Ç–∞ ‚Äî —Å—Ç–∞—Ä–∏–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ω–∞ —Å—Ç–æ–ª–µ */
.map-wrap {
    position: relative;
    max-width: 920px;
    margin: 0 auto;
    background: linear-gradient(165deg, #5c4033 0%, #4a3520 30%, #3d2914 100%);
    border-radius: 6px;
    padding: 24px;
    border: 3px solid #2c1810;
    box-shadow: inset 0 0 0 1px rgba(212,168,75,0.2), 0 8px 32px rgba(0,0,0,0.5), 0 0 0 8px #2c1810;
}

.map-viewport {
    overflow: hidden;
    touch-action: none;
    user-select: none;
    cursor: grab;
    border-radius: 4px;
    min-height: 320px;
    border: 2px solid #3d2914;
    box-shadow: inset 0 0 40px rgba(0,0,0,0.3);
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.map-viewport:active,
.map-viewport.grabbing {
    cursor: grabbing;
}

.map-pan-zoom {
    display: inline-block;
    transform-origin: 0 0;
    transition: transform 0.05s ease-out;
}

.territory-map {
    display: block;
    width: 100%;
    height: auto;
    vertical-align: top;
}

.territory-map .region {
    cursor: pointer;
    transition: filter 0.2s, transform 0.15s;
}

.territory-map .region:hover {
    filter: brightness(1.12);
}

.territory-map .region:active {
    filter: brightness(1.25);
}

.territory-map .region-path {
    stroke: rgba(180,180,185,0.9);
    stroke-width: 2;
    fill: rgba(212,168,75,0.12);
}

.territory-map .region-path.owned {
    fill: var(--region-color, rgba(212,168,75,0.25));
}

.territory-map .region:hover .region-path {
    stroke: #d4a84b;
    stroke-width: 3;
}

.territory-map .region.region-inactive {
    pointer-events: none;
    cursor: default;
    opacity: 0.85;
}

.territory-map .region-path.region-locked {
    fill: url(#hatchLocked);
    stroke: #5c4033;
}
.territory-map .region.region-inactive:hover {
    filter: none;
}

/* –ö–ª–æ–Ω –æ–≤–µ—Ä–ª–µ—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ ‚Äî –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –æ–±–ª–∞—Å—Ç–µ–π, –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –º—ã—à—å */
.territory-map .region-overlay-hover-clone {
    pointer-events: none;
}

.territory-map .region-label-bg {
    fill: rgba(244,228,188,0.95);
    stroke: #5c4033;
    stroke-width: 1;
    rx: 3;
    ry: 3;
    pointer-events: none;
}

.territory-map .region-label {
    font-size: 9px;
    font-weight: bold;
    fill: #2c1810;
    text-anchor: middle;
    pointer-events: none;
    font-family: 'Cinzel', Georgia, serif;
}

.territory-map .region-strength-value-bg {
    fill: rgba(244,228,188,0.98);
    stroke: #5c4033;
    stroke-width: 1;
    rx: 3;
    ry: 3;
    pointer-events: none;
}

.territory-map .region-strength-value {
    font-size: 10px;
    font-weight: bold;
    fill: #2c1810;
    text-anchor: middle;
    pointer-events: none;
    font-family: 'Cinzel', Georgia, serif;
}

.territory-map .region-flag {
    pointer-events: none;
    stroke: #5c4033;
    stroke-width: 2;
}

.territory-map .region-strength-bar-bg {
    fill: rgba(0,0,0,0.4);
    rx: 3;
    pointer-events: none;
}

.territory-map .region-strength-bar {
    fill: #4ade80;
    rx: 3;
    transition: width 0.3s;
    pointer-events: none;
}

/* –ö–Ω–æ–ø–∫–∞ ¬´–û–ø–∏—Å–∞–Ω–∏–µ¬ª –Ω–∞–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ–±–ª–∞—Å—Ç–∏ */
.territory-map .region-info-btn {
    cursor: pointer;
    pointer-events: auto;
}
.territory-map .region-info-btn rect {
    fill: rgba(244,228,188,0.95);
    stroke: #5c4033;
    stroke-width: 1.5;
    transition: fill 0.2s;
}
.territory-map .region-info-btn:hover rect {
    fill: #d4a84b;
}
.territory-map .region-info-btn .region-info-book {
    font-size: 12px;
    text-anchor: middle;
    dominant-baseline: central;
    pointer-events: none;
}

/* –ü–æ–ø–∞–ø —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ–±–ª–∞—Å—Ç–∏ */
.territory-description-popover-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}
.territory-description-popover-overlay.show {
    display: flex;
}
.territory-description-popover {
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    border: 2px solid #5c4033;
    border-radius: 12px;
    padding: 20px 24px;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(212,168,75,0.15);
}
.territory-description-popover h4 {
    margin: 0 0 12px;
    font-family: 'Cinzel', Georgia, serif;
    font-size: 1rem;
    color: #d4a84b;
    letter-spacing: 0.04em;
}
.territory-description-popover p {
    margin: 0 0 16px;
    font-size: 14px;
    line-height: 1.5;
    color: #e8dcc4;
}
.territory-description-popover-close {
    display: block;
    margin: 0 0 0 auto;
    padding: 8px 20px;
    background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%);
    border: 1px solid #8b6914;
    border-radius: 6px;
    color: #d4a84b;
    font-weight: bold;
    cursor: pointer;
    font-family: 'Cinzel', Georgia, serif;
    font-size: 13px;
}
.territory-description-popover-close:hover {
    background: linear-gradient(145deg, #6b5040 0%, #5c4033 100%);
    color: #e8c86a;
}

/* –ó–∞–ø—Ä–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è/–≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏ */
.territory-task-content.no-copy {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–¥–∞–Ω–∏—è ‚Äî —Å–≤–∏—Ç–æ–∫/–ø–µ—Ä–≥–∞–º–µ–Ω—Ç */
.task-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s, visibility 0.25s;
}

.task-modal-overlay.open {
    opacity: 1;
    visibility: visible;
}

.task-modal {
    background: linear-gradient(180deg, #f4e4bc 0%, #e8d5a3 50%, #dcc898 100%);
    border-radius: 4px;
    max-width: 480px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 0 0 3px #5c4033, 0 12px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.4);
    border: 2px solid #3d2914;
    color: #2c1810;
}

.task-modal-header {
    padding: 20px 24px 14px;
    border-bottom: 2px solid #5c4033;
    background: linear-gradient(180deg, rgba(61,41,20,0.08) 0%, transparent 100%);
}

.task-modal-header h2 {
    margin: 0;
    font-size: 1.35rem;
    font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
    color: #3d2914;
    font-weight: 700;
}

.task-modal-body {
    padding: 20px 24px;
}

.task-modal-body .task-text {
    margin-bottom: 16px;
    line-height: 1.65;
    white-space: pre-wrap;
    color: #2c1810;
}

.task-modal-body .task-image {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin-bottom: 16px;
    border: 2px solid #5c4033;
}

.task-modal-body .task-answer-wrap {
    margin-top: 16px;
}

.task-modal-body .task-answer-wrap label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
    color: #3d2914;
}

.task-modal-body .task-answer-wrap input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #5c4033;
    border-radius: 4px;
    font-size: 16px;
    background: rgba(255,255,255,0.6);
    color: #2c1810;
    font-family: inherit;
}

.task-modal-body .task-answer-wrap input:focus {
    outline: none;
    border-color: #8b6914;
    box-shadow: 0 0 0 2px rgba(139,105,20,0.2);
}

.task-fraction-fields {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
}

.task-fraction-field {
    flex: 1;
    min-width: 80px;
}

.task-fraction-field label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.9em;
    color: #5c4033;
}

.task-fraction-field input {
    width: 100%;
    box-sizing: border-box;
}

/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥—Ä–æ–±–µ–π –≤ —É—Å–ª–æ–≤–∏–∏ (–∫–∞–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏) */
.task-text .mixed-frac,
.task-text .frac,
.task-text .frac-int-only {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
}
.task-text .frac-int {
    font-size: 1.1em;
    margin-right: 2px;
}
.task-text .frac {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    font-size: 1em;
}
.task-text .frac-num,
.task-text .frac-den {
    padding: 0 4px;
    line-height: 1.2;
}
.task-text .frac-line {
    display: block;
    width: 100%;
    min-width: 1.2em;
    height: 0;
    border-top: 1.5px solid #3d2914;
    margin: 1px 0;
}

/* –û—Ç–≤–µ—Ç-–¥—Ä–æ–±—å –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ: —Ü–µ–ª–∞—è —á–∞—Å—Ç—å + –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –¥—Ä–æ–±—å */
.task-answer-fraction-visual {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}
.task-answer-fraction-visual .answer-frac-wrap {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
}
.task-answer-fraction-visual .answer-frac-wrap input {
    width: 3em;
    text-align: center;
    padding: 4px 6px;
}
.task-answer-fraction-visual .answer-frac-line {
    width: 100%;
    height: 0;
    border-top: 2px solid #3d2914;
    margin: 2px 0;
}

/* –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ +/- —É –ø–æ–ª–µ–π —á–∏—Å–ª–∞ */
.task-modal input[type="number"]::-webkit-inner-spin-button,
.task-modal input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.task-modal input[type="number"] {
    -moz-appearance: textfield;
    appearance: textfield;
}

/* –î–≤–µ –¥—Ä–æ–±–∏: –¥—Ä–æ–±—å –∏–∑ —É—Å–ª–æ–≤–∏—è = –ø–æ–ª—è –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π –¥—Ä–æ–±–∏ */
.task-common-denom-visual { margin-top: 12px; }
.task-common-denom-row-eq {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}
.task-common-denom-row-eq:last-child { margin-bottom: 0; }
.task-common-denom-original {
    min-height: 2em;
    display: inline-flex;
    align-items: center;
}
.task-common-denom-eq {
    font-size: 1.4em;
    font-weight: bold;
    color: #3d2914;
}
.task-common-denom-visual .answer-frac-wrap {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
}
.task-common-denom-visual .answer-frac-wrap input {
    width: 3em;
    text-align: center;
    padding: 4px 6px;
}
.task-common-denom-visual .answer-frac-line {
    width: 100%;
    height: 0;
    border-top: 2px solid #3d2914;
    margin: 2px 0;
}

.task-mixed-fraction-display { margin-bottom: 10px; }
.task-add-sub-display .task-add-sub-op {
    margin: 0 6px;
    font-size: 1.2em;
    font-weight: bold;
    color: #3d2914;
    vertical-align: middle;
}
.task-mixed-fraction-display .task-text { display: inline; }
/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –¥—Ä–æ–±—å –≤ –±–ª–æ–∫–µ ¬´–î—Ä–æ–±—å: ‚Ä¶¬ª (—á–∏—Å–ª–∏—Ç–µ–ª—å, —á–µ—Ä—Ç–∞, –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å) */
.task-mixed-fraction-display .mixed-frac,
.task-mixed-fraction-display .frac,
.task-mixed-fraction-display .frac-int-only {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
}
.task-mixed-fraction-display .frac-int { font-size: 1.1em; margin-right: 2px; }
.task-mixed-fraction-display .frac {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    font-size: 1em;
}
.task-mixed-fraction-display .frac-num,
.task-mixed-fraction-display .frac-den { padding: 0 4px; line-height: 1.2; }
.task-mixed-fraction-display .frac-line {
    display: block;
    width: 100%;
    min-width: 1.2em;
    height: 0;
    border-top: 1.5px solid #3d2914;
    margin: 1px 0;
}
.task-mixed-fraction-fields {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}
.task-mixed-fraction-fields .answer-int-wrap input { width: 3em; text-align: center; }
.task-mixed-fraction-fields .answer-int-wrap input.task-int-part-disabled {
    background: #e8e0d4;
    color: #6b5b4a;
    cursor: not-allowed;
}
.task-mixed-fraction-fields .answer-frac-wrap input { width: 3em; text-align: center; padding: 4px 6px; }
.task-mixed-fraction-fields .answer-frac-line {
    width: 100%;
    height: 0;
    border-top: 2px solid #3d2914;
    margin: 2px 0;
}

.task-modal-footer {
    padding: 16px 24px 24px;
    border-top: 1px solid rgba(92,64,51,0.4);
}

.task-modal-footer .submit-task-btn {
    width: 100%;
    padding: 14px 24px;
    background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%);
    color: #d4a84b;
    border: 2px solid #3d2914;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    font-family: 'Cinzel', Georgia, serif;
    letter-spacing: 0.05em;
    transition: transform 0.1s, box-shadow 0.2s, color 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.task-modal-footer .submit-task-btn:hover {
    transform: translateY(-2px);
    color: #e8c86a;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
}

.task-modal-footer .submit-task-btn:active {
    transform: translateY(0);
}

.territory-confirm-wrap {
    display: none;
    position: absolute;
    left: 0;
    right: 0;
    bottom: 20px;
    padding: 0 16px;
    justify-content: center;
    pointer-events: none;
}
.territory-confirm-wrap.open {
    display: flex;
    pointer-events: auto;
}
.territory-confirm-box {
    background: linear-gradient(180deg, #f4e4bc 0%, #e8d5a3 100%);
    border-radius: 4px;
    padding: 22px 28px;
    box-shadow: 0 0 0 3px #5c4033, 0 8px 32px rgba(0,0,0,0.4);
    border: 2px solid #3d2914;
    max-width: 400px;
    width: 100%;
}
.territory-confirm-text {
    margin: 0 0 18px;
    font-size: 1.1rem;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
    color: #3d2914;
    text-align: center;
}
.territory-confirm-buttons {
    display: flex;
    gap: 14px;
    justify-content: center;
}
.territory-confirm-btn {
    padding: 12px 28px;
    border: 2px solid #5c4033;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    font-family: 'Cinzel', Georgia, serif;
    letter-spacing: 0.04em;
    transition: transform 0.1s, box-shadow 0.2s;
}
.territory-confirm-yes {
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.territory-confirm-yes:hover {
    transform: translateY(-2px);
    color: #e8c86a;
    box-shadow: 0 4px 14px rgba(0,0,0,0.4);
}
.territory-confirm-no {
    background: linear-gradient(180deg, #c4b098 0%, #a89070 100%);
    color: #2c1810;
    border-color: #5c4033;
}
.territory-confirm-no:hover {
    background: linear-gradient(180deg, #d4c0a8 0%, #b8a088 100%);
    transform: translateY(-1px);
}

.task-result-toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    padding: 14px 28px;
    border-radius: 4px;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
    z-index: 1001;
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
    border: 2px solid rgba(0,0,0,0.2);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.task-result-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.task-result-toast.correct {
    background: linear-gradient(145deg, #3d5c34 0%, #2d4a24 100%);
    color: #c8e0b8;
}

.task-result-toast.wrong {
    background: linear-gradient(145deg, #5c3434 0%, #4a2828 100%);
    color: #e8c0c0;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ¬´–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏¬ª */
.energy-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1002;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s, visibility 0.25s;
}
.energy-modal-overlay.open {
    opacity: 1;
    visibility: visible;
}
.energy-modal-box {
    background: linear-gradient(180deg, #f4e4bc 0%, #e8d5a3 100%);
    border-radius: 4px;
    padding: 24px 28px;
    max-width: 360px;
    width: 100%;
    box-shadow: 0 0 0 3px #5c4033, 0 12px 40px rgba(0,0,0,0.5);
    border: 2px solid #3d2914;
    color: #2c1810;
}
.energy-modal-box h3 {
    margin: 0 0 12px;
    font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
    font-size: 1.2rem;
    color: #3d2914;
    display: flex;
    align-items: center;
    gap: 8px;
}
.energy-modal-box p {
    margin: 0 0 20px;
    line-height: 1.5;
    color: #2c1810;
}
.energy-modal-box .energy-modal-ok {
    width: 100%;
    padding: 12px 24px;
    background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%);
    color: #d4a84b;
    border: 2px solid #3d2914;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    font-family: 'Cinzel', Georgia, serif;
    letter-spacing: 0.05em;
    transition: transform 0.1s, box-shadow 0.2s;
}
.energy-modal-box .energy-modal-ok:hover {
    transform: translateY(-2px);
    color: #e8c86a;
}

/* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ —Å –∫–ª–∞–Ω–æ–º */
.floating-chat-btn {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(145deg, #6b5344 0%, #5c4033 50%, #4a3520 100%);
    color: #e8dcc4;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 14px rgba(0,0,0,0.35), 0 0 0 1px rgba(212,168,75,0.2), inset 0 1px 0 rgba(255,255,255,0.08);
    z-index: 99990;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}
.floating-chat-btn:hover {
    background: linear-gradient(145deg, #7a6352 0%, #6b5344 100%);
    color: #e8c86a;
    transform: scale(1.08);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4), 0 0 0 1px rgba(212,168,75,0.35), inset 0 1px 0 rgba(255,255,255,0.12);
}
.floating-chat-btn:active { transform: scale(1.02); }

/* –ú–æ–¥–∞–ª–∫–∞ —á–∞—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–∏—Ç–≤—ã */
.clan-chat-modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    padding: 20px;
}
.clan-chat-modal-overlay.open {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}
.clan-chat-modal .modal-box {
    max-width: 380px;
    width: 100%;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.45), 0 0 0 1px rgba(92,64,51,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
    background: linear-gradient(180deg, #f5e8d0 0%, #e8dcc4 50%, #ddd0b8 100%);
    border: 2px solid #5c4033;
    color: #2c1810;
    position: relative;
}
.clan-chat-modal .modal-box h3 { margin: 0 0 12px; font-size: 1.05rem; color: #3d2914; font-family: 'Cinzel', Georgia, serif; }
.clan-chat-modal .clan-chat-modal-body { flex: 1; min-height: 0; overflow: hidden; }
.clan-chat-modal .clan-chat-content { display: flex; flex-direction: column; height: 100%; }
.clan-chat-modal .clan-chat-messages {
    max-height: 240px; min-height: 120px; overflow-y: auto; margin: 0 0 10px; padding: 10px;
    background: rgba(44,24,16,0.08); border-radius: 8px; border: 1px solid rgba(92,64,51,0.35);
    display: flex; flex-direction: column;
}
.clan-chat-modal .clan-chat-msg { padding: 8px 10px; margin-bottom: 8px; background: rgba(61,41,20,0.2); border-radius: 4px; border-left: 3px solid #8b6914; font-size: 0.95rem; max-width: 85%; }
.clan-chat-modal .clan-chat-msg-own { align-self: flex-end; border-left: none; border-right: 3px solid #d4a84b; text-align: right; background: rgba(90,60,30,0.25); }
.clan-chat-modal .clan-chat-msg .chat-author { font-weight: bold; color: #5c4033; margin-right: 8px; }
.clan-chat-modal .clan-chat-msg .chat-time { font-size: 0.8rem; color: #8b7355; margin-left: 6px; }
.clan-chat-modal .clan-chat-form { display: flex; gap: 10px; margin-top: 0; flex-shrink: 0; }
.clan-chat-modal .clan-chat-form input[type="text"] {
    flex: 1; min-width: 0; padding: 10px 14px; border: 2px solid #5c4033; border-radius: 6px; background: #fff; color: #2c1810; font-family: inherit;
}
.clan-chat-modal .clan-chat-form button {
    padding: 10px 18px; border-radius: 6px; border: 2px solid #5c4033; background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b; font-weight: bold; font-family: 'Cinzel', Georgia, serif; cursor: pointer;
}
.clan-chat-modal .clan-chat-form button:hover { color: #e8c86a; border-color: #8b6914; }
.clan-chat-modal .clan-chat-empty { color: #8b7355; padding: 12px; text-align: center; font-size: 0.95rem; }
.clan-chat-modal .modal-chat-close {
    position: absolute; top: 10px; right: 10px; width: 34px; height: 34px; padding: 0; border: none; border-radius: 50%;
    background: rgba(92,64,51,0.15); color: #5c4033; font-size: 1.25rem; cursor: pointer; line-height: 1;
}
.clan-chat-modal .modal-chat-close:hover { background: rgba(92,64,51,0.3); color: #3d2914; }

@media (max-width: 600px) {
    .territory-page { padding: 12px; }
    .territory-page h1 { font-size: 1.4rem; letter-spacing: 0.04em; }
    .territory-top-nav {
        flex-direction: column;
        margin-bottom: 12px;
        gap: 8px;
    }
    .territory-top-nav a {
        width: 100%;
        padding: 12px 16px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        box-sizing: border-box;
    }
    .territory-player-card {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px 14px;
        gap: 12px;
        margin-bottom: 16px;
    }
    .territory-player-main { min-width: 100%; }
    .territory-player-level-row { flex-wrap: wrap; }
    .territory-player-xp-wrap { max-width: 100%; min-width: 100px; }
    .territory-player-stats { gap: 10px; }
    .territory-player-clan {
        width: 100%;
        flex-wrap: wrap;
    }
    .territory-player-name { font-size: 1rem; }
    .territory-login-btn {
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .territory-map .region-label { font-size: 7px; }
    .global-class-name { min-width: 70px; }
    .global-progress { padding: 10px 14px; }
    .global-progress-title { font-size: 0.8rem; }
    .territory-confirm-wrap { padding: 0 12px; }
    .territory-confirm-box { max-width: 100%; padding: 18px 20px; }
    .territory-confirm-buttons {
        flex-direction: column;
        gap: 10px;
    }
    .territory-confirm-btn {
        width: 100%;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .task-modal { margin: 16px; max-height: calc(100vh - 32px); }
    .task-modal-footer .submit-task-btn { min-height: 44px; }
    .energy-modal-box { margin: 16px; max-width: calc(100% - 32px); }
    .energy-modal-box .energy-modal-ok { min-height: 44px; }
    .floating-chat-btn { bottom: 16px; right: 16px; width: 52px; height: 52px; font-size: 1.4rem; }
    .clan-chat-modal-overlay { padding: 12px; }
    .clan-chat-modal .modal-box { max-height: 80vh; padding: 14px; }
    .clan-chat-modal .clan-chat-messages { max-height: 200px; min-height: 100px; }
    .clan-chat-modal .modal-chat-close { top: 8px; right: 8px; width: 32px; height: 32px; }
}
</style>
{% endblock %}

{% block content %}
<div class="territory-page">
    <nav class="territory-top-nav">
        <a href="{{ url_for('territory_battle_rules') }}">–ö–∞–∫ –Ω–∞—á–∞—Ç—å?</a>
        <a href="{{ url_for('territory_clans_top') }}">–¢–æ–ø –∫–ª–∞–Ω–æ–≤</a>
        {% if user_logged_in %}
        <a href="{{ url_for('cabinet') }}">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        {% else %}
        <a href="{{ url_for('login') }}?next={{ url_for('territory_battle_page') | urlencode }}" class="territory-login-btn">–í–æ–π—Ç–∏</a>
        {% endif %}
    </nav>

    <h1>–ë–∏—Ç–≤–∞ –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</h1>

    {% if capture_enabled %}
    {% if capture_end_time_ms %}
    <div class="global-progress" id="battleEndCountdownBlock">
        <span class="global-progress-title">–î–æ –∫–æ–Ω—Ü–∞ –±–∏—Ç–≤—ã</span>
        <span id="battleEndCountdownDisplay" class="capture-countdown-value">--:--:--</span>
    </div>
    {% endif %}
    <div class="global-progress" id="globalProgressBlock">
        <div class="global-progress-title">–õ–∏–¥–∏—Ä—É–µ—Ç</div>
        <div id="globalProgressBars"></div>
    </div>
    {% else %}
    <div class="global-progress" id="captureCountdownBlock">
        <div class="global-progress-title">–î–æ —Å—Ç–∞—Ä—Ç–∞ –ë–∏—Ç–≤—ã –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</div>
        <div id="captureCountdownDisplay" class="capture-countdown-value">--:--:--</div>
        {% if not capture_start_time_iso %}
        <p class="capture-countdown-hint">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ —É–∫–∞–∑–∞–ª –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É.</p>
        {% endif %}
    </div>
    {% endif %}

    <div class="territory-player-card">
        {% if user_logged_in and (is_authenticated or (not capture_enabled and capture_start_time_iso)) %}
        {% if avatar_url %}
        <img src="{{ avatar_url }}" alt="" class="territory-player-avatar">
        {% else %}
        <div class="territory-player-avatar-placeholder">üë§</div>
        {% endif %}
        <div class="territory-player-main">
            <p class="territory-player-name">{{ current_user.character_name or current_user.username }}</p>
            <div class="territory-player-level-row">
                <span id="playerCardLevel" class="territory-player-level">–£—Ä. {{ current_user.level or 1 }}</span>
                <div id="playerCardXpWrap" class="territory-player-xp-wrap" title="–û–ø—ã—Ç: {{ current_user.xp_in_current_level }} / {{ current_user.xp_needed_for_next_level }}">
                    <div id="playerCardXpFill" class="territory-player-xp-fill" style="width: {{ ((current_user.xp_in_current_level / current_user.xp_needed_for_next_level * 100) if current_user.xp_needed_for_next_level else 100) | round(1) }}%;"></div>
                </div>
            </div>
            <div class="territory-player-stats">
                <span><strong>–ê—Ç–∞–∫–∞:</strong> <span id="playerCardDamage">{{ current_user.damage }}</span></span>
                <span><strong>–ó–∞—â–∏—Ç–∞:</strong> <span id="playerCardDefense">{{ current_user.defense }}</span></span>
                {% if current_energy is not none and energy_max is not none %}
                <span class="territory-player-energy" title="–≠–Ω–µ—Ä–≥–∏—è: 1 –∑–∞ –∑–∞–¥–∞—á—É. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω (+20% –æ—Ç –º–∞–∫—Å.).">‚ö° <span id="energyDisplay">{{ current_energy }}</span>/{{ energy_max }}</span>
                {% endif %}
            </div>
        </div>
        <div class="territory-player-clan">
            {% if current_user.clan_obj %}
            {% if clan_flag_url %}
            <img src="{{ clan_flag_url }}" alt="" class="territory-player-clan-flag">
            {% else %}
            <div class="territory-player-clan-flag-placeholder">‚öî</div>
            {% endif %}
            <span id="playerClanName" class="territory-player-clan-name">{{ current_user.clan_obj.name }}</span>
            {% if clan_pending_join_count and clan_pending_join_count > 0 %}
            <a href="{{ url_for('cabinet') }}#clan-join-requests" class="territory-clan-pending-badge" title="–ï—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –∫–ª–∞–Ω ({{ clan_pending_join_count }})">üì© {{ clan_pending_join_count }}</a>
            {% endif %}
            {% else %}
            <div class="territory-player-clan-flag-placeholder">‚Äî</div>
            <span id="playerClanName" class="territory-player-clan-name">–ù–µ—Ç –∫–ª–∞–Ω–∞. <a href="{{ url_for('cabinet') }}">–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –≤—Å—Ç—É–ø–∏—Ç—å</a></span>
            {% endif %}
        </div>
        {% elif user_logged_in and not registration_enabled %}
        <span class="territory-registration-disabled">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞</span>
        {% elif user_logged_in and not capture_enabled %}
        <span class="territory-registration-disabled">–ó–∞—Ö–≤–∞—Ç –æ–±–ª–∞—Å—Ç–µ–π –æ—Ç–∫–ª—é—á—ë–Ω</span>
        {% else %}
        <p class="territory-player-name" style="margin:0; flex:1;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</p>
        {% endif %}
    </div>

    <div class="map-wrap">
        <div class="map-viewport" id="mapViewport">
            <div class="map-pan-zoom" id="mapPanZoom">
        <svg class="territory-map" id="territoryMap" viewBox="0 0 615 396" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <linearGradient id="neutralGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#b8a088"/>
                    <stop offset="100%" style="stop-color:#8b7355"/>
                </linearGradient>
                <pattern id="hatchLocked" patternUnits="userSpaceOnUse" width="8" height="8" patternTransform="rotate(45)">
                    <line x1="0" y1="0" x2="0" y2="8" stroke="#5c4033" stroke-width="2"/>
                </pattern>
                <clipPath id="heraldryCircleClip" clipPathUnits="objectBoundingBox">
                    <circle cx="0.5" cy="0.5" r="0.5"/>
                </clipPath>
            </defs>
            <g id="regionsGroup">
                <g class="region" data-region-id="0" data-region-code="BG-01" data-region-name="Blagoevgrad">
                    <path id="BG-01" title="Blagoevgrad" class="region-path" d="M110.46,284.93L116.27,284.7L118.87,282.67L122.77,271.07L129.34,271.07L131.26,274.9L134.64,276.43L137.17,275.7L136.37,271.97L139.09,271.97L139.09,271.97L138.36,276.95L140.57,278.28L141.62,289.66L143.98,291.5L140.04,293.83L136.48,298.42L138.95,315.62L141.3,318.26L147.32,320.38L157.65,327.04L170.98,339.22L170.98,339.22L172.04,341.49L168.87,345.94L166.89,358.15L166.89,358.15L167.93,365.71L165.61,367.55L163.28,367.38L162.46,365.65L158.1,369.47L152.28,363.95L150.15,367.88L141.19,369.65L137.83,374.94L128.85,373.14L125.97,377.19L123.16,377.62L119.55,375.72L116.63,376.13L114.43,373.87L105.72,373.67L102.42,374.26L96.39,379.04L94.4,374.49L90.6,374.42L85.64,377.7L85.5,381.18L83.13,384.34L76.5,385.82L71.21,385.69L65.67,383.05L57.05,382.48L59.54,380.39L59.72,375.24L58.3,372.16L60.91,368.44L58.93,362.15L60.32,353.42L58.31,350.06L57.89,344.12L58.93,342.35L61.44,342.17L62.28,338.92L66.24,333.91L63.92,326.6L59.48,325.67L56.77,316.1L54.75,312.31L53.42,312.2L52.68,307.11L50.72,304.47L50.17,294.19L50.17,294.19L54.09,292.3L56.18,282.69L58.06,281.32L60.54,287.31L64.29,287.14L66.54,290.08L76.01,287.7L82.06,283L97.71,287.38L100.75,289.57L107.43,287.76z"/>
                </g>
                <g class="region" data-region-id="1" data-region-code="BG-02" data-region-name="Burgas">
                    <path id="BG-02" title="Burgas" class="region-path" d="M464.56,172.77l5.98,-3.33l9.9,0.96l14.42,9.93l5.57,-0.69l2.35,1.6l4.41,-2.99l14.65,1.31l2.27,0.79l-0.27,2.62l4.94,2.9l4.1,1.02l7.91,-1.33l0,0l1.76,8.65l-1.13,2.86l0.88,6.68l-16.67,-1.01l-1.6,4.41l2.99,2.11l-2.1,0.16l-0.85,1.67l-1.83,-0.77l-1.49,1.92l-2.85,-0.3l-1.37,2.07l-0.06,5.94l1.64,3.11l-3.31,-1.38l-3.27,0.13l-2.38,1.76l-3.98,-0.62l-2.72,3.68l-0.71,5.73l-2.59,-0.49l-0.87,3.33l1.67,1.68l0.29,3.19l1.07,-4.77l3.57,4.31l2.35,-3.69l3.92,1.47l0.61,-2.29l2.35,2.44l1.6,-0.36l0.17,-1.55l0.95,1.47l1.39,-0.32l-0.59,3.62l1.45,1.56l1.5,0.3l2.28,-2.34l0.61,2.25l2.39,-0.1l-2.05,1.73l1.51,2.54l-1.14,2.02l2.51,4.46l4.69,-0.92l-1.27,2.02l2.1,1.79l-3.78,2.65l1.02,2.89l-1.24,0.36l0.01,1.9l8.43,7.31l1.92,2.61l-0.57,1l4.18,3.09l1.84,4.16l3.16,0.92l2.17,5.47l2.22,0.09l4.25,10.11l-2.54,0.73l-3.04,-1.47l-1.67,1.69l-2.52,-1.04l-2.16,1.63l-1.18,-2.6l-3.89,-1.77l-0.39,1.89l-0.45,-1.47l-0.63,1.61l-1.35,-1l-1.17,1.54l1.62,5.05l-2.02,-0.8l-0.01,1.55l-1.15,-1.4h-2.41l0.69,-1.47l-4.13,-0.51l-0.53,-1.52l-3.81,0.22l0.47,0.91l-1.75,-0.06l-1.3,2.07l-4.85,-0.5l0.73,1.1l-1.43,1.31l-0.92,-0.92l-1.58,2.12l-1.43,-0.77l0.18,2.28l-1.32,0.59l0.95,1.19l-1.13,0.24l-5.06,-7.18l-3.96,0.04l-3.76,-4.24l-3.85,-1.82l-2.57,-6.67l-3.11,-0.41l-0.98,-2.76l-3.25,-2.23l-5.14,-1.02l-1.77,0.87l-2.28,2.51l0.3,2.56l-1.96,-1.37l-4.84,0.39l-2.25,-2.51l-4.01,-0.91l-2.98,1.34l0,0l-10.04,-9.61l-0.34,-2.12l2.79,-3.29l-2.48,-6.2l1.59,-5.05l-7.85,-8.84l-0.97,-4.24l1.28,-1.52l7.2,-1.23l1.91,-4.77l-7.05,-0.56l-12.68,-24.5l-8.22,-9.35l0,0l0.37,-3.62l-2.91,-5.52l-5.35,-1.74l-2.73,-3.35l1.1,-5.93l-1.54,-9.64l-3.11,-0.05l0,0l6.25,-0.24l0.51,3.94l7.6,-0.07l6.32,-4.47l8.04,-0.36l3.91,1.64l5.55,-1.09l5.04,3.78l7.24,-3.89L464.56,172.77z"/>
                </g>
                <g class="region" data-region-id="2" data-region-code="BG-03" data-region-name="Varna">
                    <path id="BG-03" title="Varna" class="region-path" d="M496.07,84.94L501.75,90.49L503.4,97.06L505.8,97L511.6,92.28L513.68,92.01L515.52,93.66L515.55,98.79L520.72,101.39L526.02,101.14L538.27,116.97L544.01,111.29L548.13,111.5L557.7,122.48L557.7,122.48L552.81,134.38L546.7,135.6L544.67,138.76L543.03,137.83L544.17,138.25L543.99,140.67L547.08,141.43L543.77,155.58L541.44,158.72L543.04,173.23L542.7,183.12L540.79,185.54L540.79,185.54L532.88,186.87L528.78,185.85L523.84,182.95L524.11,180.33L521.84,179.54L507.19,178.24L502.77,181.23L500.43,179.64L494.86,180.33L480.44,170.4L470.54,169.44L464.56,172.77L464.56,172.77L464.84,168.86L459.81,163.28L462.49,160.74L476.03,157.85L474.47,149.1L472,146.4L473,142.59L481.98,137.29L478.44,123.29L478.89,122.1L481.64,122.98L483.56,121.26L482.55,110.43L487.64,102.71L487.18,100.94L485.3,100.53L487.22,95.5L484.57,94.32L484.58,90.78L494.11,87.74z"/>
                </g>
                <g class="region" data-region-id="3" data-region-code="BG-04" data-region-name="Veliko Tarnovo">
                    <path id="BG-04" title="Veliko Tarnovo" class="region-path" d="M296.17,81.02L302.22,79.69L302.22,79.69L304.55,81.61L307.08,80.42L307.43,82.81L305.51,86.64L309.15,95.84L314.31,100.73L312.85,106.98L322.69,112.36L327.17,109.8L334.51,115.03L339.06,114.79L344.8,117.05L349.39,115.19L351.27,119.65L356.25,120.77L356.25,120.77L362.89,127.13L361.94,130.03L367.25,137.02L367.2,138.74L364.09,140.91L362.17,147.06L362.61,157.19L366.89,161.72L363.17,166.54L374.32,170.45L374.32,170.45L371.68,174.47L360.23,180.55L360.54,186.15L353.72,191.57L348.11,190.1L342.28,191.54L337.03,190.57L337.03,190.57L330.4,190.14L321.01,194.5L321.01,194.5L318.08,192.18L315.86,185.98L319.74,182.42L320.08,180.37L318.05,179.37L317.98,175.74L313.75,175.2L311.75,173.06L311.84,168.33L315.86,164.48L315.22,161.65L308.62,158.38L302.36,157.03L299.07,157.74L296.62,155.63L289.6,155.98L288.84,153.95L290.19,149.72L289.16,148.45L281.44,150.77L275.21,149.16L269.09,143.12L268.57,139.22L268.57,139.22L271.99,138.62L272.1,134.78L274.92,130.59L275.16,127.13L275.16,127.13L282.35,119.81L283.4,116.29L282.61,114.18L278.72,113.42L279.79,106.79L272.87,107.54L271.58,105.46L272.68,103.64L279.24,100.63L280.57,92.28L278.14,88.25L279.83,81.87L278.65,77.84L284.39,73.04L284.39,73.04L292.46,79.92z"/>
                </g>
                <g class="region" data-region-id="4" data-region-code="BG-05" data-region-name="Vidin">
                    <path id="BG-05" title="Vidin" class="region-path" d="M31.51,0.53L38.02,2.46L44.08,8.2L55.14,15.21L65.43,17.05L66.9,18.35L67.32,22.19L63.94,27.89L56.18,29.19L51.33,32.4L47.37,45.46L48.88,50.13L50.95,52.05L68.24,57.25L68.24,57.25L66.43,59.45L58.41,60.49L58.78,63.33L67.25,66.58L68.37,70.04L55.59,75.78L51.51,86.44L47.97,89.99L44.95,97.08L40.62,99.91L40.16,106.09L36.53,111.36L36.53,111.36L31.57,111.08L29.66,106.7L23.73,105.5L21.53,101.92L17.46,100.85L12.88,88.36L13.35,83.31L11.97,80.47L13.11,78.13L4.94,70.35L3.64,65.96L4.27,62.03L0,54.91L2.8,47.04L3.02,39.37L4.92,37.59L5.13,28.83L8.52,27.08L16.83,26.62L18.26,24.76L17.27,22.4L25.84,20.74L24.82,14.79L26.57,7.9L25.12,6.86L27.25,5.51L26.48,4.34L27.7,4.11L28.15,0.99z"/>
                </g>
                <g class="region" data-region-id="5" data-region-code="BG-06" data-region-name="Vratsa">
                    <path id="BG-06" title="Vratsa" class="region-path" d="M153.45,63.94L158.17,64.22L177.83,72.49L194.55,70.41L194.55,70.41L192.44,79.94L190.78,78.88L190.41,80.9L188.6,78.34L186.86,78.45L181.16,85.7L177.93,84.4L176.56,85.2L178.33,98.13L185.28,101.07L183.66,107.91L173.32,109.21L171.51,114.44L160.55,115.41L158.19,117.15L156.37,132.4L158.44,134.41L162.48,133.15L164.48,135.54L164.48,135.54L165.44,148.15L160.01,148.14L160.11,154.8L160.11,154.8L159.13,158.81L154.33,156.37L144.75,156.11L142.2,154.22L132.85,158.51L127.81,156.11L118.03,164.73L115.38,163L109.48,154L108.63,148.88L112.22,142.27L103.59,140.83L103.59,140.83L102.5,135.57L103.9,133.85L107.6,133.9L107.84,130.43L104.52,128.2L97.7,126.78L95.26,123.56L100.57,118.19L104.39,110.79L103.8,103.97L107.67,97.7L109.52,96.81L117.84,98.54L120.53,94.36L125.15,94.36L124.49,91.05L119.7,86.25L126.06,74.77L125.37,57.59L125.37,57.59L134.43,56.1L146.09,62.22z"/>
                </g>
                <g class="region" data-region-id="6" data-region-code="BG-07" data-region-name="Gabrovo">
                    <path id="BG-07" title="Gabrovo" class="region-path" d="M268.57,139.22L269.09,143.12L275.21,149.16L281.44,150.77L289.16,148.45L290.19,149.72L288.84,153.95L289.6,155.98L296.62,155.63L299.07,157.74L302.36,157.03L308.62,158.38L315.22,161.65L315.86,164.48L311.84,168.33L311.75,173.06L313.75,175.2L317.98,175.74L318.05,179.37L320.08,180.37L319.74,182.42L315.86,185.98L318.08,192.18L321.01,194.5L321.01,194.5L320.82,196.16L318.49,197.12L315.26,194.32L310.52,196.71L306.97,195.91L304.09,192.99L300.95,192.75L301.38,196.37L300.22,197.4L288.3,194.1L284.6,194.66L278.36,190.89L267.78,195.86L260.59,194.95L260.59,194.95L261.11,190.86L258.28,185.28L253.76,179.22L248.82,176.83L247.11,167.1L250.04,160.78L254.51,159.2L253.53,149.48L257.34,145.27L257.06,136.32z"/>
                </g>
                <g class="region" data-region-id="7" data-region-code="BG-08" data-region-name="Dobrich">
                    <path id="BG-08" title="Dobrich" class="region-path" d="M547.41,34.92L551.69,50.6L563.23,56.6L575.43,62.06L586.26,62.88L595.98,65.41L608.99,64.71L608.93,69.27L607.52,71.52L609.02,78.17L608.01,83.27L612,91.29L606.7,103.68L601.01,108.86L597.98,115.48L596.15,112.63L585.1,107.97L571.74,110.48L567.54,109.4L561.15,113.68L557.7,122.48L557.7,122.48L548.13,111.5L544.01,111.29L538.27,116.97L526.02,101.14L520.72,101.39L515.55,98.79L515.52,93.66L513.68,92.01L511.6,92.28L505.8,97L503.4,97.06L501.75,90.49L496.07,84.94L496.07,84.94L493.48,80.19L486.53,84.24L485.03,83.66L480.77,77.73L476.25,77.1L473.76,74.14L473.76,74.14L475.67,73.06L474.6,66.94L481.56,58.99L487.26,57.79L496.97,48.64L500.19,50.71L502.18,50.34L507.16,41.78L509.62,44.42L512.67,44.8L512.68,42.02L516.41,36.67L523.37,33.31L523.37,33.31L526.43,35.63L537.08,33.9L544.19,28.26L546.84,31.54z"/>
                </g>
                <g class="region" data-region-id="8" data-region-code="BG-09" data-region-name="Kardzhali">
                    <path id="BG-09" title="Kardzhali" class="region-path" d="M286.57,304.32L285.25,308.75L288.36,321.05L293.88,315.9L296.23,321.54L303.61,325.71L312.09,328.32L318.01,326.57L320.22,329.35L323.19,339.41L321.81,343.93L322.83,346.51L325.22,344.98L328.96,346.64L334.46,341.67L340.3,342.45L341.95,347.79L337.76,351.06L335.95,359.79L341.14,363.98L340.49,370.71L348.95,378.77L350.44,384.75L350.44,384.75L345.26,386.74L343.88,385.65L344.07,383.71L339.39,381.3L334.95,384.61L329.24,385.08L327.96,388.48L323.13,385.56L318.74,386.84L313.63,385.13L310.65,390.31L305.23,388.94L300.53,391.88L294.62,392.52L291.51,394.91L287.9,394.37L286.64,395.74L281.47,394.16L280.39,389.9L275.29,385.67L275.29,385.67L275.61,383.38L273.58,382.32L272.4,376.57L276.15,371.75L273.13,370.45L274.44,365.84L273.74,363.38L270.01,360.79L264.47,363.45L259.42,361.57L257.57,353.43L258.4,350.21L265.56,347.59L267.66,345.14L268.68,334.25L266.19,324.06L266.19,324.06L271.97,319.4L277.29,309.82z"/>
                </g>
                <g class="region" data-region-id="9" data-region-code="BG-10" data-region-name="Kyustendil">
                    <path id="BG-10" title="Kyustendil" class="region-path" d="M11.5,206.57L15.51,209.92L21.45,211.89L25.06,221.38L30.66,224.35L31.08,230.67L35.29,237.31L36.53,241.88L42.23,242.9L44.34,246.06L47.19,246.06L47.62,248.76L50.61,247.06L54.77,249.53L56.03,245.87L59.36,244.73L61.55,241.95L68.33,246.24L71.45,245.71L74.53,241.8L75.59,246.17L81.29,249.43L84.4,249.87L87.38,247.61L87.38,247.61L95.8,249.24L98.1,256.32L104.65,261.63L104.65,262.99L99.75,264.81L97.27,270.74L99.15,272.32L105.73,270.15L107.44,275.78L114.55,278.83L114.34,281.23L110.46,284.93L110.46,284.93L107.43,287.76L100.75,289.57L97.71,287.38L82.06,283L76.01,287.7L66.54,290.08L64.29,287.14L60.54,287.31L58.06,281.32L56.18,282.69L54.09,292.3L50.17,294.19L50.17,294.19L48.54,292.79L45.87,293.23L43.42,290.16L41.16,291.15L37.03,290.07L35.07,287.32L31.2,287.63L20.62,280.78L15.3,276.15L14.27,270.7L11.15,269.62L9.07,264.19L0.46,254.88L4.76,252.49L7.48,253.54L9.38,252.22L11.87,244.29L15.9,243.61L19.66,232.88L16.05,226.69L11.02,222.14L7.94,221.41z"/>
                </g>
                <g class="region" data-region-id="10" data-region-code="BG-11" data-region-name="Lovech">
                    <path id="BG-11" title="Lovech" class="region-path" d="M164.48,135.54L171.48,134.22L177.98,130.81L184.34,132.47L190.44,131.85L196.32,130.03L199.69,126.43L200.83,128.58L203.65,129.2L207.05,132.49L224.53,134.73L225.64,127.62L228.8,131.09L231.22,126.68L239.7,121.35L244.28,121.59L251.56,125.09L256.61,123.41L260.29,119.82L262.78,114.31L264.29,114.82L267.38,122.54L275.16,127.13L275.16,127.13L274.92,130.59L272.1,134.78L271.99,138.62L268.57,139.22L268.57,139.22L257.06,136.32L257.34,145.27L253.53,149.48L254.51,159.2L250.04,160.78L247.11,167.1L248.82,176.83L253.76,179.22L258.28,185.28L261.11,190.86L260.59,194.95L260.59,194.95L250.89,199.22L244.69,197.36L235.51,198.88L232.86,198.11L230.55,193.74L226.33,190.42L213.56,188.91L209.86,193.47L200.58,193.64L200.58,193.64L190.69,190.79L178.32,189.94L182.36,183.1L179.75,181.14L179.37,176.4L176.24,174.19L179.37,171.03L172.53,167.37L171.67,161.09L166.78,158.65L166.2,155.11L160.11,154.8L160.11,154.8L160.01,148.14L165.44,148.15z"/>
                </g>
                <g class="region" data-region-id="11" data-region-code="BG-12" data-region-name="Montana">
                    <path id="BG-12" title="Montana" class="region-path" d="M104.79,49.8L113.34,52.03L120.04,57.1L125.37,57.59L125.37,57.59L126.06,74.77L119.7,86.25L124.49,91.05L125.15,94.36L120.53,94.36L117.84,98.54L109.52,96.81L107.67,97.7L103.8,103.97L104.39,110.79L100.57,118.19L95.26,123.56L97.7,126.78L104.52,128.2L107.84,130.43L107.6,133.9L103.9,133.85L102.5,135.57L103.59,140.83L103.59,140.83L97.19,140.46L92.8,145.21L73.32,146.55L61.53,135.25L56.98,136.58L56.98,136.58L52.88,133.65L50.08,128.2L48.15,127.04L45.99,119.67L36.53,111.36L36.53,111.36L40.16,106.09L40.62,99.91L44.95,97.08L47.97,89.99L51.51,86.44L55.59,75.78L68.37,70.04L67.25,66.58L58.78,63.33L58.41,60.49L66.43,59.45L68.24,57.25L68.24,57.25L77.03,55.67L89.61,50.41z"/>
                </g>
                <g class="region" data-region-id="12" data-region-code="BG-13" data-region-name="Pazardzhik">
                    <path id="BG-13" title="Pazardzhik" class="region-path" d="M139.09,271.97L146.85,265.99L151.99,259.18L154.17,261.92L157.36,260.21L155.89,255.54L157.89,249.35L165.04,246.35L168.73,238.61L167.27,235.4L162.23,237.58L158.68,236.54L154.93,230.6L154.13,221.49L159.92,220.21L166.31,223.16L172.35,216.62L177.1,216.71L178.2,211.79L187.04,209.43L193.17,211.85L196.33,221.54L199.21,219.84L201.76,222.22L201.76,222.22L201.16,226.88L197.93,230.28L197.38,232.94L201.57,246.07L206.11,251L206.3,255.01L204.43,256.54L206.15,267.41L211.4,276.62L210.66,277.86L205.59,278.89L204.06,287.59L204.69,297.46L202.15,305.38L202.15,305.38L200.83,312.3L194.94,315.88L192.55,319.09L192.77,327.6L186.92,331.48L181.05,330.01L172.19,331.22L170.98,339.22L170.98,339.22L157.65,327.04L147.32,320.38L141.3,318.26L138.95,315.62L136.48,298.42L140.04,293.83L143.98,291.5L141.62,289.66L140.57,278.28L138.36,276.95z"/>
                </g>
                <g class="region" data-region-id="13" data-region-code="BG-14" data-region-name="Pernik">
                    <path id="BG-14" title="Pernik" class="region-path" d="M26.02,178.08L31.68,181.57L33.29,179.33L37.57,179.17L38.85,177.91L38.85,177.91L40.63,182.38L44.64,182.1L47.82,187.31L59.74,191.47L61.72,194.61L67.06,196.91L68.41,199.04L68.41,199.04L74.73,206.45L78.72,208.89L79.89,215.33L78.94,217.53L83.46,218.31L87.25,223.99L89.84,223.45L90.09,225.09L90.09,225.09L86.24,234.27L87.38,247.61L87.38,247.61L84.4,249.87L81.29,249.43L75.59,246.17L74.53,241.8L71.45,245.71L68.33,246.24L61.55,241.95L59.36,244.73L56.03,245.87L54.77,249.53L50.61,247.06L47.62,248.76L47.19,246.06L44.34,246.06L42.23,242.9L36.53,241.88L35.29,237.31L31.08,230.67L30.66,224.35L25.06,221.38L21.45,211.89L15.51,209.92L11.5,206.57L11.5,206.57L10.1,205.24L13.81,200.77L14.1,198.38L10.25,193.48L8.28,187.34L14.68,183.8L17.33,179.77L21.25,181.94L22.22,178.27z"/>
                </g>
                <g class="region" data-region-id="14" data-region-code="BG-15" data-region-name="Pleven">
                    <path id="BG-15" title="Pleven" class="region-path" d="M232.65,72.26L239.76,68.77L247.56,69.31L254.89,66.18L258.67,66.51L264.29,71.19L268.58,72.23L276.7,70.31L284.39,73.04L284.39,73.04L278.65,77.84L279.83,81.87L278.14,88.25L280.57,92.28L279.24,100.63L272.68,103.64L271.58,105.46L272.87,107.54L279.79,106.79L278.72,113.42L282.61,114.18L283.4,116.29L282.35,119.81L275.16,127.13L275.16,127.13L267.38,122.54L264.29,114.82L262.78,114.31L260.29,119.82L256.61,123.41L251.56,125.09L244.28,121.59L239.7,121.35L231.22,126.68L228.8,131.09L225.64,127.62L224.53,134.73L207.05,132.49L203.65,129.2L200.83,128.58L199.69,126.43L196.32,130.03L190.44,131.85L184.34,132.47L177.98,130.81L171.48,134.22L164.48,135.54L164.48,135.54L162.48,133.15L158.44,134.41L156.37,132.4L158.19,117.15L160.55,115.41L171.51,114.44L173.32,109.21L183.66,107.91L185.28,101.07L178.33,98.13L176.56,85.2L177.93,84.4L181.16,85.7L186.86,78.45L188.6,78.34L190.41,80.9L190.78,78.88L192.44,79.94L194.55,70.41L194.55,70.41L200.5,65.3L210.8,61.67L222.37,64.45L228.35,70.24z"/>
                </g>
                <g class="region" data-region-id="15" data-region-code="BG-16" data-region-name="Plovdiv">
                    <path id="BG-16" title="Plovdiv" class="region-path" d="M200.58,193.64L209.86,193.47L213.56,188.91L226.33,190.42L230.55,193.74L232.86,198.11L235.51,198.88L244.69,197.36L250.89,199.22L260.59,194.95L260.59,194.95L260.59,194.95L260.59,194.95L259.57,197.3L260.02,209.06L256.84,216.14L258.61,223.64L261.6,228.9L265.04,230.28L275.48,226.71L277.8,230.24L277.4,232.79L273.25,236.98L276.12,243.31L272.01,242.32L271.3,243.92L271.29,256.12L275.89,259.56L265.98,263.84L265.36,272.4L272.44,276.35L281.86,274.8L285.68,272.33L292.69,280.36L292.69,280.36L288.71,290.7L289.13,301.16L286.57,304.32L286.57,304.32L277.29,309.82L271.97,319.4L266.19,324.06L266.19,324.06L260.27,318.23L258.41,319.9L258.11,326.49L254.34,330.86L247.46,330.65L241.3,337.61L238.25,331.03L239.57,326.07L238.21,323.73L236.63,325.07L235.3,322.62L237.71,315.61L235.63,311.48L225.23,309.92L213.83,313.12L209.11,306.98L206.42,307.27L202.15,305.38L202.15,305.38L204.69,297.46L204.06,287.59L205.59,278.89L210.66,277.86L211.4,276.62L206.15,267.41L204.43,256.54L206.3,255.01L206.11,251L201.57,246.07L197.38,232.94L197.93,230.28L201.16,226.88L201.76,222.22L201.76,222.22L207.52,221.21L209.89,215.11L204.82,210.07L197.01,205.76L196.65,202.64z"/>
                </g>
                <g class="region" data-region-id="16" data-region-code="BG-17" data-region-name="Razgrad">
                    <path id="BG-17" title="Razgrad" class="region-path" d="M392.44,37.78L401.65,38.34L404,42.12L410.73,41.32L413.23,44.63L414.02,48.96L426.77,52.75L429.42,52.15L430.69,54.37L435,50.91L438.77,55.52L443.18,56.89L446.02,62.22L449.53,62.6L450.9,66.68L455.07,70.56L455.07,70.56L456,75.17L454.53,77.38L450.24,79.5L447.02,83.57L441.31,81.95L440.37,86.18L434.65,91.04L434.96,97.09L428.44,103.39L428.76,106.9L433.62,111.1L429.37,115.46L429.37,115.46L424.09,115.88L422.1,114.23L419.85,118.64L414.2,118.1L408.8,115.74L403.98,117.92L401.01,117.39L401.34,119.47L397.35,124.82L397.17,127.43L393.03,129.42L391.86,127.5L393.22,124.87L391.93,122.85L388.77,121.73L388.06,119.33L397.88,111.46L398.46,105.13L393.16,103.86L390.68,97.51L386.64,96.63L380.01,90.11L376.73,90.76L374.46,93.92L367.22,94.01L365.45,92.81L365.45,92.81L361.91,85.88L362.31,82.56L368.93,80.83L373.25,75.56L376.96,76.39L383.96,81.72L392.54,78.87L398.05,80.12L403.95,79.39L407.2,74.41L407.19,67.59L403.6,61.84L399.62,61.11L395.96,57.87L392.76,59.41L391.97,58.14L387.53,58.87L382.56,57.16L382.63,54.17L386.29,51.29L389.18,42.47z"/>
                </g>
                <g class="region" data-region-id="17" data-region-code="BG-18" data-region-name="Ruse">
                    <path id="BG-18" title="Ruse" class="region-path" d="M389.17,25.11L390.3,29.57L394.44,33.6L392.44,37.78L392.44,37.78L389.18,42.47L386.29,51.29L382.63,54.17L382.56,57.16L387.53,58.87L391.97,58.14L392.76,59.41L395.96,57.87L399.62,61.11L403.6,61.84L407.19,67.59L407.2,74.41L403.95,79.39L398.05,80.12L392.54,78.87L383.96,81.72L376.96,76.39L373.25,75.56L368.93,80.83L362.31,82.56L361.91,85.88L365.45,92.81L365.45,92.81L359.13,95.84L357.44,104.4L351.74,111.69L356.69,115.91L356.25,120.77L356.25,120.77L351.27,119.65L349.39,115.19L344.8,117.05L339.06,114.79L334.51,115.03L327.17,109.8L322.69,112.36L312.85,106.98L314.31,100.73L309.15,95.84L305.51,86.64L307.43,82.81L307.08,80.42L304.55,81.61L302.22,79.69L302.22,79.69L306.04,77.78L313.34,77.65L323.26,71.63L330.21,71.4L335.32,68.67L338.11,63.75L344.66,59.36L351.99,48.15L362.15,41.91L367.15,33.81L371.17,31.33L376.32,31.32z"/>
                </g>
                <g class="region" data-region-id="18" data-region-code="BG-19" data-region-name="Silistra">
                    <path id="BG-19" title="Silistra" class="region-path" d="M463.76,11.04L467.1,10.78L474.46,13.88L481.07,12.8L483.09,19.87L489.52,22.21L493.77,28.31L500.83,26.94L514.47,28.26L517.6,23.43L520.48,25.83L523.37,33.31L523.37,33.31L516.41,36.67L512.68,42.02L512.67,44.8L509.62,44.42L507.16,41.78L502.18,50.34L500.19,50.71L496.97,48.64L487.26,57.79L481.56,58.99L474.6,66.94L475.67,73.06L473.76,74.14L473.76,74.14L469.47,74.31L463.96,67.51L455.07,70.56L455.07,70.56L450.9,66.68L449.53,62.6L446.02,62.22L443.18,56.89L438.77,55.52L435,50.91L430.69,54.37L429.42,52.15L426.77,52.75L414.02,48.96L413.23,44.63L410.73,41.32L404,42.12L401.65,38.34L392.44,37.78L392.44,37.78L394.44,33.6L390.3,29.57L389.17,25.11L389.17,25.11L394.01,23.78L399.88,24.93L408.98,22.42L415.22,22.8L424.33,19.61L430.71,19.4L445.36,11.87L453.53,11.64L460.66,9.51z"/>
                </g>
                <g class="region" data-region-id="19" data-region-code="BG-20" data-region-name="Sliven">
                    <path id="BG-20" title="Sliven" class="region-path" d="M374.32,170.45L379.3,166.2L381.27,160.37L386.44,159.34L387.5,164.2L390.03,161.81L394.85,164.7L404.75,162.61L414.85,164.16L414.85,164.16L408.43,169.84L407.88,172.66L409.08,174.11L409.08,174.11L412.19,174.17L413.73,183.8L412.63,189.73L415.36,193.08L420.72,194.82L423.62,200.34L423.25,203.97L423.25,203.97L420.67,202.81L422.55,207.27L422.52,211.26L419.63,214.87L417.53,212.56L414.69,217.12L409.85,217.61L401.08,223.09L395.61,222.19L391.64,225.46L393.54,226.76L393.88,228.94L389.35,233.87L385.25,234.4L383.79,236.41L377.03,234.54L375.71,235.37L375.98,241.3L371.85,239.74L374.07,244.66L378.28,241.13L379.12,242.78L378.49,250.85L372.71,263.75L372.71,263.75L362.45,257.6L358.76,260.09L358.73,258.08L350.36,252.6L347.55,242.93L343.79,238.35L346.19,232.49L342.62,224.22L345.65,217.69L342.61,212.58L341.43,205.48L337.41,197.46L337.03,190.57L337.03,190.57L342.28,191.54L348.11,190.1L353.72,191.57L360.54,186.15L360.23,180.55L371.68,174.47z"/>
                </g>
                <g class="region" data-region-id="20" data-region-code="BG-21" data-region-name="Smolyan">
                    <path id="BG-21" title="Smolyan" class="region-path" d="M202.15,305.38L206.42,307.27L209.11,306.98L213.83,313.12L225.23,309.92L235.63,311.48L237.71,315.61L235.3,322.62L236.63,325.07L238.21,323.73L239.57,326.07L238.25,331.03L241.3,337.61L247.46,330.65L254.34,330.86L258.11,326.49L258.41,319.9L260.27,318.23L266.19,324.06L266.19,324.06L268.68,334.25L267.66,345.14L265.56,347.59L258.4,350.21L257.57,353.43L259.42,361.57L264.47,363.45L270.01,360.79L273.74,363.38L274.44,365.84L273.13,370.45L276.15,371.75L272.4,376.57L273.58,382.32L275.61,383.38L275.29,385.67L275.29,385.67L270.04,382.22L266.34,382.09L264,379.02L253.01,376.23L250.21,373.44L246.32,375.58L240.92,374.37L240.67,380.3L239.32,381.36L233.8,376.88L232.15,372.42L227.66,371.24L225.25,372.25L224.87,369.91L220.54,371.04L219.19,366.1L216.88,364.59L215.6,361.1L214.98,354.92L212.41,352.65L207.26,354.77L204.93,358.67L200.45,356.34L198.43,356.74L196.63,359.25L193.98,358.06L190.48,360L190.36,356.53L186.47,351.95L183.31,355.13L181.36,354.85L178.99,359.48L176.36,356.7L173.92,357L170.91,354.88L166.89,358.15L166.89,358.15L168.87,345.94L172.04,341.49L170.98,339.22L170.98,339.22L172.19,331.22L181.05,330.01L186.92,331.48L192.77,327.6L192.55,319.09L194.94,315.88L200.83,312.3z"/>
                </g>
                <g class="region" data-region-id="21" data-region-code="BG-22" data-region-name="Sofia-Grad">
                    <path id="BG-22" title="Sofia-Grad" class="region-path" d="M56.98,136.58L61.53,135.25L73.32,146.55L92.8,145.21L97.19,140.46L103.59,140.83L103.59,140.83L112.22,142.27L108.63,148.88L109.48,154L115.38,163L118.03,164.73L127.81,156.11L132.85,158.51L142.2,154.22L144.75,156.11L154.33,156.37L159.13,158.81L160.11,154.8L160.11,154.8L166.2,155.11L166.78,158.65L171.67,161.09L172.53,167.37L179.37,171.03L176.24,174.19L179.37,176.4L179.75,181.14L182.36,183.1L178.32,189.94L190.69,190.79L200.58,193.64L200.58,193.64L196.65,202.64L197.01,205.76L204.82,210.07L209.89,215.11L207.52,221.21L201.76,222.22L201.76,222.22L199.21,219.84L196.33,221.54L193.17,211.85L187.04,209.43L178.2,211.79L177.1,216.71L172.35,216.62L166.31,223.16L159.92,220.21L154.13,221.49L154.93,230.6L158.68,236.54L162.23,237.58L167.27,235.4L168.73,238.61L165.04,246.35L157.89,249.35L155.89,255.54L157.36,260.21L154.17,261.92L151.99,259.18L146.85,265.99L139.09,271.97L139.09,271.97L136.37,271.97L137.17,275.7L134.64,276.43L131.26,274.9L129.34,271.07L122.77,271.07L118.87,282.67L116.27,284.7L110.46,284.93L110.46,284.93L114.34,281.23L114.55,278.83L107.44,275.78L105.73,270.15L99.15,272.32L97.27,270.74L99.75,264.81L104.65,262.99L104.65,261.63L98.1,256.32L95.8,249.24L87.38,247.61L87.38,247.61L86.24,234.27L90.09,225.09L90.09,225.09L95.35,227.21L104.47,237.06L106.16,236.07L108.42,227.14L111.14,227.45L114.76,234.36L115.48,242.91L117.34,242.2L121.91,243.92L127.87,241.76L123.35,228.48L118.78,222.58L118.41,211.7L113.83,209.19L114.47,206.75L116.67,205.89L117.82,201.94L122.66,199.44L125.48,188.76L124.22,183.83L118.55,186.05L110.69,180.95L97.5,183.55L94.45,178.01L91.55,175.99L84.58,193.67L86.03,196.03L85.32,198.35L82.5,197.44L80.17,198.77L68.41,199.04L68.41,199.04L67.06,196.91L61.72,194.61L59.74,191.47L47.82,187.31L44.64,182.1L40.63,182.38L38.85,177.91L38.85,177.91L41.37,172.99L40.43,170.85L41.8,166.28L48.05,163.41L52.81,159.22L55.16,153.03L61.22,149.06L62.64,142.94L61.56,141.69L63.53,138.3L60.55,136.56z"/>
                </g>
                <g class="region" data-region-id="22" data-region-code="BG-23" data-region-name="Sofia">
                    <path id="BG-23" title="Sofia" class="region-path" d="M68.41,199.04L80.17,198.77L82.5,197.44L85.32,198.35L86.03,196.03L84.58,193.67L91.55,175.99L94.45,178.01L97.5,183.55L110.69,180.95L118.55,186.05L124.22,183.83L125.48,188.76L122.66,199.44L117.82,201.94L116.67,205.89L114.47,206.75L113.83,209.19L118.41,211.7L118.78,222.58L123.35,228.48L127.87,241.76L121.91,243.92L117.34,242.2L115.48,242.91L114.76,234.36L111.14,227.45L108.42,227.14L106.16,236.07L104.47,237.06L95.35,227.21L90.09,225.09L90.09,225.09L89.84,223.45L87.25,223.99L83.46,218.31L78.94,217.53L79.89,215.33L78.72,208.89L74.73,206.45z"/>
                </g>
                <g class="region" data-region-id="23" data-region-code="BG-24" data-region-name="Stara Zagora">
                    <path id="BG-24" title="Stara Zagora" class="region-path" d="M321.01,194.5L330.4,190.14L337.03,190.57L337.03,190.57L337.41,197.46L341.43,205.48L342.61,212.58L345.65,217.69L342.62,224.22L346.19,232.49L343.79,238.35L347.55,242.93L350.36,252.6L358.73,258.08L358.76,260.09L362.45,257.6L372.71,263.75L372.71,263.75L376.31,265.99L376.31,265.99L368.22,273.95L371.61,289.37L365.67,289.82L362.42,293.27L360.33,292.68L356.15,284.14L351.89,283.61L349.54,281.34L346.14,281.24L343.38,279.14L342.03,280.04L340.5,285.8L330.91,289.29L324.94,276.76L318.29,280.27L318.15,271.48L316.91,269.02L309.82,275.1L311.65,275.7L310.72,277.51L305.09,275.69L304.68,278.95L301.24,283.51L292.69,280.36L292.69,280.36L285.68,272.33L281.86,274.8L272.44,276.35L265.36,272.4L265.98,263.84L275.89,259.56L271.29,256.12L271.3,243.92L272.01,242.32L276.12,243.31L273.25,236.98L277.4,232.79L277.8,230.24L275.48,226.71L265.04,230.28L261.6,228.9L258.61,223.64L256.84,216.14L260.02,209.06L259.57,197.3L260.59,194.95L260.59,194.95L267.78,195.86L278.36,190.89L284.6,194.66L288.3,194.1L300.22,197.4L301.38,196.37L300.95,192.75L304.09,192.99L306.97,195.91L310.52,196.71L315.26,194.32L318.49,197.12L320.82,196.16z"/>
                </g>
                <g class="region" data-region-id="24" data-region-code="BG-25" data-region-name="Targovishte">
                    <path id="BG-25" title="Targovishte" class="region-path" d="M365.45,92.81L367.22,94.01L374.46,93.92L376.73,90.76L380.01,90.11L386.64,96.63L390.68,97.51L393.16,103.86L398.46,105.13L397.88,111.46L388.06,119.33L388.77,121.73L391.93,122.85L393.22,124.87L391.86,127.5L393.03,129.42L397.17,127.43L397.35,124.82L401.34,119.47L401.01,117.39L403.98,117.92L408.8,115.74L414.2,118.1L419.85,118.64L422.1,114.23L424.09,115.88L429.37,115.46L429.37,115.46L428.14,117.05L428.8,124.91L432.06,127.89L432.55,130.41L426.74,136.54L424.58,142.61L420.6,142.88L423.32,152.55L418.02,157.98L418.06,162.56L414.85,164.16L414.85,164.16L404.75,162.61L394.85,164.7L390.03,161.81L387.5,164.2L386.44,159.34L381.27,160.37L379.3,166.2L374.32,170.45L374.32,170.45L363.17,166.54L366.89,161.72L362.61,157.19L362.17,147.06L364.09,140.91L367.2,138.74L367.25,137.02L361.94,130.03L362.89,127.13L356.25,120.77L356.25,120.77L356.69,115.91L351.74,111.69L357.44,104.4L359.13,95.84z"/>
                </g>
                <g class="region" data-region-id="25" data-region-code="BG-26" data-region-name="Haskovo">
                    <path id="BG-26" title="Haskovo" class="region-path" d="M376.31,265.99L383.64,269.08L386.92,272.07L392.89,273.63L395.35,272.22L397.86,274.22L401.75,273.3L403.31,276.06L406.94,275.66L406.49,289.42L404.05,291.79L403.98,294.56L411.46,305.81L411.46,305.81L413.58,308.72L412.03,311.1L413.31,312.85L409.31,319.23L392.32,320.03L388.74,328.71L388.69,330.57L391.56,333.78L384.35,333.8L379.01,330.05L376.11,330.82L373.38,328.86L368.61,331.34L367.52,333.6L363.33,334.12L362.53,336.79L363.66,342.17L365.94,344.83L369.97,344.04L371.6,347.62L371.02,354.11L373.94,354.44L374.73,358.98L371.62,363.94L376.23,369.76L373.18,370.21L372.06,371.71L372.13,375.5L369.36,380.21L360.06,380.9L357.31,381.82L356.42,384.09L350.44,384.75L350.44,384.75L348.95,378.77L340.49,370.71L341.14,363.98L335.95,359.79L337.76,351.06L341.95,347.79L340.3,342.45L334.46,341.67L328.96,346.64L325.22,344.98L322.83,346.51L321.81,343.93L323.19,339.41L320.22,329.35L318.01,326.57L312.09,328.32L303.61,325.71L296.23,321.54L293.88,315.9L288.36,321.05L285.25,308.75L286.57,304.32L286.57,304.32L289.13,301.16L288.71,290.7L292.69,280.36L292.69,280.36L301.24,283.51L304.68,278.95L305.09,275.69L310.72,277.51L311.65,275.7L309.82,275.1L316.91,269.02L318.15,271.48L318.29,280.27L324.94,276.76L330.91,289.29L340.5,285.8L342.03,280.04L343.38,279.14L346.14,281.24L349.54,281.34L351.89,283.61L356.15,284.14L360.33,292.68L362.42,293.27L365.67,289.82L371.61,289.37L368.22,273.95z"/>
                </g>
                <g class="region" data-region-id="26" data-region-code="BG-28" data-region-name="Yambol">
                    <path id="BG-28" title="Yambol" class="region-path" d="M423.25,203.97L431.47,213.32L444.16,237.81L451.2,238.37L449.3,243.14L442.09,244.37L440.81,245.88L441.78,250.12L449.63,258.96L448.04,264L450.52,270.2L447.73,273.49L448.07,275.61L458.11,285.22L458.11,285.22L456.68,285.51L457.16,288.14L455.22,290.9L452.63,291.12L452.91,293.4L450.73,296.46L441.73,297.4L439.07,300.19L433.77,297.51L430.24,301.65L421.7,300.66L417.63,298.82L411.46,305.81L411.46,305.81L403.98,294.56L404.05,291.79L406.49,289.42L406.94,275.66L403.31,276.06L401.75,273.3L397.86,274.22L395.35,272.22L392.89,273.63L386.92,272.07L383.64,269.08L376.31,265.99L376.31,265.99L372.71,263.75L372.71,263.75L378.49,250.85L379.12,242.78L378.28,241.13L374.07,244.66L371.85,239.74L375.98,241.3L375.71,235.37L377.03,234.54L383.79,236.41L385.25,234.4L389.35,233.87L393.88,228.94L393.54,226.76L391.64,225.46L395.61,222.19L401.08,223.09L409.85,217.61L414.69,217.12L417.53,212.56L419.63,214.87L422.52,211.26L422.55,207.27L420.67,202.81z"/>
                </g>
                <g class="region" data-region-id="27" data-region-code="BG-27" data-region-name="Shumen">
                    <path id="BG-27" title="Shumen" class="region-path" d="M455.07,70.56L463.96,67.51L469.47,74.31L473.76,74.14L473.76,74.14L476.25,77.1L480.77,77.73L485.03,83.66L486.53,84.24L493.48,80.19L496.07,84.94L496.07,84.94L494.11,87.74L484.58,90.78L484.57,94.32L487.22,95.5L485.3,100.53L487.18,100.94L487.64,102.71L482.55,110.43L483.56,121.26L481.64,122.98L478.89,122.1L478.44,123.29L481.98,137.29L473,142.59L472,146.4L474.47,149.1L476.03,157.85L462.49,160.74L459.81,163.28L464.84,168.86L464.56,172.77L464.56,172.77L459.54,173.35L452.3,177.24L447.26,173.46L441.71,174.55L437.81,172.91L429.77,173.27L423.45,177.75L415.84,177.81L415.33,173.87L409.08,174.11L409.08,174.11L407.88,172.66L408.43,169.84L414.85,164.16L414.85,164.16L418.06,162.56L418.02,157.98L423.32,152.55L420.6,142.88L424.58,142.61L426.74,136.54L432.55,130.41L432.06,127.89L428.8,124.91L428.14,117.05L429.37,115.46L429.37,115.46L433.62,111.1L428.76,106.9L428.44,103.39L434.96,97.09L434.65,91.04L440.37,86.18L441.31,81.95L447.02,83.57L450.24,79.5L454.53,77.38L456,75.17z"/>
                </g>
            </g>
            <g id="regionOverlaysLayer"></g>
            <g id="hoverLabelLayer" visibility="hidden" style="pointer-events:none">
                <rect class="region-label-bg" id="hoverLabelBg" x="0" y="0" width="1" height="1"/>
                <text class="region-label" id="hoverLabelText" x="0" y="0" text-anchor="middle"></text>
            </g>
        </svg>
            </div>
        </div>
    <div class="territory-confirm-wrap" id="territoryConfirmWrap">
        <div class="territory-confirm-box">
            <p class="territory-confirm-text" id="territoryConfirmText"></p>
            <div class="territory-confirm-buttons">
                <button type="button" class="territory-confirm-btn territory-confirm-yes" id="territoryConfirmYes">–î–∞</button>
                <button type="button" class="territory-confirm-btn territory-confirm-no" id="territoryConfirmNo">–ù–µ—Ç</button>
            </div>
        </div>
    </div>
    </div>
    {% if user_logged_in and current_user.clan_id %}
    <button type="button" class="floating-chat-btn" id="battleFloatingChatBtn" aria-label="–ß–∞—Ç —Å –∫–ª–∞–Ω–æ–º" title="–ß–∞—Ç —Å –∫–ª–∞–Ω–æ–º">üí¨</button>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–¥–∞–Ω–∏—è -->
<div class="task-modal-overlay" id="taskModal">
    <div class="task-modal">
        <div class="task-modal-header">
            <h2 id="taskModalTitle">–ó–∞–¥–∞–Ω–∏–µ</h2>
        </div>
        <div class="task-modal-body">
            <div class="territory-task-content no-copy" id="territoryTaskContent">
                <div class="task-text" id="taskModalText"></div>
                <img class="task-image" id="taskModalImage" alt="" style="display: none;">
            </div>
            <div class="task-answer-wrap" id="taskAnswerWrapDefault">
                <label for="taskAnswerInput">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                <input type="text" id="taskAnswerInput">
            </div>
            <div class="task-answer-wrap task-fraction-wrap" id="taskAnswerWrapFraction" style="display: none;">
                <label>–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                <div class="task-answer-fraction-visual">
                    <div class="answer-frac-wrap">
                        <input type="number" id="taskAnswerNum" min="0" title="–ß–∏—Å–ª–∏—Ç–µ–ª—å">
                        <span class="answer-frac-line"></span>
                        <input type="number" id="taskAnswerDen" min="1" title="–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å">
                    </div>
                </div>
            </div>
            <div class="task-answer-wrap task-common-denom-wrap" id="taskAnswerWrapCommonDenom" style="display: none;">
                <label>–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                <div class="task-common-denom-visual">
                    <div class="task-common-denom-row-eq">
                        <div class="task-common-denom-original task-text" id="taskCommonDenomFrac1"></div>
                        <span class="task-common-denom-eq">=</span>
                        <div class="answer-frac-wrap">
                            <input type="number" id="taskAnswerNum1" min="0" title="–ß–∏—Å–ª–∏—Ç–µ–ª—å 1">
                            <span class="answer-frac-line"></span>
                            <input type="number" id="taskAnswerDenCommon" min="1" title="–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å 1">
                        </div>
                    </div>
                    <div class="task-common-denom-row-eq">
                        <div class="task-common-denom-original task-text" id="taskCommonDenomFrac2"></div>
                        <span class="task-common-denom-eq">=</span>
                        <div class="answer-frac-wrap">
                            <input type="number" id="taskAnswerNum2" min="0" title="–ß–∏—Å–ª–∏—Ç–µ–ª—å 2">
                            <span class="answer-frac-line"></span>
                            <input type="number" id="taskAnswerDenCommon2" min="1" title="–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å 2">
                        </div>
                    </div>
                </div>
            </div>
            <div class="task-answer-wrap task-mixed-fraction-wrap" id="taskAnswerWrapMixedFraction" style="display: none;">
                <label id="taskMixedFractionLabel">–í–∞—à –æ—Ç–≤–µ—Ç (—Å–º–µ—à–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ):</label>
                <div class="task-mixed-fraction-display" id="taskMixedFracDisplay"></div>
                <div class="task-add-sub-display task-mixed-fraction-display" id="taskAddSubFracDisplay" style="display: none;"></div>
                <div class="task-answer-fraction-visual task-mixed-fraction-fields">
                    <div class="answer-int-wrap">
                        <input type="number" id="taskAnswerIntPart" min="0" title="–¶–µ–ª–∞—è —á–∞—Å—Ç—å">
                    </div>
                    <div class="answer-frac-wrap">
                        <input type="number" id="taskAnswerNumMixed" min="0" title="–ß–∏—Å–ª–∏—Ç–µ–ª—å">
                        <span class="answer-frac-line"></span>
                        <input type="number" id="taskAnswerDenMixed" min="1" title="–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å">
                    </div>
                </div>
            </div>
        </div>
        <div class="task-modal-footer">
            <button type="button" class="submit-task-btn" id="submitTaskBtn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ¬´–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏¬ª -->
<div class="energy-modal-overlay" id="energyModal">
    <div class="energy-modal-box">
        <h3>‚ö° –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏</h3>
        <p id="energyModalText">–≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç (+20% –æ—Ç –º–∞–∫—Å.). –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –±–æ–ª—å—à–µ –∑–∞–¥–∞–Ω–∏–π, —á—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –º–∞–∫—Å–∏–º—É–º.</p>
        <button type="button" class="energy-modal-ok" id="energyModalOk">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
</div>

{% if user_logged_in and current_user.clan_id %}
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ —Å –∫–ª–∞–Ω–æ–º (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±–∏—Ç–≤—ã) -->
<div class="clan-chat-modal-overlay" id="battleClanChatModal">
    <div class="clan-chat-modal">
        <div class="modal-box">
            <button type="button" class="modal-chat-close" id="battleClanChatModalClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
            <h3>–ß–∞—Ç —Å –∫–ª–∞–Ω–æ–º</h3>
            <div class="clan-chat-modal-body">
                <div class="clan-chat-content open">
                    <div class="clan-chat-messages" id="battleClanChatMessages">
                        <div class="clan-chat-empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶</div>
                    </div>
                    <div class="clan-chat-form">
                        <input type="text" id="battleClanChatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" autocomplete="off">
                        <button type="button" id="battleClanChatSendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="task-result-toast" id="taskResultToast"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∏—Å—ã–≤–∞–Ω–∏—è) -->
<div class="task-modal-overlay" id="territoryFocusWarningModal" style="display: none; pointer-events: auto;">
    <div class="task-modal" style="max-width: 400px;">
        <div class="task-modal-header"><h2>–í–Ω–∏–º–∞–Ω–∏–µ</h2></div>
        <div class="task-modal-body" style="text-align: center; color: #2c1810;">
            –í—ã –±—ã–ª–∏ –≤–Ω–µ –≤–∫–ª–∞–¥–∫–∏ –±–æ–ª–µ–µ 5 —Å–µ–∫—É–Ω–¥.<br>
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑
            <span id="territoryFocusWarningCountdown" style="font-weight: bold;">2</span> —Å–µ–∫.
        </div>
    </div>
</div>

<div class="territory-description-popover-overlay" id="territoryDescriptionPopover">
    <div class="territory-description-popover">
        <h4 id="territoryDescriptionPopoverTitle"></h4>
        <p id="territoryDescriptionPopoverText"></p>
        <button type="button" class="territory-description-popover-close" id="territoryDescriptionPopoverClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
// –ó–∞–ø—Ä–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏ (–≤ –±–ª–æ–∫–µ –º–æ–¥–∞–ª–∫–∏ –∑–∞–¥–∞–Ω–∏—è)
(function() {
    const territoryTaskContent = document.getElementById('territoryTaskContent');
    if (!territoryTaskContent) return;
    const block = function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    };
    ['copy', 'cut', 'contextmenu', 'selectstart', 'dragstart'].forEach(function(evt) {
        territoryTaskContent.addEventListener(evt, block);
    });
})();

// –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∏—Å—ã–≤–∞–Ω–∏—è: –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –≤–Ω–µ —Ñ–æ–∫—É—Å–∞ > 5 —Å–µ–∫ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
window.territoryFocusProtection = (function() {
    const MAX_INACTIVE_MS = 5000;
    const RELOAD_DELAY_MS = 2000;
    var armed = false;
    var hiddenSince = null;
    var reloadTriggered = false;
    var reloadTimeoutId = null;
    var countdownIntervalId = null;

    function cleanupTimers() {
        if (countdownIntervalId) { clearInterval(countdownIntervalId); countdownIntervalId = null; }
        if (reloadTimeoutId) { clearTimeout(reloadTimeoutId); reloadTimeoutId = null; }
    }
    function markHidden() {
        if (!armed || reloadTriggered) return;
        if (hiddenSince === null) hiddenSince = Date.now();
    }
    function showWarningAndReload() {
        var modal = document.getElementById('territoryFocusWarningModal');
        var countdownEl = document.getElementById('territoryFocusWarningCountdown');
        cleanupTimers();
        if (modal) {
            modal.style.display = 'flex';
            modal.classList.add('open');
        }
        var start = Date.now();
        function updateCountdown() {
            var remainingMs = Math.max(0, RELOAD_DELAY_MS - (Date.now() - start));
            var sec = Math.max(0, Math.ceil(remainingMs / 1000));
            if (countdownEl) countdownEl.textContent = String(sec);
            if (remainingMs <= 0 && countdownIntervalId) {
                clearInterval(countdownIntervalId);
                countdownIntervalId = null;
            }
        }
        updateCountdown();
        countdownIntervalId = setInterval(updateCountdown, 200);
        reloadTimeoutId = setTimeout(function() {
            cleanupTimers();
            window.location.reload();
        }, RELOAD_DELAY_MS);
    }
    function checkAndReload() {
        if (!armed || reloadTriggered) return;
        if (hiddenSince === null) return;
        if ((Date.now() - hiddenSince) > MAX_INACTIVE_MS) {
            reloadTriggered = true;
            showWarningAndReload();
            return;
        }
        hiddenSince = null;
    }
    function onVisibilityChange() {
        if (document.hidden) markHidden();
        else checkAndReload();
    }
    function arm() {
        if (armed) return;
        armed = true;
        hiddenSince = null;
        reloadTriggered = false;
        document.addEventListener('visibilitychange', onVisibilityChange);
        window.addEventListener('blur', markHidden);
        window.addEventListener('focus', checkAndReload);
    }
    function disarm() {
        if (!armed) return;
        armed = false;
        hiddenSince = null;
        reloadTriggered = false;
        cleanupTimers();
        document.removeEventListener('visibilitychange', onVisibilityChange);
        window.removeEventListener('blur', markHidden);
        window.removeEventListener('focus', checkAndReload);
        var modal = document.getElementById('territoryFocusWarningModal');
        if (modal) { modal.style.display = 'none'; modal.classList.remove('open'); }
    }
    return { arm: arm, disarm: disarm };
})();

(function() {
    const MAX_STRENGTH = 1000;
    const STRENGTH_STEP_SAME = 25;   // –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–≤–æ–µ–≥–æ –∫–ª–∞—Å—Å–∞
    const STRENGTH_STEP_OTHER = 25;  // —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ —á—É–∂–æ–≥–æ –∫–ª–∞—Å—Å–∞

    const TERRITORY_REGIONS_CONFIG = {{ regions_json | tojson | safe }};
    const TERRITORY_STATE = {{ territory_state_json | tojson | safe }};

    const clansData = {{ clans_json | tojson | safe }};
    const playerClanId = {{ current_user_clan_id | tojson }};
    const isAuthenticated = {{ is_authenticated | tojson }};
    const captureEnabled = {{ capture_enabled | tojson }};
    const captureStartTimeIso = {{ capture_start_time_iso | tojson }};
    const captureStartTimeMs = {{ capture_start_time_ms | tojson }};
    const captureEndTimeMs = {{ capture_end_time_ms | tojson }};
    const clanColors = {};
    const clanHeraldry = {};
    clansData.forEach(function(c) {
        clanColors[c.id] = c.territory_fill_color || '#6b7280';
        clanHeraldry[c.id] = c.territory_heraldry_url || null;
    });

    const state = {
        regions: [],
        currentRegionId: null
    };

    const regionElements = document.querySelectorAll('.region');
    const REGION_COUNT = regionElements.length;
    const configByIndex = {};
    (TERRITORY_REGIONS_CONFIG || []).forEach(function(r) { configByIndex[r.region_index] = r; });
    for (let i = 0; i < REGION_COUNT; i++) {
        const cfg = configByIndex[i];
        const st = (TERRITORY_STATE && TERRITORY_STATE[i]) ? TERRITORY_STATE[i] : { owner_clan_id: null, strength: 0 };
        const isLocked = !!(cfg && cfg.is_locked);
        state.regions.push({
            ownerId: st.owner_clan_id !== undefined ? st.owner_clan_id : (st.owner_class_id !== undefined ? st.owner_class_id : null),
            strength: st.strength || 0,
            isLocked: isLocked
        });
        const g = regionElements[i];
        if (g) {
            if (cfg && cfg.is_locked) {
                g.classList.add('region-inactive');
                const path = g.querySelector('.region-path');
                if (path) path.classList.add('region-locked');
            } else if (!captureEnabled) {
                g.classList.add('region-inactive');
                const path = g.querySelector('.region-path');
                if (path) path.classList.remove('region-locked');
            } else {
                g.classList.remove('region-inactive');
                const path = g.querySelector('.region-path');
                if (path) path.classList.remove('region-locked');
            }
        }
    }

    function getRegionDisplayName(index) {
        const cfg = configByIndex[index];
        if (cfg && cfg.display_name) return cfg.display_name;
        const g = regionElements[index];
        return (g && g.getAttribute('data-region-name')) || ('–ó–æ–Ω–∞ ' + (index + 1));
    }

    function initRegionOverlays() {
        const svg = document.getElementById('territoryMap');
        if (!svg) return;

        regionElements.forEach(function(g, index) {
            const path = g.querySelector('.region-path');
            if (!path) return;

            const bbox = path.getBBox();
            let cx = bbox.x + bbox.width / 2;
            let cy = bbox.y + bbox.height / 2;
            if (index === 9) cy += 0.1 * 396;
            if (index === 21) cx += 0.05 * 615;

            const overlay = document.createElementNS(svg.namespaceURI, 'g');
            overlay.classList.add('region-overlay');
            overlay.setAttribute('data-region-id', String(index));

            const isLocked = g.classList.contains('region-inactive');
            var strengthTextEl = null;

            if (isLocked) {
                var lockG = document.createElementNS(svg.namespaceURI, 'g');
                lockG.setAttribute('transform', 'translate(' + cx + ',' + cy + ') scale(0.4)');
                var lockPath = document.createElementNS(svg.namespaceURI, 'path');
                lockPath.setAttribute('d', 'M12 2C9.24 2 7 4.24 7 7v2H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V11c0-1.1-.9-2-2-2h-2V7c0-2.76-2.24-5-5-5zm0 2c1.66 0 3 1.34 3 3v2H9V7c0-1.66 1.34-3 3-3zm-3 9h6v8H9v-8z');
                lockPath.setAttribute('fill', '#5c4033');
                lockG.appendChild(lockPath);
                overlay.appendChild(lockG);
            } else {
                const flagCircle = document.createElementNS(svg.namespaceURI, 'circle');
                flagCircle.classList.add('region-flag');
                flagCircle.setAttribute('cx', cx);
                flagCircle.setAttribute('cy', cy);
                flagCircle.setAttribute('r', 16);
                flagCircle.setAttribute('fill', 'url(#neutralGrad)');
                overlay.appendChild(flagCircle);

                strengthTextEl = document.createElementNS(svg.namespaceURI, 'text');
                strengthTextEl.classList.add('region-strength-value');
                strengthTextEl.setAttribute('x', cx);
                strengthTextEl.setAttribute('y', cy + 22);
                strengthTextEl.setAttribute('text-anchor', 'middle');
                strengthTextEl.textContent = '0';
                overlay.appendChild(strengthTextEl);
            }

            var regionDesc = (configByIndex[index] && configByIndex[index].description) ? configByIndex[index].description : '';
            var displayName = (configByIndex[index] && configByIndex[index].display_name) ? String(configByIndex[index].display_name).trim() : '';
            var hasNameBlock = displayName !== '';

            if (hasNameBlock) {
                const nameText = document.createElementNS(svg.namespaceURI, 'text');
                nameText.classList.add('region-label');
                nameText.setAttribute('x', cx);
                nameText.setAttribute('y', cy - 16);
                nameText.setAttribute('text-anchor', 'middle');
                nameText.textContent = displayName;
                overlay.appendChild(nameText);

                var overlayLayer = document.getElementById('regionOverlaysLayer');
                (overlayLayer || g).appendChild(overlay);

                var pad = 4;
                var textBBox = nameText.getBBox();
                var labelBg = document.createElementNS(svg.namespaceURI, 'rect');
                labelBg.classList.add('region-label-bg');
                labelBg.setAttribute('x', textBBox.x - pad);
                labelBg.setAttribute('y', textBBox.y - pad);
                labelBg.setAttribute('width', Math.max(1, textBBox.width) + pad * 2);
                labelBg.setAttribute('height', Math.max(1, textBBox.height) + pad * 2);
                labelBg.setAttribute('rx', 4);
                labelBg.setAttribute('ry', 4);
                overlay.insertBefore(labelBg, nameText);

                if (regionDesc) {
                    var infoBtn = document.createElementNS(svg.namespaceURI, 'g');
                    infoBtn.classList.add('region-info-btn');
                    infoBtn.setAttribute('data-region-index', String(index));
                    infoBtn.style.cursor = 'pointer';
                    infoBtn.style.pointerEvents = 'auto';
                    var btnY = textBBox.y - pad - 8;
                    var btnSize = 16;
                    var infoRect = document.createElementNS(svg.namespaceURI, 'rect');
                    infoRect.setAttribute('x', cx - btnSize / 2);
                    infoRect.setAttribute('y', btnY - btnSize / 2);
                    infoRect.setAttribute('width', btnSize);
                    infoRect.setAttribute('height', btnSize);
                    infoRect.setAttribute('rx', 2);
                    infoBtn.appendChild(infoRect);
                    var bookIcon = document.createElementNS(svg.namespaceURI, 'text');
                    bookIcon.setAttribute('class', 'region-info-book');
                    bookIcon.setAttribute('x', cx);
                    bookIcon.setAttribute('y', btnY);
                    bookIcon.setAttribute('text-anchor', 'middle');
                    bookIcon.setAttribute('dominant-baseline', 'central');
                    bookIcon.textContent = '\uD83D\uDCD6';
                    infoBtn.appendChild(bookIcon);
                    overlay.insertBefore(infoBtn, labelBg);
                    infoBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var idx = parseInt(this.getAttribute('data-region-index'), 10);
                        var cfg = configByIndex[idx];
                        var titleEl = document.getElementById('territoryDescriptionPopoverTitle');
                        var textEl = document.getElementById('territoryDescriptionPopoverText');
                        var popover = document.getElementById('territoryDescriptionPopover');
                        if (titleEl) titleEl.textContent = cfg && cfg.display_name ? cfg.display_name : ('–ó–æ–Ω–∞ ' + (idx + 1));
                        if (textEl) textEl.textContent = (cfg && cfg.description) ? cfg.description : '';
                        if (popover) popover.classList.add('show');
                    });
                }
            } else {
                var overlayLayer = document.getElementById('regionOverlaysLayer');
                (overlayLayer || g).appendChild(overlay);
            }

            if (!isLocked && strengthTextEl) {
                var strengthPad = 3;
                var strengthBBox = strengthTextEl.getBBox();
                var strengthBg = document.createElementNS(svg.namespaceURI, 'rect');
                strengthBg.classList.add('region-strength-value-bg');
                strengthBg.setAttribute('x', strengthBBox.x - strengthPad);
                strengthBg.setAttribute('y', strengthBBox.y - strengthPad);
                strengthBg.setAttribute('width', Math.max(1, strengthBBox.width) + strengthPad * 2);
                strengthBg.setAttribute('height', Math.max(1, strengthBBox.height) + strengthPad * 2);
                strengthBg.setAttribute('rx', 3);
                strengthBg.setAttribute('ry', 3);
                overlay.insertBefore(strengthBg, strengthTextEl);
                overlay.appendChild(strengthBg);
                overlay.appendChild(strengthTextEl);
            }
        });
    }

    initRegionOverlays();

    (function initDescriptionPopover() {
        var overlay = document.getElementById('territoryDescriptionPopover');
        var closeBtn = document.getElementById('territoryDescriptionPopoverClose');
        function hide() { if (overlay) overlay.classList.remove('show'); }
        if (closeBtn) closeBtn.addEventListener('click', hide);
        if (overlay) overlay.addEventListener('click', function(e) { if (e.target === overlay) hide(); });
    })();

    (function initHoverLabelLayer() {
        const layer = document.getElementById('hoverLabelLayer');
        if (!layer) return;
        var hoverClone = null;
        var hoveredOverlay = null;

        document.querySelectorAll('.territory-map .region:not(.region-inactive)').forEach(function(g) {
            g.addEventListener('mouseenter', function() {
                var regionId = g.getAttribute('data-region-id');
                var mapEl = document.getElementById('territoryMap');
                const overlay = regionId && mapEl ? mapEl.querySelector('.region-overlay[data-region-id="' + regionId + '"]') : null;
                if (!overlay) return;
                if (hoverClone && hoverClone.parentNode) hoverClone.parentNode.removeChild(hoverClone);
                if (hoveredOverlay) hoveredOverlay.removeAttribute('visibility');
                hoverClone = overlay.cloneNode(true);
                hoverClone.classList.add('region-overlay-hover-clone');
                layer.appendChild(hoverClone);
                overlay.setAttribute('visibility', 'hidden');
                hoveredOverlay = overlay;
                layer.setAttribute('visibility', 'visible');
            });
            g.addEventListener('mouseleave', function() {
                if (hoverClone && hoverClone.parentNode) {
                    hoverClone.parentNode.removeChild(hoverClone);
                    hoverClone = null;
                }
                if (hoveredOverlay) {
                    hoveredOverlay.removeAttribute('visibility');
                    hoveredOverlay = null;
                }
                layer.setAttribute('visibility', 'hidden');
            });
        });
    })();

    window._territoryMapDidPan = false;
    (function initMapPanZoom() {
        const viewport = document.getElementById('mapViewport');
        const panZoom = document.getElementById('mapPanZoom');
        if (!viewport || !panZoom) return;
        let scale = 1, tx = 0, ty = 0;
        let isPanning = false, startX, startY, startTx, startTy;
        let touchStartDist, touchStartScale, touchStartTx, touchStartTy, touchStartCenterX, touchStartCenterY;
        const MIN_SCALE = 0.4, MAX_SCALE = 4;
        const INITIAL_SCALE = 1.85;

        function applyTransform() {
            panZoom.style.transform = 'translate(' + tx + 'px,' + ty + 'px) scale(' + scale + ')';
        }

        function setInitialZoom() {
            var vw = viewport.clientWidth;
            var vh = viewport.clientHeight;
            var contentW = panZoom.offsetWidth;
            var contentH = panZoom.offsetHeight;
            if (contentW > 0 && contentH > 0) {
                scale = Math.min(INITIAL_SCALE, MAX_SCALE);
                tx = vw / 2 - (contentW / 2) * scale;
                ty = vh / 2 - (contentH / 2) * scale;
                applyTransform();
                return true;
            }
            return false;
        }

        viewport.addEventListener('wheel', function(e) {
            e.preventDefault();
            const rect = viewport.getBoundingClientRect();
            const wx = e.clientX - rect.left;
            const wy = e.clientY - rect.top;
            const k = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale * k));
            tx = wx + (tx - wx) * (newScale / scale);
            ty = wy + (ty - wy) * (newScale / scale);
            scale = newScale;
            applyTransform();
        }, { passive: false });

        viewport.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return;
            isPanning = true;
            viewport.classList.add('grabbing');
            startX = e.clientX;
            startY = e.clientY;
            startTx = tx;
            startTy = ty;
        });
        window.addEventListener('mousemove', function(e) {
            if (!isPanning) return;
            const dx = e.clientX - startX, dy = e.clientY - startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) window._territoryMapDidPan = true;
            tx = startTx + (e.clientX - startX);
            ty = startTy + (e.clientY - startY);
            applyTransform();
        });
        window.addEventListener('mouseup', function() {
            isPanning = false;
            viewport.classList.remove('grabbing');
        });

        viewport.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                const rect = viewport.getBoundingClientRect();
                touchStartDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
                touchStartCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                touchStartCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                touchStartScale = scale;
                touchStartTx = tx;
                touchStartTy = ty;
            } else if (e.touches.length === 1) {
                isPanning = true;
                viewport.classList.add('grabbing');
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startTx = tx;
                startTy = ty;
            }
        }, { passive: true });
        viewport.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                const rect = viewport.getBoundingClientRect();
                const d = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
                const k = d / touchStartDist;
                const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, touchStartScale * k));
                const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                tx = cx - (touchStartCenterX - touchStartTx) * (newScale / touchStartScale);
                ty = cy - (touchStartCenterY - touchStartTy) * (newScale / touchStartScale);
                scale = newScale;
                window._territoryMapDidPan = true;
                applyTransform();
            } else if (e.touches.length === 1 && isPanning) {
                e.preventDefault();
                const dx = e.touches[0].clientX - startX, dy = e.touches[0].clientY - startY;
                if (Math.abs(dx) > 3 || Math.abs(dy) > 3) window._territoryMapDidPan = true;
                tx = startTx + (e.touches[0].clientX - startX);
                ty = startTy + (e.touches[0].clientY - startY);
                applyTransform();
            }
        }, { passive: false });
        viewport.addEventListener('touchend', function(e) {
            if (e.touches.length < 2) {
                isPanning = false;
                viewport.classList.remove('grabbing');
            }
        });

        window._territoryMapCenterRegion = function(regionId) {
            const g = document.querySelector('.region[data-region-id="' + regionId + '"]');
            if (!g || g.classList.contains('region-inactive')) return;
            const path = g.querySelector('.region-path');
            if (!path) return;
            const bbox = path.getBBox();
            const cx = bbox.x + bbox.width / 2;
            const cy = bbox.y + bbox.height / 2;

            const svg = document.getElementById('territoryMap');
            if (!svg) return;
            const vb = svg.getAttribute('viewBox');
            const vw = viewport.clientWidth;
            const vh = viewport.clientHeight;
            const contentW = panZoom.offsetWidth;
            const contentH = panZoom.offsetHeight;
            var minX = 0, minY = 430, vbW = 620, vbH = 380;
            if (vb) {
                var parts = vb.split(/\s+/);
                if (parts.length >= 4) { minX = +parts[0]; minY = +parts[1]; vbW = +parts[2]; vbH = +parts[3]; }
            }
            const px = (cx - minX) * (contentW / vbW);
            const py = (cy - minY) * (contentH / vbH);

            const targetScale = 2;
            const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, targetScale));
            tx = vw / 2 - px * newScale;
            ty = vh / 2 - py * newScale;
            scale = newScale;

            panZoom.style.transition = 'transform 0.4s ease-out';
            applyTransform();
            panZoom.addEventListener('transitionend', function onEnd() {
                panZoom.removeEventListener('transitionend', onEnd);
                panZoom.style.transition = '';
            }, { once: true });
        };

        if (!setInitialZoom()) {
            requestAnimationFrame(function() { setInitialZoom(); });
        }
    })();

    function getRegionElement(id) {
        return document.querySelector('.region[data-region-id="' + id + '"]');
    }

    function getRegionOverlay(regionId) {
        var svg = document.getElementById('territoryMap');
        return svg ? svg.querySelector('.region-overlay[data-region-id="' + regionId + '"]') : null;
    }

    function updateRegionUI(regionId) {
        const r = state.regions[regionId];
        const g = getRegionElement(regionId);
        if (!g || !r) return;
        if (g.classList.contains('region-inactive')) return;

        const path = g.querySelector('.region-path');
        const overlay = getRegionOverlay(regionId);
        const flag = overlay ? overlay.querySelector('.region-flag') : null;
        const strengthText = overlay ? overlay.querySelector('.region-strength-value') : null;

        if (path) {
            if (r.ownerId === null) {
                path.classList.remove('owned');
                path.style.setProperty('--region-color', null);
                path.setAttribute('fill', 'rgba(255,255,255,0.15)');
            } else {
                path.classList.add('owned');
                const color = clanColors[r.ownerId] || '#666';
                path.style.setProperty('--region-color', color);
                path.setAttribute('fill', color);
            }
        }

        if (flag) {
            if (r.ownerId === null) {
                flag.setAttribute('fill', 'url(#neutralGrad)');
                flag.style.fill = '';
                var img = overlay && overlay.querySelector('.region-heraldry-img');
                if (img) img.remove();
            } else {
                const heraldryUrl = clanHeraldry[r.ownerId];
                if (heraldryUrl) {
                    flag.setAttribute('fill', 'transparent');
                    var img = overlay && overlay.querySelector('.region-heraldry-img');
                    if (!img && overlay) {
                        img = document.createElementNS(overlay.ownerDocument.namespaceURI || 'http://www.w3.org/2000/svg', 'image');
                        img.setAttribute('class', 'region-heraldry-img');
                        img.setAttribute('href', heraldryUrl);
                        img.setAttribute('x', parseFloat(flag.getAttribute('cx')) - 16);
                        img.setAttribute('y', parseFloat(flag.getAttribute('cy')) - 16);
                        img.setAttribute('width', 32);
                        img.setAttribute('height', 32);
                        img.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                        img.setAttribute('clip-path', 'url(#heraldryCircleClip)');
                        var strengthBgEl = overlay.querySelector('.region-strength-value-bg');
                        if (strengthBgEl) overlay.insertBefore(img, strengthBgEl);
                        else overlay.appendChild(img);
                    }
                    if (img) {
                        img.setAttribute('href', heraldryUrl);
                        img.setAttribute('x', parseFloat(flag.getAttribute('cx')) - 16);
                        img.setAttribute('y', parseFloat(flag.getAttribute('cy')) - 16);
                    }
                } else {
                    flag.setAttribute('fill', clanColors[r.ownerId] || '#666');
                    var img = overlay && overlay.querySelector('.region-heraldry-img');
                    if (img) img.remove();
                }
            }
        }

        if (strengthText) {
            strengthText.textContent = Math.round(r.strength);
            var strengthBgEl = overlay ? overlay.querySelector('.region-strength-value-bg') : null;
            if (strengthBgEl) {
                var strengthPad = 3;
                var strengthBBox = strengthText.getBBox();
                strengthBgEl.setAttribute('x', strengthBBox.x - strengthPad);
                strengthBgEl.setAttribute('y', strengthBBox.y - strengthPad);
                strengthBgEl.setAttribute('width', Math.max(1, strengthBBox.width) + strengthPad * 2);
                strengthBgEl.setAttribute('height', Math.max(1, strengthBBox.height) + strengthPad * 2);
            }
        }
    }

    function renderGlobalProgress() {
        const counts = {};
        clansData.forEach(function(c) { counts[c.id] = 0; });
        let totalRegions = 0;
        state.regions.forEach(function(r) {
            if (r.isLocked) return;
            totalRegions += 1;
            if (r.ownerId !== null) counts[r.ownerId] = (counts[r.ownerId] || 0) + 1;
        });
        if (totalRegions === 0) totalRegions = 1;
        const container = document.getElementById('globalProgressBars');
        container.innerHTML = '';

        let leader = null;
        let maxCount = 0;
        clansData.forEach(function(c) {
            const n = counts[c.id] || 0;
            if (n > maxCount) {
                maxCount = n;
                leader = c;
            }
        });

        if (!leader || maxCount === 0) {
            container.innerHTML = '<div class="global-no-leader">–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</div>';
            return;
        }

        const heraldryUrl = clanHeraldry[leader.id];
        const avatarOrHeraldry = heraldryUrl
            ? '<img class="global-class-heraldry" src="' + heraldryUrl + '" alt="">'
            : '<span class="global-class-avatar" style="background:' + (clanColors[leader.id] || '#888') + '">' + (leader.name.charAt(0)) + '</span>';
        const row = document.createElement('div');
        row.className = 'global-leader-row';
        row.innerHTML =
            avatarOrHeraldry +
            '<span class="global-class-name">' + leader.name + '</span>' +
            '<span class="global-class-count">' + maxCount + ' –∏–∑ ' + totalRegions + ' –æ–±–ª.</span>';
        container.appendChild(row);
    }

    let _pendingConfirmRegionId = null;

    function openConfirmModal(regionId) {
        if (!playerClanId) return;
        const r = state.regions[regionId];
        const isOwn = r && r.ownerId === playerClanId;
        const regionName = getRegionDisplayName(regionId);
        const textEl = document.getElementById('territoryConfirmText');
        textEl.textContent = isOwn
            ? '–£—Å–∏–ª–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ ¬´' + regionName + '¬ª?'
            : '–ù–∞–ø–∞—Å—Ç—å –Ω–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é ¬´' + regionName + '¬ª?';
        _pendingConfirmRegionId = regionId;
        document.getElementById('territoryConfirmWrap').classList.add('open');
    }

    function closeConfirmModal() {
        _pendingConfirmRegionId = null;
        document.getElementById('territoryConfirmWrap').classList.remove('open');
    }

    function openTaskModal(regionId) {
        state.currentRegionId = regionId;
        document.getElementById('taskModalTitle').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        document.getElementById('taskModalText').textContent = '';
        document.getElementById('taskModalImage').style.display = 'none';
        document.getElementById('taskAnswerInput').value = '';
        document.getElementById('taskAnswerWrapDefault').style.display = 'block';
        document.getElementById('taskAnswerWrapFraction').style.display = 'none';
        document.getElementById('taskAnswerWrapCommonDenom').style.display = 'none';
        document.getElementById('taskAnswerWrapMixedFraction').style.display = 'none';
        window._currentTask = null;
        document.getElementById('taskModal').classList.add('open');
        fetch('{{ url_for("api_territory_task") }}?region_index=' + encodeURIComponent(String(regionId)))
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success && data.task) {
                    var t = data.task;
                    window._currentTask = t;
                    document.getElementById('taskModalTitle').textContent = t.title;
                    var textEl = document.getElementById('taskModalText');
                    if ((t.answer_type === 'fraction' || t.answer_type === 'common_denominator' || t.title === '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥—Ä–æ–±–∏') && t.text && t.text.indexOf('<span') !== -1) {
                        textEl.innerHTML = t.text;
                    } else {
                        textEl.textContent = t.text;
                    }
                    var img = document.getElementById('taskModalImage');
                    if (t.image_url) {
                        img.src = t.image_url;
                        img.style.display = 'block';
                    } else {
                        img.style.display = 'none';
                    }
                    var isFraction = t.answer_type === 'fraction';
                    var isCommonDenom = t.answer_type === 'common_denominator';
                    var isMixedFraction = t.answer_type === 'mixed_fraction' || t.answer_type === 'add_sub_fractions';
                    var isSpecial = isFraction || isCommonDenom || isMixedFraction;
                    document.getElementById('taskAnswerWrapDefault').style.display = isSpecial ? 'none' : 'block';
                    document.getElementById('taskAnswerWrapFraction').style.display = isFraction ? 'block' : 'none';
                    document.getElementById('taskAnswerWrapCommonDenom').style.display = isCommonDenom ? 'block' : 'none';
                    document.getElementById('taskAnswerWrapMixedFraction').style.display = isMixedFraction ? 'block' : 'none';
                    document.getElementById('taskAnswerInput').value = '';
                    document.getElementById('taskAnswerNum').value = '';
                    document.getElementById('taskAnswerDen').value = '';
                    document.getElementById('taskAnswerNum1').value = '';
                    document.getElementById('taskAnswerDenCommon').value = '';
                    document.getElementById('taskAnswerNum2').value = '';
                    document.getElementById('taskAnswerDenCommon2').value = '';
                    document.getElementById('taskAnswerIntPart').value = '';
                    document.getElementById('taskAnswerNumMixed').value = '';
                    document.getElementById('taskAnswerDenMixed').value = '';
                    if (isCommonDenom) {
                        document.getElementById('taskCommonDenomFrac1').innerHTML = t.display_frac1 || '';
                        document.getElementById('taskCommonDenomFrac2').innerHTML = t.display_frac2 || '';
                    }
                    if (isMixedFraction) {
                        var mixedDisp = document.getElementById('taskMixedFracDisplay');
                        var addSubDisp = document.getElementById('taskAddSubFracDisplay');
                        var mixedLabel = document.getElementById('taskMixedFractionLabel');
                        if (t.answer_type === 'add_sub_fractions') {
                            addSubDisp.style.display = '';
                            addSubDisp.innerHTML = (t.display_frac1 || '') + ' <span class="task-add-sub-op">' + (t.display_operator || '+') + '</span> ' + (t.display_frac2 || '');
                            mixedDisp.style.display = 'none';
                            mixedDisp.innerHTML = '';
                            if (mixedLabel) mixedLabel.textContent = '–í–∞—à –æ—Ç–≤–µ—Ç (–Ω–µ—Å–æ–∫—Ä–∞—Ç–∏–º–∞—è –¥—Ä–æ–±—å, —Ü–µ–ª–∞—è —á–∞—Å—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å):';
                            var intPartInput = document.getElementById('taskAnswerIntPart');
                            if (t.int_part_zero) {
                                intPartInput.disabled = true;
                                intPartInput.value = '0';
                                intPartInput.setAttribute('readonly', 'readonly');
                                intPartInput.classList.add('task-int-part-disabled');
                            } else {
                                intPartInput.disabled = false;
                                intPartInput.removeAttribute('readonly');
                                intPartInput.classList.remove('task-int-part-disabled');
                            }
                        } else {
                            addSubDisp.style.display = 'none';
                            addSubDisp.innerHTML = '';
                            mixedDisp.style.display = '';
                            mixedDisp.innerHTML = t.display_frac ? ('–î—Ä–æ–±—å: ' + t.display_frac) : '';
                            if (mixedLabel) mixedLabel.textContent = '–í–∞—à –æ—Ç–≤–µ—Ç (—Å–º–µ—à–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ):';
                            var intPartInput = document.getElementById('taskAnswerIntPart');
                            intPartInput.disabled = false;
                            intPartInput.removeAttribute('readonly');
                            intPartInput.classList.remove('task-int-part-disabled');
                        }
                    }
                    if (isFraction) {
                        document.getElementById('taskAnswerNum').focus();
                    } else if (isCommonDenom) {
                        document.getElementById('taskAnswerNum1').focus();
                    } else if (isMixedFraction) {
                        if (t.answer_type === 'add_sub_fractions' && t.int_part_zero) {
                            document.getElementById('taskAnswerNumMixed').focus();
                        } else {
                            document.getElementById('taskAnswerIntPart').focus();
                        }
                    } else {
                        document.getElementById('taskAnswerInput').focus();
                    }
                    if (data.current_energy !== undefined) {
                        var ed = document.getElementById('energyDisplay');
                        if (ed) ed.textContent = data.current_energy;
                    }
                    window.territoryFocusProtection && window.territoryFocusProtection.arm();
                } else {
                    if (data.error && (data.current_energy === undefined) && data.error.indexOf('—ç–Ω–µ—Ä–≥') !== -1) {
                        closeTaskModal();
                        showEnergyModal(data.error);
                    } else {
                        document.getElementById('taskModalTitle').textContent = '–û—à–∏–±–∫–∞';
                        document.getElementById('taskModalText').textContent = (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É.');
                    }
                }
            })
            .catch(function() {
                document.getElementById('taskModalTitle').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('taskModalText').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É.';
            });
    }

    function closeTaskModal() {
        document.getElementById('taskModal').classList.remove('open');
        state.currentRegionId = null;
        window._currentTask = null;
        window.territoryFocusProtection && window.territoryFocusProtection.disarm();
    }

    function showEnergyModal(message) {
        document.getElementById('energyModalText').textContent = message || '–≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç (+20% –æ—Ç –º–∞–∫—Å.).';
        document.getElementById('energyModal').classList.add('open');
    }
    function closeEnergyModal() {
        document.getElementById('energyModal').classList.remove('open');
    }

    function showToast(message, isCorrect) {
        const el = document.getElementById('taskResultToast');
        el.textContent = message;
        el.className = 'task-result-toast show ' + (isCorrect ? 'correct' : 'wrong');
        setTimeout(function() {
            el.classList.remove('show');
        }, 2500);
    }

    function updatePlayerCard(data) {
        if (!data) return;
        var levelEl = document.getElementById('playerCardLevel');
        if (levelEl && data.player_level !== undefined) levelEl.textContent = '–£—Ä. ' + data.player_level;
        var xpWrap = document.getElementById('playerCardXpWrap');
        if (xpWrap && data.player_xp_in_level !== undefined && data.player_xp_needed !== undefined) {
            xpWrap.title = '–û–ø—ã—Ç: ' + data.player_xp_in_level + ' / ' + data.player_xp_needed;
        }
        var xpFill = document.getElementById('playerCardXpFill');
        if (xpFill && data.player_xp_pct !== undefined) xpFill.style.width = data.player_xp_pct + '%';
        var dmgEl = document.getElementById('playerCardDamage');
        if (dmgEl && data.player_damage !== undefined) dmgEl.textContent = data.player_damage;
        var defEl = document.getElementById('playerCardDefense');
        if (defEl && data.player_defense !== undefined) defEl.textContent = data.player_defense;
    }

    function submitTaskAnswer(regionId, taskId, answer) {
        const r = state.regions[regionId];
        fetch('{{ url_for("api_territory_apply_action") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ region_index: regionId, task_id: taskId, answer: answer })
        }).then(function(res) { return res.json().then(function(d) { return { data: d, ok: res.ok }; }); }).then(function(result) {
            var data = result.data;
            if (!result.ok && !data.success && data.error) {
                showToast(data.error || '–û—à–∏–±–∫–∞', false);
                return;
            }
            if (data.success && data.current_energy !== undefined) {
                var ed = document.getElementById('energyDisplay');
                if (ed) ed.textContent = data.current_energy;
            }
            if (data.success && data.owner_clan_id !== undefined) {
                r.ownerId = data.owner_clan_id;
                r.strength = data.strength != null ? data.strength : r.strength;
                for (let i = 0; i < state.regions.length; i++) updateRegionUI(i);
                renderGlobalProgress();
            }
            if (data.correct) {
                closeTaskModal();
                var msg = '–í–µ—Ä–Ω–æ!';
                if (data.xp_gained) msg += ' +' + data.xp_gained + ' –æ–ø—ã—Ç–∞';
                if (data.nums_gained) msg += ' +' + data.nums_gained + ' –ù—É–º–æ–≤';
                if (data.leveled_up) msg += ' –£—Ä–æ–≤–µ–Ω—å ' + data.level + '!';
                showToast(msg, true);
                updatePlayerCard(data);
            } else {
                showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', false);
            }
        }).catch(function() {
            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.', false);
        });
    }

    document.getElementById('territoryMap').addEventListener('click', function(e) {
        if (window._territoryMapDidPan) {
            window._territoryMapDidPan = false;
            return;
        }
        const g = e.target.closest('.region');
        if (!g || g.classList.contains('region-inactive')) return;
        const regionId = parseInt(g.getAttribute('data-region-id'), 10);
        if (window._territoryMapCenterRegion) window._territoryMapCenterRegion(regionId);
        setTimeout(function() {
            if (!captureEnabled) {
                showToast('–ó–∞—Ö–≤–∞—Ç –æ–±–ª–∞—Å—Ç–µ–π –æ—Ç–∫–ª—é—á—ë–Ω. –û–∂–∏–¥–∞–π—Ç–µ –≤—Ä–µ–º–µ–Ω–∏ —Å—Ç–∞—Ä—Ç–∞.', false);
                return;
            }
            if (!isAuthenticated) {
                showToast('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ –±–∏—Ç–≤–µ.', false);
                return;
            }
            if (!playerClanId) {
                showToast('–í–∞–º –Ω—É–∂–µ–Ω –∫–ª–∞–Ω –¥–ª—è —É—á–∞—Å—Ç–∏—è. –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –≤—Å—Ç—É–ø–∏—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.', false);
                return;
            }
            openConfirmModal(regionId);
        }, 420);
    });

    document.getElementById('territoryConfirmYes').addEventListener('click', function() {
        const regionId = _pendingConfirmRegionId;
        closeConfirmModal();
        if (regionId !== null) openTaskModal(regionId);
    });
    document.getElementById('territoryConfirmNo').addEventListener('click', function() {
        closeConfirmModal();
    });

    document.getElementById('submitTaskBtn').addEventListener('click', function() {
        const regionId = state.currentRegionId;
        const task = window._currentTask;
        if (regionId === null || !task || !playerClanId) {
            closeTaskModal();
            return;
        }
        var answer;
        if (task.answer_type === 'fraction') {
            var n = document.getElementById('taskAnswerNum').value.trim();
            var d = document.getElementById('taskAnswerDen').value.trim();
            if (d === '' || d === '0') d = '1';
            answer = n + '|' + d;
        } else if (task.answer_type === 'common_denominator') {
            var n1 = document.getElementById('taskAnswerNum1').value.trim();
            var d1 = document.getElementById('taskAnswerDenCommon').value.trim();
            var n2 = document.getElementById('taskAnswerNum2').value.trim();
            var d2 = document.getElementById('taskAnswerDenCommon2').value.trim();
            if (d1 === '' || d1 === '0') d1 = '1';
            if (d2 === '' || d2 === '0') d2 = '1';
            answer = n1 + '|' + d1 + '|' + n2 + '|' + d2;
        } else if (task.answer_type === 'mixed_fraction' || task.answer_type === 'add_sub_fractions') {
            var iPart = document.getElementById('taskAnswerIntPart').value.trim();
            var nMix = document.getElementById('taskAnswerNumMixed').value.trim();
            var dMix = document.getElementById('taskAnswerDenMixed').value.trim();
            if (dMix === '' || dMix === '0') dMix = '1';
            answer = iPart + '|' + nMix + '|' + dMix;
        } else {
            answer = document.getElementById('taskAnswerInput').value;
        }
        closeTaskModal();
        submitTaskAnswer(regionId, task.id, answer);
    });

    document.getElementById('taskModal').addEventListener('click', function(e) {
        if (e.target === this) closeTaskModal();
    });

    document.getElementById('energyModalOk').addEventListener('click', closeEnergyModal);
    document.getElementById('energyModal').addEventListener('click', function(e) {
        if (e.target === this) closeEnergyModal();
    });

    function onTaskAnswerKeydown(e) {
        if (e.key === 'Enter') document.getElementById('submitTaskBtn').click();
    }
    document.getElementById('taskAnswerInput').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerNum').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerDen').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerNum1').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerDenCommon').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerNum2').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerDenCommon2').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerIntPart').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerNumMixed').addEventListener('keydown', onTaskAnswerKeydown);
    document.getElementById('taskAnswerDenMixed').addEventListener('keydown', onTaskAnswerKeydown);

    if (captureEnabled) {
        renderGlobalProgress();
        if (captureEndTimeMs) {
            (function runEndCountdown() {
                var serverTimeOffsetMs = 0;
                function updateEndCountdown() {
                    var el = document.getElementById('battleEndCountdownDisplay');
                    if (!el) return;
                    var nowMs = Date.now() + serverTimeOffsetMs;
                    var diff = captureEndTimeMs - nowMs;
                    if (diff <= 0) {
                        el.textContent = '–ë–∏—Ç–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                        return;
                    }
                    var sec = Math.floor(diff / 1000) % 60;
                    var min = Math.floor(diff / 60000) % 60;
                    var hr = Math.floor(diff / 3600000);
                    el.textContent = (hr < 10 ? '0' : '') + hr + ':' + (min < 10 ? '0' : '') + min + ':' + (sec < 10 ? '0' : '') + sec;
                }
                fetch('/api/territory-battle/server-time')
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data && data.server_time_ms) {
                            serverTimeOffsetMs = data.server_time_ms - Date.now();
                        }
                        updateEndCountdown();
                        setInterval(updateEndCountdown, 1000);
                    })
                    .catch(function() {
                        updateEndCountdown();
                        setInterval(updateEndCountdown, 1000);
                    });
            })();
        }
    } else if (captureStartTimeMs) {
        (function runCountdown() {
            var serverTimeOffsetMs = 0;
            var blockEl = document.getElementById('captureCountdownBlock');
            function updateCountdown() {
                var el = document.getElementById('captureCountdownDisplay');
                if (!el || !blockEl) return;
                var nowMs = Date.now() + serverTimeOffsetMs;
                var diff = captureStartTimeMs - nowMs;
                if (diff <= 0) {
                    blockEl.style.display = 'none';
                    return;
                }
                var sec = Math.floor(diff / 1000) % 60;
                var min = Math.floor(diff / 60000) % 60;
                var hr = Math.floor(diff / 3600000);
                el.textContent = (hr < 10 ? '0' : '') + hr + ':' + (min < 10 ? '0' : '') + min + ':' + (sec < 10 ? '0' : '') + sec;
            }
            fetch('/api/territory-battle/server-time')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data && data.server_time_ms) {
                        serverTimeOffsetMs = data.server_time_ms - Date.now();
                    }
                    updateCountdown();
                    if (blockEl && blockEl.style.display !== 'none') {
                        setInterval(updateCountdown, 1000);
                    }
                })
                .catch(function() {
                    updateCountdown();
                    if (blockEl && blockEl.style.display !== 'none') {
                        setInterval(updateCountdown, 1000);
                    }
                });
        })();
    }

    document.querySelectorAll('.region').forEach(function(g, i) {
        updateRegionUI(i);
    });
})();

{% if user_logged_in and current_user.clan_id %}
(function battleClanChat() {
    var container = document.getElementById('battleClanChatMessages');
    if (!container) return;
    var input = document.getElementById('battleClanChatInput');
    var sendBtn = document.getElementById('battleClanChatSendBtn');
    var modal = document.getElementById('battleClanChatModal');
    var closeBtn = document.getElementById('battleClanChatModalClose');
    var openBtn = document.getElementById('battleFloatingChatBtn');
    var chatUrl = '{{ url_for("api_clan_chat_list") }}';
    var currentUserId = {{ current_user.id }};
    var chatMessages = [];
    var hasMore = false;
    var loading = false;
    var loadingMore = false;

    function formatTime(iso) {
        if (!iso) return '';
        var d = new Date(iso);
        return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
            d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }
    function msgToHtml(m) {
        var ownClass = (m.user_id === currentUserId) ? ' clan-chat-msg-own' : '';
        return '<div class="clan-chat-msg' + ownClass + '" data-id="' + m.id + '">' +
            '<span class="chat-author">' + escapeHtml(m.author_name) + '</span>' +
            '<span class="chat-time">' + escapeHtml(formatTime(m.created_at)) + '</span>' +
            '<div class="chat-text">' + escapeHtml(m.text) + '</div></div>';
    }
    function renderAll() {
        if (chatMessages.length === 0) {
            container.innerHTML = '<div class="clan-chat-empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
            return;
        }
        container.innerHTML = chatMessages.map(msgToHtml).join('');
        container.scrollTop = container.scrollHeight;
    }
    function appendMessages(newMsgs) {
        if (!newMsgs || newMsgs.length === 0) return;
        var wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 20;
        var emptyEl = container.querySelector('.clan-chat-empty');
        if (emptyEl) {
            container.innerHTML = newMsgs.map(msgToHtml).join('');
        } else {
            newMsgs.forEach(function(m) {
                container.insertAdjacentHTML('beforeend', msgToHtml(m));
            });
        }
        if (wasAtBottom) container.scrollTop = container.scrollHeight;
    }
    function loadChat(appendNewOnly) {
        if (appendNewOnly) {
            if (chatMessages.length === 0) return;
            var newestId = chatMessages[chatMessages.length - 1].id;
            fetch(chatUrl + '?after_id=' + newestId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success && data.messages && data.messages.length > 0) {
                        data.messages.forEach(function(m) { chatMessages.push(m); });
                        appendMessages(data.messages);
                    }
                });
            return;
        }
        if (loading) return;
        loading = true;
        fetch(chatUrl + '?limit=20')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading = false;
                if (data.success) {
                    chatMessages = data.messages || [];
                    hasMore = !!data.has_more;
                    renderAll();
                } else {
                    container.innerHTML = '<div class="clan-chat-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
                }
            })
            .catch(function() {
                loading = false;
                if (container.querySelector('.clan-chat-empty') && container.textContent.indexOf('–ó–∞–≥—Ä—É–∑–∫–∞') !== -1)
                    container.innerHTML = '<div class="clan-chat-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
            });
    }
    function sendMessage() {
        var text = (input && input.value || '').trim();
        if (!text) return;
        if (sendBtn) sendBtn.disabled = true;
        fetch(chatUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (sendBtn) sendBtn.disabled = false;
                if (data.success && data.message) {
                    input.value = '';
                    chatMessages.push(data.message);
                    appendMessages([data.message]);
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            })
            .catch(function() {
                if (sendBtn) sendBtn.disabled = false;
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
    }

    loadChat();
    setInterval(function() { loadChat(true); }, 10000);
    if (sendBtn) sendBtn.addEventListener('click', sendMessage);
    if (input) input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
    });

    function openModal() {
        var taskModalEl = document.getElementById('taskModal');
        if (taskModalEl && taskModalEl.classList.contains('open')) return;
        if (modal) {
            modal.classList.add('open');
            loadChat();
            setTimeout(function() {
                var el = document.getElementById('battleClanChatMessages');
                if (el) el.scrollTop = el.scrollHeight;
            }, 50);
        }
    }
    function closeModal() {
        if (modal) modal.classList.remove('open');
    }
    if (openBtn) openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (modal) modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
})();
{% endif %}
</script>
{% endblock %}
