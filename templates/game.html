{% extends "base.html" %}

{% block title %}{{ class_obj.name }} - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<style>
.class-info {
    position: fixed;
    top: 120px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(42, 42, 42, 0.95);
    border: 2px solid #4CAF50;
    border-radius: 10px;
    padding: 12px 25px;
    z-index: 50;
    text-align: center;
}

.class-info h2 {
    color: #fff;
    margin-bottom: 10px;
    font-size: 24px;
}

.balance-info {
    display: flex;
    gap: 50px;
    justify-content: center;
}

.balance-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.balance-label {
    color: #aaa;
    font-size: 14px;
}

.balance-value {
    color: #4CAF50;
    font-size: 36px;
    font-weight: bold;
}

.balance-item:last-child .balance-value {
    color: #f44336;
}

@media (max-width: 768px) {
    .class-info {
        top: 80px;
        padding: 10px 15px;
    }
    
    .balance-info {
        gap: 40px;
    }
    
    .balance-value {
        font-size: 28px;
    }
}

.results-btn {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #fff;
    cursor: pointer;
    z-index: 100;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    background-color: #4CAF50;
    color: white;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.results-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    background-color: #45a049;
}

.results-btn:active {
    transform: scale(0.95);
}

.random-student-btn {
    position: fixed;
    bottom: 170px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #fff;
    cursor: pointer;
    z-index: 100;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    background-color: #4CAF50;
    color: white;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.random-student-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    background-color: #45a049;
}

.random-student-btn:active {
    transform: scale(0.95);
}

.microphone-btn {
    position: fixed;
    bottom: 30px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #fff;
    background-color: #4CAF50;
    color: white;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

.microphone-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    background-color: #45a049;
}

.microphone-btn:active {
    transform: scale(0.95);
}

.microphone-btn.active {
    background-color: #f44336;
    animation: pulse 1.5s infinite;
}

.microphone-btn.active:hover {
    background-color: #da190b;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    50% {
        box-shadow: 0 4px 20px rgba(244, 67, 54, 0.6);
    }
}

.noise-level-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(42, 42, 42, 0.95);
    border: 2px solid #4CAF50;
    border-radius: 10px;
    padding: 15px 30px;
    min-width: 600px;
    z-index: 99;
}

.noise-level-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.noise-level-label {
    color: #fff;
    font-size: 18px;
    text-align: center;
    flex: 1;
}

.noise-settings-btn {
    background: transparent;
    border: 2px solid #4CAF50;
    border-radius: 5px;
    color: #4CAF50;
    font-size: 18px;
    padding: 5px 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: 10px;
}

.noise-settings-btn:hover {
    background-color: #4CAF50;
    color: #fff;
    transform: scale(1.1);
}

.settings-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.settings-form label {
    color: #fff;
    font-size: 16px;
    font-weight: bold;
}

.settings-input {
    padding: 10px;
    font-size: 18px;
    border: 2px solid #4CAF50;
    border-radius: 5px;
    background-color: #2a2a2a;
    color: #fff;
    width: 100%;
    box-sizing: border-box;
}

.settings-input:focus {
    outline: none;
    border-color: #45a049;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
}

.settings-range {
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: #2a2a2a;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
}

.settings-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4CAF50;
    cursor: pointer;
    border: 2px solid #fff;
    transition: background 0.3s ease;
}

.settings-range::-webkit-slider-thumb:hover {
    background: #45a049;
}

.settings-range::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #4CAF50;
    cursor: pointer;
    border: 2px solid #fff;
    transition: background 0.3s ease;
}

.settings-range::-moz-range-thumb:hover {
    background: #45a049;
}

.sensitivity-value-display {
    text-align: center;
    margin: 10px 0;
}

.sensitivity-value-display span {
    color: #4CAF50;
    font-size: 24px;
    font-weight: bold;
}

.settings-hint {
    color: #aaa;
    font-size: 14px;
    margin: 0;
}

.settings-save-btn {
    padding: 12px 30px;
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    background-color: #4CAF50;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.settings-save-btn:hover {
    background-color: #45a049;
}

/* –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ */
.violation-alert {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(244, 67, 54, 0.95);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: violationPulse 0.5s ease-in-out;
}

.violation-alert.show {
    display: flex;
}

@keyframes violationPulse {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.violation-alert-content {
    text-align: center;
    color: #fff;
    animation: violationShake 0.5s ease-in-out;
}

@keyframes violationShake {
    0%, 100% {
        transform: translateX(0);
    }
    10%, 30%, 50%, 70%, 90% {
        transform: translateX(-10px);
    }
    20%, 40%, 60%, 80% {
        transform: translateX(10px);
    }
}

.violation-icon {
    font-size: 120px;
    margin-bottom: 30px;
    animation: violationBlink 1s ease-in-out infinite;
}

@keyframes violationBlink {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.1);
    }
}

.violation-title {
    font-size: 72px;
    font-weight: bold;
    margin: 0 0 20px 0;
    text-shadow: 0 0 20px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 255, 255, 0.5);
    letter-spacing: 5px;
}

.violation-message {
    font-size: 36px;
    margin: 0;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
}

@media (max-width: 768px) {
    .violation-icon {
        font-size: 80px;
        margin-bottom: 20px;
    }
    
    .violation-title {
        font-size: 48px;
        letter-spacing: 3px;
    }
    
    .violation-message {
        font-size: 24px;
    }
}

@media (max-width: 480px) {
    .violation-icon {
        font-size: 60px;
        margin-bottom: 15px;
    }
    
    .violation-title {
        font-size: 36px;
        letter-spacing: 2px;
    }
    
    .violation-message {
        font-size: 18px;
    }
}

.noise-level-bar-container {
    width: 100%;
    height: 40px;
    background-color: #2a2a2a;
    border: 2px solid #555;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 10px;
}

.noise-level-bar {
    height: 100%;
    background: #4CAF50; /* –¶–≤–µ—Ç –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript */
    width: 0%;
    transition: width 0.1s ease, background-color 0.2s ease;
    border-radius: 20px;
}

.noise-level-value {
    color: #4CAF50;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
}

@media (max-width: 768px) {
    .microphone-btn {
        width: 50px;
        height: 50px;
        font-size: 24px;
        bottom: 20px;
        right: 20px;
    }
    
    .random-student-btn {
        width: 50px;
        height: 50px;
        font-size: 24px;
        bottom: 20px;
        right: 80px;
        border-width: 2px;
    }
    
    .results-btn {
        width: 50px;
        height: 50px;
        font-size: 24px;
        bottom: 20px;
        right: 140px;
        border-width: 2px;
    }
    
    .students-lottery-btn {
        right: 200px;
        bottom: 20px;
    }
    
    .students-shop-btn {
        right: 260px;
        bottom: 20px;
    }
    
    .noise-level-container {
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 100px);
        max-width: 500px;
        min-width: auto;
        padding: 10px 15px;
    }
    
    .noise-level-label {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .noise-level-bar-container {
        height: 30px;
        border-radius: 15px;
        margin-bottom: 8px;
    }
    
    .noise-level-bar {
        border-radius: 15px;
    }
    
    .noise-level-value {
        font-size: 18px;
    }
}

@media (max-width: 480px) {
    .noise-level-container {
        bottom: 10px;
        width: calc(100% - 80px);
        padding: 8px 12px;
    }
    
    .noise-level-label {
        font-size: 12px;
        margin-bottom: 6px;
    }
    
    .noise-level-bar-container {
        height: 25px;
        border-radius: 12px;
        margin-bottom: 6px;
    }
    
    .noise-level-bar {
        border-radius: 12px;
    }
    
    .noise-level-value {
        font-size: 16px;
    }
    
    .microphone-btn {
        width: 45px;
        height: 45px;
        font-size: 20px;
        bottom: 15px;
        right: 15px;
    }
    
    .random-student-btn {
        width: 45px;
        height: 45px;
        font-size: 20px;
        bottom: 15px;
        right: 65px;
        border-width: 2px;
    }
    
    .results-btn {
        width: 45px;
        height: 45px;
        font-size: 20px;
        bottom: 15px;
        right: 115px;
        border-width: 2px;
    }
    
    .students-lottery-btn {
        right: 165px;
        bottom: 15px;
    }
    
    .students-shop-btn {
        right: 215px;
        bottom: 15px;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —É—á–∞—â–µ–≥–æ—Å—è */
.random-student-modal {
    max-width: 600px;
}

.random-student-container {
    text-align: center;
    padding: 20px 0;
}

.student-selector {
    position: relative;
    margin: 30px auto;
    width: 300px;
    height: 300px;
}

.selector-wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 8px solid var(--student-glow-border, #4CAF50);
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    box-shadow:
        0 10px 30px rgba(0, 0, 0, 0.3),
        0 0 28px var(--student-glow-shadow, rgba(76, 175, 80, 0.35));
    transition: transform 0.1s linear;
}

.selector-wheel::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
        from 0deg,
        #4CAF50 0deg 30deg,
        #45a049 30deg 60deg,
        #4CAF50 60deg 90deg,
        #45a049 90deg 120deg,
        #4CAF50 120deg 150deg,
        #45a049 150deg 180deg,
        #4CAF50 180deg 210deg,
        #45a049 210deg 240deg,
        #4CAF50 240deg 270deg,
        #45a049 270deg 300deg,
        #4CAF50 300deg 330deg,
        #45a049 330deg 360deg
    );
    animation: spin 2s linear infinite;
    opacity: 0.3;
}

.selector-wheel.spinning {
    animation: spin-fast 0.5s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes spin-fast {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.selected-student-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 50%;
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow:
        0 5px 20px rgba(0, 0, 0, 0.3),
        0 0 22px var(--student-glow-shadow, rgba(76, 175, 80, 0.25));
    border: 4px solid var(--student-glow-border, #4CAF50);
}

.student-name-large {
    font-size: 32px;
    font-weight: bold;
    color: #333;
    text-align: center;
    padding: 20px;
    animation: pulse-name 1.5s ease-in-out infinite;
}

@keyframes pulse-name {
    0%, 100% {
        transform: scale(1);
        color: #333;
    }
    50% {
        transform: scale(1.1);
        color: var(--student-glow-border, #4CAF50);
    }
}

.student-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
}

.confirm-student-btn, .reroll-student-btn {
    padding: 15px 30px;
    font-size: 18px;
    font-weight: bold;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.confirm-student-btn {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: #fff;
}

.confirm-student-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
}

.reroll-student-btn {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    color: #fff;
}

.reroll-student-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
}

.student-rating-modal {
    max-width: 520px;
}

.student-rating-container {
    text-align: center;
    padding: 10px 0 0;
}

.rating-student-name {
    font-size: 22px;
    font-weight: bold;
    margin: 10px 0 20px;
    color: #333;
}

.rating-emoji-row {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin: 10px 0 5px;
}

.rating-emoji-btn {
    width: 84px;
    height: 84px;
    border-radius: 18px;
    border: 3px solid #000;
    background: linear-gradient(135deg, #ffffff 0%, #f3f3f3 100%);
    cursor: pointer;
    font-size: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.rating-emoji-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
}

.rating-emoji-btn:active {
    transform: translateY(-1px) scale(1.02);
}

.rating-hint {
    margin-top: 14px;
    font-size: 14px;
    color: #777;
}

@media (max-width: 768px) {
    .random-student-modal {
        max-width: 95%;
        padding: 20px;
    }
    
    .student-selector {
        width: 250px;
        height: 250px;
    }
    
    .selected-student-display {
        width: 160px;
        height: 160px;
    }
    
    .student-name-large {
        font-size: 24px;
        padding: 15px;
    }
    
    .student-actions {
        flex-direction: column;
    }
    
    .confirm-student-btn, .reroll-student-btn {
        width: 100%;
        padding: 12px 20px;
        font-size: 16px;
    }
    
    .rating-emoji-btn {
        width: 72px;
        height: 72px;
        font-size: 40px;
    }
}

@media (max-width: 480px) {
    .student-selector {
        width: 200px;
        height: 200px;
    }
    
    .selected-student-display {
        width: 130px;
        height: 130px;
    }
    
    .student-name-large {
        font-size: 20px;
        padding: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <button class="control-btn green-btn" id="greenBtn"></button>
    <button class="control-btn red-btn" id="redBtn"></button>
    
    <!-- –°–∏–≥–Ω–∞–ª—å–Ω—ã–µ –∫—Ä—É–≥–∏ -->
    <div class="signal-circles">
        <div class="signal-circle" data-index="0"></div>
        <div class="signal-circle" data-index="1"></div>
        <div class="signal-circle" data-index="2"></div>
        <div class="signal-circle" data-index="3"></div>
        <div class="signal-circle" data-index="4"></div>
    </div>
    
    <div class="cave-container">
        <img src="{{ url_for('static', filename='peshhera.png') }}" alt="–ü–µ—â–µ—Ä–∞" class="cave-image">
        <img src="{{ url_for('static', filename='valera.png') }}" alt="–í–∞–ª–µ—Ä–∞" class="valera-image">
        <img src="{{ url_for('static', filename='reshetka.png') }}" alt="–†–µ—à–µ—Ç–∫–∞" class="grill-image">
        <div class="game-over-text" id="gameOverText">–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!</div>
    </div>
    <button class="restart-btn" id="restartBtn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Å–µ -->
    <div class="class-info">
        <div class="balance-info">
            <div class="balance-item">
                <span class="balance-value" id="studentsBalance">{{ class_obj.students_balance }}</span>
            </div>
            <div class="balance-item">
                <span class="balance-value" id="valeraBalance">{{ class_obj.valera_balance }}</span>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ -->
    <button class="shop-icon-btn students-shop-btn" id="studentsShopBtn" title="–ú–∞–≥–∞–∑–∏–Ω –¥–ª—è —É—á–∞—â–∏—Ö—Å—è">üõí</button>
    <button class="shop-icon-btn students-lottery-btn" id="studentsLotteryBtn" title="–õ–∞–≤–∫–∞ –¥–ª—è —É—á–∞—â–∏—Ö—Å—è">üé≤</button>
    <button class="shop-icon-btn valera-shop-btn" id="valeraShopBtn" title="–õ–∞–≤–∫–∞ –í–∞–ª–µ—Ä—ã">üé≤</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ -->
    <button class="results-btn" id="resultsBtn" title="–ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏ (F)">üìä</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —É—á–∞—â–µ–≥–æ—Å—è -->
    <button class="random-student-btn" id="randomStudentBtn" title="–í—ã–±—Ä–∞—Ç—å —É—á–∞—â–µ–≥–æ—Å—è">üéØ</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è —à—É–º–∞ -->
    <button class="microphone-btn" id="microphoneBtn" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞">üé§</button>
    <div class="noise-level-container" id="noiseLevelContainer" style="display: none;">
        <div class="noise-level-header">
            <div class="noise-level-label">–£—Ä–æ–≤–µ–Ω—å —à—É–º–∞:</div>
            <button class="noise-settings-btn" id="noiseSettingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
        </div>
        <div class="noise-level-bar-container">
            <div class="noise-level-bar" id="noiseLevelBar"></div>
        </div>
        <div class="noise-level-value" id="noiseLevelValue">0%</div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É—Ä–æ–≤–Ω—è —à—É–º–∞ -->
    <div class="modal-overlay" id="noiseSettingsModal">
        <div class="modal-content">
            <button class="modal-close" id="closeNoiseSettingsModal">&times;</button>
            <h2 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω—è —à—É–º–∞</h2>
            <div class="settings-form">
                <label for="thresholdInput">–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (%):</label>
                <input type="number" id="thresholdInput" min="0" max="100" value="80" class="settings-input">
                <p class="settings-hint">–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π –∫—Ä—É–≥. –°–ª–µ–¥—É—é—â–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –Ω–µ —Ä–∞–Ω—å—à–µ, —á–µ–º —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.</p>
                
                <label for="sensitivityInput">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (%):</label>
                <input type="range" id="sensitivityInput" min="10" max="200" value="100" step="10" class="settings-range">
                <div class="sensitivity-value-display">
                    <span id="sensitivityValue">100%</span>
                </div>
                <p class="settings-hint">–†–µ–≥—É–ª–∏—Ä—É–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞. –ß–µ–º –≤—ã—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–µ–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.</p>
                
                <button class="settings-save-btn" id="saveNoiseSettingsBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ -->
    <div class="violation-alert" id="violationAlert">
        <div class="violation-alert-content">
            <div class="violation-icon">‚ö†Ô∏è</div>
            <h1 class="violation-title">–ù–ê–†–£–®–ï–ù–ò–ï!</h1>
            <p class="violation-message">–ü—Ä–µ–≤—ã—à–µ–Ω –¥–æ–ø—É—Å—Ç–∏–º—ã–π —É—Ä–æ–≤–µ–Ω—å —à—É–º–∞</p>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–∞–π—Å–æ–º -->
    <div class="modal-overlay" id="priceModal">
        <div class="modal-content">
            <button class="modal-close" id="closeModal">&times;</button>
            <h2 class="modal-title">–ü—Ä–∞–π—Å</h2>
            <ul class="price-list" id="priceList">
                {% for item in shop_items %}
                <li class="price-item" data-item-id="{{ item.id }}" data-item-price="{{ item.price }}" data-item-name="{{ item.name }}">
                    <span class="price-name">{{ item.name }}</span>
                    <span class="price-value">{{ item.price }} –º–æ–Ω–µ—Ç</span>
                </li>
                {% endfor %}
            </ul>
            <div style="margin-top: 20px; text-align: center;">
                <div style="color: #fff; font-size: 16px; margin-bottom: 10px;">
                    –ë–∞–ª–∞–Ω—Å —É—á–∞—â–∏—Ö—Å—è: <strong id="studentsBalanceInPriceModal">{{ class_obj.students_balance }}</strong> –º–æ–Ω–µ—Ç
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ -->
    <div class="modal-overlay" id="confirmPurchaseModal">
        <div class="modal-content">
            <button class="modal-close" id="closeConfirmPurchaseModal">&times;</button>
            <h2 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</h2>
            <div style="text-align: center; padding: 20px 0;">
                <div style="color: #fff; font-size: 20px; margin-bottom: 15px;">
                    –í—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å:
                </div>
                <div style="color: #4CAF50; font-size: 24px; font-weight: bold; margin-bottom: 20px;" id="confirmPurchaseItemName">
                    –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞
                </div>
                <div style="color: #fff; font-size: 18px; margin-bottom: 10px;">
                    –°—Ç–æ–∏–º–æ—Å—Ç—å: <span style="color: #4CAF50; font-weight: bold;" id="confirmPurchasePrice">0</span> –º–æ–Ω–µ—Ç
                </div>
                <div style="color: #aaa; font-size: 16px; margin-bottom: 20px;">
                    –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏: <span style="color: #fff; font-weight: bold;" id="confirmPurchaseBalanceAfter">0</span> –º–æ–Ω–µ—Ç
                </div>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button class="confirm-purchase-btn confirm-btn" id="confirmPurchaseBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="confirm-purchase-btn cancel-btn" id="cancelPurchaseBtn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal-content notification-modal-content">
            <button class="modal-close" id="closeNotificationModal">&times;</button>
            <div style="text-align: center; padding: 20px 0;">
                <div class="notification-icon" id="notificationIcon">‚ÑπÔ∏è</div>
                <h2 class="modal-title notification-title" id="notificationTitle">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
                <div class="notification-message" id="notificationMessage">
                    –°–æ–æ–±—â–µ–Ω–∏–µ
                </div>
            </div>
            <div style="display: flex; justify-content: center; margin-top: 30px;">
                <button class="confirm-purchase-btn confirm-btn" id="notificationOkBtn">–û–ö</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–∞—Å—á–µ—Ç–æ–º –º–æ–Ω–µ—Ç -->
    <div class="modal-overlay" id="coinsModal">
        <div class="modal-content">
            <button class="modal-close" id="closeCoinsModal">&times;</button>
            <h2 class="modal-title">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã</h2>
            <div class="coins-result">
                <div class="coins-summary-grid">
                    <div class="coins-card">
                        <div class="coins-amount" id="studentsCoinsAmount">0</div>
                        <div class="coins-label">–£—á–∞—â–∏–µ—Å—è</div>
                    </div>
                    <div class="coins-card">
                        <div class="coins-amount" id="valeraCoinsAmount">0</div>
                        <div class="coins-label">–í–∞–ª–µ—Ä–∞</div>
                    </div>
                </div>
                <div class="extra-point-checkbox">
                    <label>
                        <input type="checkbox" id="extraPointCheckbox">
                        <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–ª</span>
                    </label>
                </div>
                <button class="submit-coins-btn" id="submitCoinsBtn">–ó–∞—á–∏—Å–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ –í–∞–ª–µ—Ä—ã -->
    <div class="modal-overlay" id="shopModal">
        <div class="modal-content shop-modal-content">
            <button class="modal-close" id="closeShopModal">&times;</button>
            <h2 class="modal-title">–ú–∞–≥–∞–∑–∏–Ω –≤–∞–ª–µ—Ä—ã</h2>
            <div class="shop-price-info">
                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∑–∞: <strong>5 –º–æ–Ω–µ—Ç</strong></span>
                <span>–ë–∞–ª–∞–Ω—Å –í–∞–ª–µ—Ä—ã: <strong id="valeraBalanceInShop">{{ class_obj.valera_balance }}</strong> –º–æ–Ω–µ—Ç</span>
            </div>
            <div class="shop-grid" id="shopGrid">
                <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <button class="shop-select-btn" id="selectPrizeBtn">–í—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑ (5 –º–æ–Ω–µ—Ç)</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–∞–≤–∫–∏ –¥–ª—è —É—á–∞—â–∏—Ö—Å—è -->
    <div class="modal-overlay" id="studentsLotteryModal">
        <div class="modal-content shop-modal-content">
            <button class="modal-close" id="closeStudentsLotteryModal">&times;</button>
            <h2 class="modal-title">–õ–∞–≤–∫–∞ –¥–ª—è —É—á–∞—â–∏—Ö—Å—è</h2>
            <div class="shop-price-info">
                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∑–∞: <strong>8 –º–æ–Ω–µ—Ç</strong></span>
                <span>–ë–∞–ª–∞–Ω—Å —É—á–∞—â–∏—Ö—Å—è: <strong id="studentsBalanceInShop">{{ class_obj.students_balance }}</strong> –º–æ–Ω–µ—Ç</span>
            </div>
            <div class="shop-grid" id="studentsLotteryGrid">
                <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <button class="shop-select-btn" id="selectStudentsPrizeBtn">–í—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑ (8 –º–æ–Ω–µ—Ç)</button>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–∑–∞ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ) -->
    <div class="prize-result" id="prizeResult"></div>
    <div class="prize-result students-prize-result" id="studentsPrizeResult"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —É—á–∞—â–µ–≥–æ—Å—è -->
    <div class="modal-overlay" id="randomStudentModal">
        <div class="modal-content random-student-modal">
            <button class="modal-close" id="closeRandomStudentModal">&times;</button>
            <h2 class="modal-title">–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä —É—á–∞—â–µ–≥–æ—Å—è</h2>
            <div class="random-student-container">
                <div class="student-selector" id="studentSelector">
                    <div class="selector-wheel" id="selectorWheel"></div>
                    <div class="selected-student-display" id="selectedStudentDisplay">
                        <div class="student-name-large" id="selectedStudentName">?</div>
                    </div>
                </div>
                <div class="student-actions" id="studentActions" style="display: none;">
                    <button class="confirm-student-btn" id="confirmStudentBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    <button class="reroll-student-btn" id="rerollStudentBtn">–í—ã–±—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ü–µ–Ω–∫–∏ –æ—Ç–≤–µ—Ç–∞ —É—á–∞—â–µ–≥–æ—Å—è -->
    <div class="modal-overlay" id="studentRatingModal">
        <div class="modal-content student-rating-modal">
            <button class="modal-close" id="closeStudentRatingModal">&times;</button>
            <h2 class="modal-title">–û—Ü–µ–Ω–∫–∞ –æ—Ç–≤–µ—Ç–∞</h2>
            <div class="student-rating-container">
                <div class="rating-student-name" id="ratingStudentName">‚Äî</div>
                <div class="rating-emoji-row">
                    <button class="rating-emoji-btn" type="button" data-delta="-1" title="–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (—Ä–µ–π—Ç–∏–Ω–≥ -1)">üòû</button>
                    <button class="rating-emoji-btn" type="button" data-delta="0" title="–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)">üòê</button>
                    <button class="rating-emoji-btn" type="button" data-delta="1" title="–û—Ç–ª–∏—á–Ω–æ (—Ä–µ–π—Ç–∏–Ω–≥ +1)">üòä</button>
                </div>
                <div class="rating-hint">–í—ã–±–µ—Ä–∏—Ç–µ —Å–º–∞–π–ª–∏–∫, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —É—á–∞—â–µ–≥–æ—Å—è.</div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const CLASS_ID = {{ class_obj.id }};
        const VALERA_PRIZES = {{ valera_prizes|tojson }};
        const STUDENTS_PRIZES = {{ students_prizes|tojson }};
        const STATIC_URL = '{{ url_for("static", filename="") }}';
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ API
        async function updateBalance(studentsChange = 0, valeraChange = 0) {
            try {
                const response = await fetch(`/api/class/${CLASS_ID}/balance`);
                const data = await response.json();
                
                const newStudentsBalance = data.students_balance + studentsChange;
                const newValeraBalance = data.valera_balance + valeraChange;
                
                await fetch(`/api/class/${CLASS_ID}/balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        students_balance: newStudentsBalance,
                        valera_balance: newValeraBalance
                    })
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                document.getElementById('studentsBalance').textContent = newStudentsBalance;
                document.getElementById('valeraBalance').textContent = newValeraBalance;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                const valeraBalanceInShop = document.getElementById('valeraBalanceInShop');
                if (valeraBalanceInShop) {
                    valeraBalanceInShop.textContent = newValeraBalance;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                if (typeof updateShopButtonState === 'function') {
                    updateShopButtonState();
                }
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
        async function getBalance() {
            try {
                const response = await fetch(`/api/class/${CLASS_ID}/balance`);
                const data = await response.json();
                document.getElementById('studentsBalance').textContent = data.students_balance;
                document.getElementById('valeraBalance').textContent = data.valera_balance;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                const valeraBalanceInShop = document.getElementById('valeraBalanceInShop');
                if (valeraBalanceInShop) {
                    valeraBalanceInShop.textContent = data.valera_balance;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —É—á–∞—â–∏—Ö—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                const studentsBalanceInShop = document.getElementById('studentsBalanceInShop');
                if (studentsBalanceInShop) {
                    studentsBalanceInShop.textContent = data.students_balance;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                if (typeof updateShopButtonState === 'function') {
                    updateShopButtonState();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –ª–∞–≤–∫–µ —É—á–∞—â–∏—Ö—Å—è, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                if (typeof updateStudentsShopButtonState === 'function') {
                    updateStudentsShopButtonState();
                }
            } catch (error) {
                console.error('Error getting balance:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        getBalance();
        
        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ —É—Ä–æ–≤–Ω—è —à—É–º–∞
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let isListening = false;
        let animationFrameId = null;
        
        const microphoneBtn = document.getElementById('microphoneBtn');
        const noiseLevelContainer = document.getElementById('noiseLevelContainer');
        const noiseLevelBar = document.getElementById('noiseLevelBar');
        const noiseLevelValue = document.getElementById('noiseLevelValue');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω—è —à—É–º–∞
        let noiseThreshold = 80; // –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let microphoneSensitivity = 100; // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (100%)
        let lastWarningTime = 0; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        const WARNING_COOLDOWN = 60000; // 1 –º–∏–Ω—É—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        const NOISE_THRESHOLD_DURATION = 2000; // 2 —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è
        let violationAlertTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏
        let noiseThresholdExceededStartTime = null; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
        const noiseSettingsBtn = document.getElementById('noiseSettingsBtn');
        const noiseSettingsModal = document.getElementById('noiseSettingsModal');
        const closeNoiseSettingsModal = document.getElementById('closeNoiseSettingsModal');
        const thresholdInput = document.getElementById('thresholdInput');
        const sensitivityInput = document.getElementById('sensitivityInput');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const saveNoiseSettingsBtn = document.getElementById('saveNoiseSettingsBtn');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ localStorage
        const savedThreshold = localStorage.getItem('noiseThreshold');
        if (savedThreshold !== null) {
            noiseThreshold = parseInt(savedThreshold, 10);
            thresholdInput.value = noiseThreshold;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ localStorage
        const savedSensitivity = localStorage.getItem('microphoneSensitivity');
        if (savedSensitivity !== null) {
            microphoneSensitivity = parseInt(savedSensitivity, 10);
            sensitivityInput.value = microphoneSensitivity;
            sensitivityValue.textContent = microphoneSensitivity + '%';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–∑—É–Ω–∫–∞
        sensitivityInput.addEventListener('input', (e) => {
            sensitivityValue.textContent = e.target.value + '%';
        });
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        noiseSettingsBtn.addEventListener('click', () => {
            noiseSettingsModal.classList.add('show');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        closeNoiseSettingsModal.addEventListener('click', () => {
            noiseSettingsModal.classList.remove('show');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        noiseSettingsModal.addEventListener('click', (e) => {
            if (e.target === noiseSettingsModal) {
                noiseSettingsModal.classList.remove('show');
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        saveNoiseSettingsBtn.addEventListener('click', () => {
            const newThreshold = parseInt(thresholdInput.value, 10);
            const newSensitivity = parseInt(sensitivityInput.value, 10);
            
            if (newThreshold >= 0 && newThreshold <= 100) {
                noiseThreshold = newThreshold;
                localStorage.setItem('noiseThreshold', noiseThreshold.toString());
            } else {
                alert('–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 0 –¥–æ 100');
                return;
            }
            
            if (newSensitivity >= 10 && newSensitivity <= 200) {
                microphoneSensitivity = newSensitivity;
                localStorage.setItem('microphoneSensitivity', microphoneSensitivity.toString());
            } else {
                alert('–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 10 –¥–æ 200');
                return;
            }
            
            noiseSettingsModal.classList.remove('show');
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–≥–æ –∫—Ä—É–≥–∞
        function activateWarningCircle() {
            const signalCircles = document.querySelectorAll('.signal-circle');
            const currentTime = Date.now();
            const violationAlert = document.getElementById('violationAlert');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–∞ –ª–∏ –º–∏–Ω—É—Ç–∞ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            if (currentTime - lastWarningTime < WARNING_COOLDOWN) {
                return; // –°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä—É–≥
            for (let i = 0; i < signalCircles.length; i++) {
                if (!signalCircles[i].classList.contains('active')) {
                    signalCircles[i].classList.add('active');
                    lastWarningTime = currentTime;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏
                    if (violationAlert) {
                        violationAlert.classList.add('show');
                        
                        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                        if (violationAlertTimeout) {
                            clearTimeout(violationAlertTimeout);
                        }
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                        violationAlertTimeout = setTimeout(() => {
                            violationAlert.classList.remove('show');
                            violationAlertTimeout = null;
                        }, 10000);
                    }
                    
                    break;
                }
            }
        }
        
        async function startMicrophone() {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –∞–º–ø–ª–∏—Ç—É–¥—ã (–≥—Ä–æ–º–∫–æ—Å—Ç–∏)
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.fftSize;
                dataArray = new Uint8Array(bufferLength);
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—É
                microphone.connect(analyser);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è —à—É–º–∞
                noiseLevelContainer.style.display = 'block';
                microphoneBtn.classList.add('active');
                isListening = true;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —à—É–º–∞
                updateNoiseLevel();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        }
        
        function stopMicrophone() {
            if (microphone && microphone.mediaStream) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            analyser = null;
            microphone = null;
            dataArray = null;
            isListening = false;
            
            noiseLevelContainer.style.display = 'none';
            microphoneBtn.classList.remove('active');
            noiseLevelBar.style.width = '0%';
            noiseLevelValue.textContent = '0%';
            noiseThresholdExceededStartTime = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞
        }
        
        function updateNoiseLevel() {
            if (!isListening || !analyser || !dataArray) {
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–º–ø–ª–∏—Ç—É–¥–µ —Å–∏–≥–Ω–∞–ª–∞ (–≥—Ä–æ–º–∫–æ—Å—Ç–∏) –≤–æ –≤—Ä–µ–º–µ–Ω–∏
            analyser.getByteTimeDomainData(dataArray);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∞–º–ø–ª–∏—Ç—É–¥—É (–ø–∏–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
            let max = 0;
            for (let i = 0; i < dataArray.length; i++) {
                // –ó–Ω–∞—á–µ–Ω–∏—è –æ—Ç 0 –¥–æ 255, –≥–¥–µ 128 - —ç—Ç–æ —Ç–∏—à–∏–Ω–∞
                const amplitude = Math.abs(dataArray[i] - 128);
                if (amplitude > max) {
                    max = amplitude;
                }
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã (0-127 -> 0-100%)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω—É—é —à–∫–∞–ª—É –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            const normalized = max / 127;
            let percentage = Math.min(100, Math.round(Math.pow(normalized, 0.5) * 100));
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            percentage = Math.min(100, Math.round(percentage * (microphoneSensitivity / 100)));
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
            let barColor = '#4CAF50'; // –ó–µ–ª–µ–Ω—ã–π (—Ç–∏—Ö–æ)
            let textColor = '#4CAF50';
            
            if (percentage >= 80) {
                barColor = '#f44336'; // –ö—Ä–∞—Å–Ω—ã–π (–æ—á–µ–Ω—å –≥—Ä–æ–º–∫–æ)
                textColor = '#f44336';
            } else if (percentage >= 50) {
                barColor = '#FFC107'; // –ñ–µ–ª—Ç—ã–π (—É–º–µ—Ä–µ–Ω–Ω–æ –≥—Ä–æ–º–∫–æ)
                textColor = '#FFC107';
            } else if (percentage >= 20) {
                barColor = '#4CAF50'; // –ó–µ–ª–µ–Ω—ã–π (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
                textColor = '#4CAF50';
            } else {
                barColor = '#2196F3'; // –°–∏–Ω–∏–π (—Ç–∏—Ö–æ)
                textColor = '#2196F3';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            noiseLevelBar.style.width = percentage + '%';
            noiseLevelBar.style.background = barColor;
            noiseLevelValue.textContent = percentage + '%';
            noiseLevelValue.style.color = textColor;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
            const currentTime = Date.now();
            if (percentage >= noiseThreshold) {
                // –ï—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                if (noiseThresholdExceededStartTime === null) {
                    noiseThresholdExceededStartTime = currentTime;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ 2 —Å–µ–∫—É–Ω–¥—ã —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
                    if (currentTime - noiseThresholdExceededStartTime >= NOISE_THRESHOLD_DURATION) {
                        activateWarningCircle();
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                        noiseThresholdExceededStartTime = null;
                    }
                }
            } else {
                // –ï—Å–ª–∏ —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                noiseThresholdExceededStartTime = null;
            }
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            animationFrameId = requestAnimationFrame(updateNoiseLevel);
        }
        
        microphoneBtn.addEventListener('click', () => {
            if (isListening) {
                stopMicrophone();
            } else {
                startMicrophone();
            }
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (isListening) {
                stopMicrophone();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ script.js –∑–∞–≥—Ä—É–∂–µ–Ω
        setTimeout(() => {
            const resultsBtn = document.getElementById('resultsBtn');
            if (resultsBtn) {
                resultsBtn.addEventListener('click', () => {
                    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é showCoinsResult –∏–∑ script.js
                    if (typeof window.showCoinsResult === 'function') {
                        window.showCoinsResult();
                    } else if (typeof showCoinsResult === 'function') {
                        showCoinsResult();
                    }
                });
            }
        }, 100);
        
        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —É—á–∞—â–µ–≥–æ—Å—è
        let studentsData = [];
        let currentSelectedStudent = null;
        let isSpinning = false;
        let ratingTargetStudent = null;
        
        const randomStudentBtn = document.getElementById('randomStudentBtn');
        const randomStudentModal = document.getElementById('randomStudentModal');
        const closeRandomStudentModal = document.getElementById('closeRandomStudentModal');
        const selectorWheel = document.getElementById('selectorWheel');
        const selectedStudentName = document.getElementById('selectedStudentName');
        const studentActions = document.getElementById('studentActions');
        const confirmStudentBtn = document.getElementById('confirmStudentBtn');
        const rerollStudentBtn = document.getElementById('rerollStudentBtn');
        
        const studentRatingModal = document.getElementById('studentRatingModal');
        const closeStudentRatingModal = document.getElementById('closeStudentRatingModal');
        const ratingStudentName = document.getElementById('ratingStudentName');
        const ratingEmojiButtons = document.querySelectorAll('.rating-emoji-btn');
        
        function clamp(value, min, max) {
            return Math.min(max, Math.max(min, value));
        }
        
        function ratingToGlow(rating) {
            const MAX_ABS = 5;
            const r = clamp(parseInt(rating ?? 0, 10) || 0, -MAX_ABS, MAX_ABS);
            const t = (r + MAX_ABS) / (2 * MAX_ABS); // 0..1 (red -> green)
            
            // –ú—è–≥–∫–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è (–∫—Ä–∞—Å–Ω—ã–π -> –∑–µ–ª—ë–Ω—ã–π), 0 –¥–∞—ë—Ç –∂–µ–ª—Ç–æ–≤–∞—Ç—ã–π
            const red = { r: 255, g: 70, b: 70 };
            const green = { r: 70, g: 255, b: 120 };
            const rr = Math.round(red.r + (green.r - red.r) * t);
            const gg = Math.round(red.g + (green.g - red.g) * t);
            const bb = Math.round(red.b + (green.b - red.b) * t);
            
            // –ß–µ–º –¥–∞–ª—å—à–µ –æ—Ç 0, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ
            const intensity = 0.18 + (Math.abs(r) / MAX_ABS) * 0.35; // 0.18..0.53
            return {
                border: `rgb(${rr}, ${gg}, ${bb})`,
                shadow: `rgba(${rr}, ${gg}, ${bb}, ${intensity})`,
            };
        }
        
        function setStudentGlowByRating(rating) {
            const glow = ratingToGlow(rating);
            randomStudentModal.style.setProperty('--student-glow-border', glow.border);
            randomStudentModal.style.setProperty('--student-glow-shadow', glow.shadow);
        }
        
        function resetStudentGlow() {
            randomStudentModal.style.removeProperty('--student-glow-border');
            randomStudentModal.style.removeProperty('--student-glow-shadow');
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        randomStudentBtn.addEventListener('click', () => {
            loadStudentsAndSelect();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        closeRandomStudentModal.addEventListener('click', () => {
            closeRandomStudentModalFunc();
        });
        
        randomStudentModal.addEventListener('click', (e) => {
            if (e.target === randomStudentModal) {
                closeRandomStudentModalFunc();
            }
        });
        
        function closeRandomStudentModalFunc() {
            randomStudentModal.classList.remove('show');
            currentSelectedStudent = null;
            studentActions.style.display = 'none';
            selectedStudentName.textContent = '?';
            resetStudentGlow();
        }
        
        function openStudentRatingModal(student) {
            ratingTargetStudent = student;
            ratingStudentName.textContent = student?.name ? student.name : '‚Äî';
            studentRatingModal.classList.add('show');
        }
        
        function closeStudentRatingModalFunc() {
            studentRatingModal.classList.remove('show');
            ratingTargetStudent = null;
            ratingStudentName.textContent = '‚Äî';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—â–∏—Ö—Å—è –∏ –≤—ã–±–æ—Ä
        async function loadStudentsAndSelect() {
            try {
                const response = await fetch(`/api/class/${CLASS_ID}/students/random`);
                const data = await response.json();
                
                if (!data.success) {
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–∞—â–∏—Ö—Å—è');
                    return;
                }
                
                studentsData = data.students;
                
                if (studentsData.length === 0) {
                    alert('–í –∫–ª–∞—Å—Å–µ –Ω–µ—Ç —É—á–∞—â–∏—Ö—Å—è');
                    return;
                }
                
                randomStudentModal.classList.add('show');
                studentActions.style.display = 'none';
                selectedStudentName.textContent = '?';
                currentSelectedStudent = null;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—ã–±–æ—Ä–∞
                selectRandomStudent();
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–∞—â–∏—Ö—Å—è');
            }
        }
        
        // –í—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É—á–∞—â–µ–≥–æ—Å—è —Å –≤–µ—Å–∞–º–∏
        function selectRandomStudent() {
            if (isSpinning) return;
            
            isSpinning = true;
            selectorWheel.classList.add('spinning');
            selectedStudentName.textContent = '...';
            setStudentGlowByRating(0);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É –≤–µ—Å–æ–≤
            const totalWeight = studentsData.reduce((sum, item) => sum + item.weight, 0);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ totalWeight
            let random = Math.random() * totalWeight;
            
            // –í—ã–±–∏—Ä–∞–µ–º —É—á–∞—â–µ–≥–æ—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–æ–≤
            let selected = null;
            for (let item of studentsData) {
                random -= item.weight;
                if (random <= 0) {
                    selected = item;
                    break;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π), –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–≥–æ
            if (!selected) {
                selected = studentsData[0];
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ (2 —Å–µ–∫—É–Ω–¥—ã)
            setTimeout(() => {
                selectorWheel.classList.remove('spinning');
                currentSelectedStudent = selected;
                selectedStudentName.textContent = selected.student.name;
                studentActions.style.display = 'flex';
                isSpinning = false;
                
                // –°–≤–µ—á–µ–Ω–∏–µ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É: <0 –∫—Ä–∞—Å–Ω–µ–µ, >0 –∑–µ–ª–µ–Ω–µ–µ
                setStudentGlowByRating(selected.student.rating ?? 0);
            }, 2000);
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
        confirmStudentBtn.addEventListener('click', async () => {
            if (!currentSelectedStudent) return;
            
            try {
                const response = await fetch(`/api/class/${CLASS_ID}/students/${currentSelectedStudent.student.id}/select`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    // –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ü–µ–Ω–∫–∏ –æ—Ç–≤–µ—Ç–∞
                    openStudentRatingModal(currentSelectedStudent.student);
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞');
            }
        });
        
        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–±–æ—Ä
        rerollStudentBtn.addEventListener('click', () => {
            if (isSpinning) return;
            selectRandomStudent();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ü–µ–Ω–∫–∏
        closeStudentRatingModal.addEventListener('click', () => {
            closeStudentRatingModalFunc();
        });
        
        studentRatingModal.addEventListener('click', (e) => {
            if (e.target === studentRatingModal) {
                closeStudentRatingModalFunc();
            }
        });
        
        // –í—ã–±–æ—Ä —Å–º–∞–π–ª–∏–∫–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
        ratingEmojiButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!ratingTargetStudent) return;
                
                const delta = parseInt(btn.dataset.delta, 10);
                if (![ -1, 0, 1 ].includes(delta)) return;
                
                try {
                    const response = await fetch(`/api/class/${CLASS_ID}/students/${ratingTargetStudent.id}/rate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ delta })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        closeStudentRatingModalFunc();
                        closeRandomStudentModalFunc();
                    } else {
                        alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
                }
            });
        });
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}

