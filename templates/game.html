{% extends "base.html" %}

{% block title %}{{ class_obj.name }} - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<style>
.class-info {
    position: fixed;
    top: 120px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(42, 42, 42, 0.95);
    border: 2px solid #4CAF50;
    border-radius: 10px;
    padding: 15px 25px;
    z-index: 50;
    text-align: center;
}

.class-info h2 {
    color: #fff;
    margin-bottom: 10px;
    font-size: 24px;
}

.balance-info {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.balance-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.balance-label {
    color: #aaa;
    font-size: 14px;
}

.balance-value {
    color: #4CAF50;
    font-size: 20px;
    font-weight: bold;
}

.balance-item:last-child .balance-value {
    color: #f44336;
}

@media (max-width: 768px) {
    .class-info {
        top: 80px;
        padding: 10px 15px;
    }
    
    .class-info h2 {
        font-size: 18px;
    }
    
    .balance-info {
        gap: 15px;
    }
    
    .balance-value {
        font-size: 16px;
    }
}

.microphone-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background-color: #4CAF50;
    color: white;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 100;
}

.microphone-btn:hover {
    background-color: #45a049;
    transform: scale(1.1);
}

.microphone-btn.active {
    background-color: #f44336;
    animation: pulse 1.5s infinite;
}

.microphone-btn.active:hover {
    background-color: #da190b;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    50% {
        box-shadow: 0 4px 20px rgba(244, 67, 54, 0.6);
    }
}

.noise-level-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(42, 42, 42, 0.95);
    border: 2px solid #4CAF50;
    border-radius: 10px;
    padding: 15px 30px;
    min-width: 600px;
    z-index: 99;
}

.noise-level-label {
    color: #fff;
    font-size: 18px;
    margin-bottom: 10px;
    text-align: center;
}

.noise-level-bar-container {
    width: 100%;
    height: 40px;
    background-color: #2a2a2a;
    border: 2px solid #555;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 10px;
}

.noise-level-bar {
    height: 100%;
    background: #4CAF50; /* –¶–≤–µ—Ç –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript */
    width: 0%;
    transition: width 0.1s ease, background-color 0.2s ease;
    border-radius: 20px;
}

.noise-level-value {
    color: #4CAF50;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
}

@media (max-width: 768px) {
    .microphone-btn {
        width: 50px;
        height: 50px;
        font-size: 24px;
        bottom: 15px;
        right: 15px;
    }
    
    .noise-level-container {
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        min-width: calc(100% - 160px);
        max-width: 500px;
        padding: 12px 20px;
    }
    
    .noise-level-label {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .noise-level-bar-container {
        height: 35px;
        border-radius: 17px;
        margin-bottom: 8px;
    }
    
    .noise-level-bar {
        border-radius: 17px;
    }
    
    .noise-level-value {
        font-size: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <button class="control-btn green-btn" id="greenBtn"></button>
    <button class="control-btn red-btn" id="redBtn"></button>
    
    <!-- –°–∏–≥–Ω–∞–ª—å–Ω—ã–µ –∫—Ä—É–≥–∏ -->
    <div class="signal-circles">
        <div class="signal-circle" data-index="0"></div>
        <div class="signal-circle" data-index="1"></div>
        <div class="signal-circle" data-index="2"></div>
        <div class="signal-circle" data-index="3"></div>
        <div class="signal-circle" data-index="4"></div>
    </div>
    
    <div class="cave-container">
        <img src="{{ url_for('static', filename='peshhera.png') }}" alt="–ü–µ—â–µ—Ä–∞" class="cave-image">
        <img src="{{ url_for('static', filename='valera.png') }}" alt="–í–∞–ª–µ—Ä–∞" class="valera-image">
        <img src="{{ url_for('static', filename='reshetka.png') }}" alt="–†–µ—à–µ—Ç–∫–∞" class="grill-image">
        <div class="game-over-text" id="gameOverText">–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏!</div>
    </div>
    <button class="restart-btn" id="restartBtn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Å–µ -->
    <div class="class-info">
        <h2>{{ class_obj.name }}</h2>
        <div class="balance-info">
            <div class="balance-item">
                <span class="balance-label">–£—á–∞—â–∏–µ—Å—è:</span>
                <span class="balance-value" id="studentsBalance">{{ class_obj.students_balance }}</span>
            </div>
            <div class="balance-item">
                <span class="balance-label">–í–∞–ª–µ—Ä–∞:</span>
                <span class="balance-value" id="valeraBalance">{{ class_obj.valera_balance }}</span>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ -->
    <button class="shop-icon-btn students-shop-btn" id="studentsShopBtn" title="–ú–∞–≥–∞–∑–∏–Ω –¥–ª—è —É—á–∞—â–∏—Ö—Å—è">üõí</button>
    <button class="shop-icon-btn students-lottery-btn" id="studentsLotteryBtn" title="–õ–∞–≤–∫–∞ –¥–ª—è —É—á–∞—â–∏—Ö—Å—è">üé≤</button>
    <button class="shop-icon-btn valera-shop-btn" id="valeraShopBtn" title="–õ–∞–≤–∫–∞ –í–∞–ª–µ—Ä—ã">üé≤</button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è —à—É–º–∞ -->
    <button class="microphone-btn" id="microphoneBtn" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞">üé§</button>
    <div class="noise-level-container" id="noiseLevelContainer" style="display: none;">
        <div class="noise-level-label">–£—Ä–æ–≤–µ–Ω—å —à—É–º–∞:</div>
        <div class="noise-level-bar-container">
            <div class="noise-level-bar" id="noiseLevelBar"></div>
        </div>
        <div class="noise-level-value" id="noiseLevelValue">0%</div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø—Ä–∞–π—Å–æ–º -->
    <div class="modal-overlay" id="priceModal">
        <div class="modal-content">
            <button class="modal-close" id="closeModal">&times;</button>
            <h2 class="modal-title">–ü—Ä–∞–π—Å</h2>
            <ul class="price-list" id="priceList">
                {% for item in shop_items %}
                <li class="price-item">
                    <span class="price-name">{{ item.name }}</span>
                    <span class="price-value">{{ item.price }} –º–æ–Ω–µ—Ç</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–∞—Å—á–µ—Ç–æ–º –º–æ–Ω–µ—Ç -->
    <div class="modal-overlay" id="coinsModal">
        <div class="modal-content">
            <button class="modal-close" id="closeCoinsModal">&times;</button>
            <h2 class="modal-title">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã</h2>
            <div class="coins-result">
                <div class="coins-summary-grid">
                    <div class="coins-card">
                        <div class="coins-amount" id="studentsCoinsAmount">0</div>
                        <div class="coins-label">–£—á–∞—â–∏–µ—Å—è</div>
                    </div>
                    <div class="coins-card">
                        <div class="coins-amount" id="valeraCoinsAmount">0</div>
                        <div class="coins-label">–í–∞–ª–µ—Ä–∞</div>
                    </div>
                </div>
                <div class="extra-point-checkbox">
                    <label>
                        <input type="checkbox" id="extraPointCheckbox">
                        <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–ª</span>
                    </label>
                </div>
                <button class="submit-coins-btn" id="submitCoinsBtn">–ó–∞—á–∏—Å–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞–≥–∞–∑–∏–Ω–∞ –í–∞–ª–µ—Ä—ã -->
    <div class="modal-overlay" id="shopModal">
        <div class="modal-content shop-modal-content">
            <button class="modal-close" id="closeShopModal">&times;</button>
            <h2 class="modal-title">–ú–∞–≥–∞–∑–∏–Ω –≤–∞–ª–µ—Ä—ã</h2>
            <div class="shop-price-info">
                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∑–∞: <strong>5 –º–æ–Ω–µ—Ç</strong></span>
                <span>–ë–∞–ª–∞–Ω—Å –í–∞–ª–µ—Ä—ã: <strong id="valeraBalanceInShop">{{ class_obj.valera_balance }}</strong> –º–æ–Ω–µ—Ç</span>
            </div>
            <div class="shop-grid" id="shopGrid">
                <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <button class="shop-select-btn" id="selectPrizeBtn">–í—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑ (5 –º–æ–Ω–µ—Ç)</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–∞–≤–∫–∏ –¥–ª—è —É—á–∞—â–∏—Ö—Å—è -->
    <div class="modal-overlay" id="studentsLotteryModal">
        <div class="modal-content shop-modal-content">
            <button class="modal-close" id="closeStudentsLotteryModal">&times;</button>
            <h2 class="modal-title">–õ–∞–≤–∫–∞ –¥–ª—è —É—á–∞—â–∏—Ö—Å—è</h2>
            <div class="shop-price-info">
                <span>–°—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–∑–∞: <strong>8 –º–æ–Ω–µ—Ç</strong></span>
                <span>–ë–∞–ª–∞–Ω—Å —É—á–∞—â–∏—Ö—Å—è: <strong id="studentsBalanceInShop">{{ class_obj.students_balance }}</strong> –º–æ–Ω–µ—Ç</span>
            </div>
            <div class="shop-grid" id="studentsLotteryGrid">
                <!-- –Ø—á–µ–π–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <button class="shop-select-btn" id="selectStudentsPrizeBtn">–í—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑ (8 –º–æ–Ω–µ—Ç)</button>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–∑–∞ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ) -->
    <div class="prize-result" id="prizeResult"></div>
    <div class="prize-result students-prize-result" id="studentsPrizeResult"></div>
{% endblock %}

{% block scripts %}
    <script>
        const CLASS_ID = {{ class_obj.id }};
        const VALERA_PRIZES = {{ valera_prizes|tojson }};
        const STUDENTS_PRIZES = {{ students_prizes|tojson }};
        const STATIC_URL = '{{ url_for("static", filename="") }}';
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ API
        async function updateBalance(studentsChange = 0, valeraChange = 0) {
            try {
                const response = await fetch(`/api/class/${CLASS_ID}/balance`);
                const data = await response.json();
                
                const newStudentsBalance = data.students_balance + studentsChange;
                const newValeraBalance = data.valera_balance + valeraChange;
                
                await fetch(`/api/class/${CLASS_ID}/balance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        students_balance: newStudentsBalance,
                        valera_balance: newValeraBalance
                    })
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                document.getElementById('studentsBalance').textContent = newStudentsBalance;
                document.getElementById('valeraBalance').textContent = newValeraBalance;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                const valeraBalanceInShop = document.getElementById('valeraBalanceInShop');
                if (valeraBalanceInShop) {
                    valeraBalanceInShop.textContent = newValeraBalance;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                if (typeof updateShopButtonState === 'function') {
                    updateShopButtonState();
                }
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
        async function getBalance() {
            try {
                const response = await fetch(`/api/class/${CLASS_ID}/balance`);
                const data = await response.json();
                document.getElementById('studentsBalance').textContent = data.students_balance;
                document.getElementById('valeraBalance').textContent = data.valera_balance;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                const valeraBalanceInShop = document.getElementById('valeraBalanceInShop');
                if (valeraBalanceInShop) {
                    valeraBalanceInShop.textContent = data.valera_balance;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —É—á–∞—â–∏—Ö—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                const studentsBalanceInShop = document.getElementById('studentsBalanceInShop');
                if (studentsBalanceInShop) {
                    studentsBalanceInShop.textContent = data.students_balance;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                if (typeof updateShopButtonState === 'function') {
                    updateShopButtonState();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ –ª–∞–≤–∫–µ —É—á–∞—â–∏—Ö—Å—è, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                if (typeof updateStudentsShopButtonState === 'function') {
                    updateStudentsShopButtonState();
                }
            } catch (error) {
                console.error('Error getting balance:', error);
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        getBalance();
        
        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ —É—Ä–æ–≤–Ω—è —à—É–º–∞
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let isListening = false;
        let animationFrameId = null;
        
        const microphoneBtn = document.getElementById('microphoneBtn');
        const noiseLevelContainer = document.getElementById('noiseLevelContainer');
        const noiseLevelBar = document.getElementById('noiseLevelBar');
        const noiseLevelValue = document.getElementById('noiseLevelValue');
        
        async function startMicrophone() {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –∞–º–ø–ª–∏—Ç—É–¥—ã (–≥—Ä–æ–º–∫–æ—Å—Ç–∏)
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.fftSize;
                dataArray = new Uint8Array(bufferLength);
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –∫ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—É
                microphone.connect(analyser);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è —à—É–º–∞
                noiseLevelContainer.style.display = 'block';
                microphoneBtn.classList.add('active');
                isListening = true;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —à—É–º–∞
                updateNoiseLevel();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        }
        
        function stopMicrophone() {
            if (microphone && microphone.mediaStream) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            analyser = null;
            microphone = null;
            dataArray = null;
            isListening = false;
            
            noiseLevelContainer.style.display = 'none';
            microphoneBtn.classList.remove('active');
            noiseLevelBar.style.width = '0%';
            noiseLevelValue.textContent = '0%';
        }
        
        function updateNoiseLevel() {
            if (!isListening || !analyser || !dataArray) {
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–º–ø–ª–∏—Ç—É–¥–µ —Å–∏–≥–Ω–∞–ª–∞ (–≥—Ä–æ–º–∫–æ—Å—Ç–∏) –≤–æ –≤—Ä–µ–º–µ–Ω–∏
            analyser.getByteTimeDomainData(dataArray);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∞–º–ø–ª–∏—Ç—É–¥—É (–ø–∏–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
            let max = 0;
            for (let i = 0; i < dataArray.length; i++) {
                // –ó–Ω–∞—á–µ–Ω–∏—è –æ—Ç 0 –¥–æ 255, –≥–¥–µ 128 - —ç—Ç–æ —Ç–∏—à–∏–Ω–∞
                const amplitude = Math.abs(dataArray[i] - 128);
                if (amplitude > max) {
                    max = amplitude;
                }
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã (0-127 -> 0-100%)
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω—É—é —à–∫–∞–ª—É –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            const normalized = max / 127;
            const percentage = Math.min(100, Math.round(Math.pow(normalized, 0.5) * 100));
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
            let barColor = '#4CAF50'; // –ó–µ–ª–µ–Ω—ã–π (—Ç–∏—Ö–æ)
            let textColor = '#4CAF50';
            
            if (percentage >= 80) {
                barColor = '#f44336'; // –ö—Ä–∞—Å–Ω—ã–π (–æ—á–µ–Ω—å –≥—Ä–æ–º–∫–æ)
                textColor = '#f44336';
            } else if (percentage >= 50) {
                barColor = '#FFC107'; // –ñ–µ–ª—Ç—ã–π (—É–º–µ—Ä–µ–Ω–Ω–æ –≥—Ä–æ–º–∫–æ)
                textColor = '#FFC107';
            } else if (percentage >= 20) {
                barColor = '#4CAF50'; // –ó–µ–ª–µ–Ω—ã–π (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
                textColor = '#4CAF50';
            } else {
                barColor = '#2196F3'; // –°–∏–Ω–∏–π (—Ç–∏—Ö–æ)
                textColor = '#2196F3';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            noiseLevelBar.style.width = percentage + '%';
            noiseLevelBar.style.background = barColor;
            noiseLevelValue.textContent = percentage + '%';
            noiseLevelValue.style.color = textColor;
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            animationFrameId = requestAnimationFrame(updateNoiseLevel);
        }
        
        microphoneBtn.addEventListener('click', () => {
            if (isListening) {
                stopMicrophone();
            } else {
                startMicrophone();
            }
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (isListening) {
                stopMicrophone();
            }
        });
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
{% endblock %}

