{% extends "base.html" %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<style>
.cabinet-page { max-width: 800px; margin: 0 auto; padding: 20px; font-family: 'Comic Sans MS', Arial, sans-serif; }
.cabinet-page h1 { color: #8b6fa8; margin-bottom: 24px; }
.cabinet-section {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    border: 2px solid #d4c5b0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.cabinet-section h2 { color: #6b5b7a; margin: 0 0 16px; font-size: 1.25rem; }
.profile-row { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
.avatar-wrap { width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background: #ddd; flex-shrink: 0; }
.avatar-wrap img { width: 100%; height: 100%; object-fit: cover; }
.profile-info { flex: 1; min-width: 200px; }
.profile-info p { margin: 4px 0; }
.profile-edit-form { margin-top: 16px; }
.profile-edit-form input, .profile-edit-form button { margin-right: 8px; margin-bottom: 8px; padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; }
.profile-edit-form button { background: #8b6fa8; color: white; border: none; cursor: pointer; }
.profile-edit-form button:hover { background: #7a5f97; }
.stats-row { display: flex; gap: 24px; flex-wrap: wrap; }
.stat-item { background: #e8e0f0; padding: 12px 20px; border-radius: 10px; }
.stat-item strong { display: block; color: #6b5b7a; font-size: 0.9rem; }
.stat-item span { font-size: 1.5rem; font-weight: bold; color: #4a3d5a; }
.level-block { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0d8e8; }
.level-block p { margin: 6px 0; }
.level-progress-wrap { background: #e0d8e8; border-radius: 8px; height: 20px; overflow: hidden; margin: 8px 0; }
.level-progress-fill { height: 100%; background: linear-gradient(90deg, #8b6fa8, #a88bc4); border-radius: 8px; transition: width 0.3s; }
.clan-info { margin-bottom: 12px; }
.clan-name { font-weight: bold; color: #6b5b7a; font-size: 1.1rem; }
.clan-block { padding: 16px; margin-bottom: 16px; background: #fcfaf8; border-radius: 12px; border: 1px solid #e8e0f0; }
.clan-block:last-child { margin-bottom: 0; }
.clan-block h3 { margin: 0 0 12px; font-size: 1rem; color: #6b5b7a; }
.clan-view { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.clan-view-emblem { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #d4c5b0; flex-shrink: 0; }
.clan-view-emblem-placeholder { width: 56px; height: 56px; border-radius: 50%; background: #e0d8e8; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; flex-shrink: 0; }
.clan-edit-form .form-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start; margin-bottom: 12px; }
.clan-edit-form label { display: block; margin-bottom: 4px; font-size: 0.9rem; color: #555; }
.clan-edit-form input[type="text"] { width: 100%; max-width: 240px; padding: 8px 12px; border: 2px solid #d4c5b0; border-radius: 8px; }
.clan-edit-form input[type="file"] { font-size: 0.9rem; }
.clan-members-toggle, .clan-btn { padding: 10px 18px; margin: 4px 8px 4px 0; border-radius: 10px; border: 2px solid #8b6fa8; background: #f5f0fa; color: #6b5b7a; cursor: pointer; font-weight: bold; }
.clan-btn:hover, .clan-members-toggle:hover { background: #e8e0f0; }
.clan-btn.danger { border-color: #c55; background: #fef0f0; color: #a33; }
.clan-btn.danger:hover { background: #fee; }
.members-list, .territories-list, .pending-list { margin-top: 12px; display: none; }
.members-list.open, .territories-list.open, .pending-list.open { display: block; }
.member-item, .territory-item, .pending-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 12px; margin: 6px 0; background: #f8f5fc; border-radius: 8px;
}
.member-item { gap: 12px; }
.member-item .member-avatar {
    width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e0d8e8; flex-shrink: 0;
}
.member-item .member-avatar-placeholder {
    width: 40px; height: 40px; border-radius: 50%; background: #e0d8e8;
    display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0;
}
.member-item .member-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
.member-item .member-level { font-size: 0.8rem; color: #8b6fa8; font-weight: bold; }
.member-item .kick-btn, .pending-item .accept-btn, .pending-item .reject-btn {
    padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem;
}
.member-item .kick-btn { background: #fcc; color: #a33; }
.pending-item .accept-btn { background: #cfc; color: #363; margin-right: 6px; }
.pending-item .reject-btn { background: #fcc; color: #a33; }
.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    opacity: 1;
    visibility: visible;
}
.modal-overlay.open {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}
.modal-box { background: white; padding: 28px; border-radius: 16px; max-width: 420px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
.modal-box h3 { margin: 0 0 16px; color: #4a3d5a; }
.modal-box .modal-buttons { margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end; }
.modal-box button { padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
.modal-box .btn-cancel { background: #ddd; border: 1px solid #ccc; }
.modal-box .btn-confirm { background: #8b6fa8; color: white; border: none; }
.modal-box .btn-confirm.danger { background: #c55; }
.modal-box select { width: 100%; padding: 12px; margin: 12px 0; border-radius: 8px; border: 2px solid #ccc; }
.create-clan-form input, .create-clan-form label { display: block; margin: 8px 0; width: 100%; }
.create-clan-form input[type="color"] { height: 40px; padding: 4px; cursor: pointer; }
.create-clan-form input[type="file"] { padding: 8px; }
.no-clan-msg { color: #666; margin-bottom: 12px; }
.nav-links { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; }
.back-link { display: inline-block; margin-top: 0; color: #8b6fa8; text-decoration: none; padding: 12px 20px; background: #f5f0fa; border-radius: 10px; font-weight: bold; border: 2px solid #d4c5b0; transition: all 0.2s; }
.back-link:hover { text-decoration: none; background: #e8e0f0; }
@media (max-width: 600px) {
    .cabinet-page { padding: 12px; }
    .cabinet-section { padding: 16px; margin-bottom: 16px; }
    .cabinet-section h2 { font-size: 1.1rem; }
    .profile-row { flex-direction: column; align-items: flex-start; }
    .profile-edit-form { display: flex; flex-direction: column; gap: 8px; }
    .profile-edit-form input, .profile-edit-form button { margin: 0; width: 100%; max-width: 100%; }
    .stats-row { flex-direction: column; gap: 12px; }
    .stat-item { width: 100%; }
    .level-block { margin-top: 8px; padding-top: 8px; }
    .nav-links { flex-direction: column; gap: 10px; margin-top: 16px; }
    .back-link { width: 100%; text-align: center; min-height: 44px; display: flex; align-items: center; justify-content: center; }
    .clan-block { padding: 12px; margin-bottom: 12px; }
    .clan-view { flex-direction: column; align-items: flex-start; }
    .clan-edit-form .form-row { flex-direction: column; }
    .clan-edit-form input[type="text"] { max-width: 100%; }
    .clan-members-toggle, .clan-btn { width: 100%; text-align: center; margin: 4px 0; min-height: 44px; display: flex; align-items: center; justify-content: center; }
    .member-item { flex-wrap: wrap; gap: 8px; }
    .member-item .kick-btn { width: 100%; }
    .pending-item { flex-wrap: wrap; }
    .pending-item .accept-btn, .pending-item .reject-btn { min-height: 40px; }
    .modal-box { margin: 16px; max-height: calc(100vh - 32px); overflow-y: auto; padding: 20px; }
}
</style>
{% endblock %}

{% block content %}
<div class="cabinet-page">
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

    <div class="cabinet-section">
        <h2>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <div class="profile-row">
            <div class="avatar-wrap">
                {% if avatar_url %}
                <img src="{{ avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" id="avatarImg">
                {% else %}
                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;">üë§</div>
                {% endif %}
            </div>
            <div class="profile-info">
                <p><strong>–õ–æ–≥–∏–Ω:</strong> {{ user.username }}</p>
                <p><strong>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</strong> {{ user.character_name or user.username }}</p>
                <div class="level-block">
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> {{ user.level }}</p>
                    <p><strong>–£—Ä–æ–Ω:</strong> {{ user.damage }}</p>
                    <p class="level-xp-text">–û–ø—ã—Ç –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: {{ user.xp_in_current_level }} / {{ user.xp_needed_for_next_level }}</p>
                    <div class="level-progress-wrap">
                        <div class="level-progress-fill" style="width: {{ (user.xp_in_current_level / user.xp_needed_for_next_level * 100) if user.xp_needed_for_next_level else 100 }}%;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="profile-edit-form">
            <form id="profileForm" enctype="multipart/form-data">
                <input type="text" name="character_name" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" value="{{ user.character_name or '' }}">
                <input type="file" name="avatar" accept="image/*">
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div class="cabinet-section">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏—Ç–≤—ã –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</h2>
        <div class="stats-row">
            <div class="stat-item">
                <strong>–£—Ä–æ–Ω –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π –¥—Ä—É–≥–∏–º –∫–ª–∞–Ω–∞–º</strong>
                <span id="statDamage">{{ user.total_damage_dealt }}</span>
            </div>
            <div class="stat-item">
                <strong>–û—á–∫–∏ –≤–ª–∏—è–Ω–∏—è –∫–ª–∞–Ω—É (–∑–∞—â–∏—Ç–∞)</strong>
                <span id="statInfluence">{{ user.total_influence_points }}</span>
            </div>
        </div>
    </div>

    <div class="cabinet-section">
        <h2>–ö–ª–∞–Ω</h2>
        {% if clan_data %}
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ -->
        <div class="clan-block">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ</h3>
            <div class="clan-view">
                {% if clan_data.clan.flag_url %}
                <img id="clanFlagDisplay" src="{{ clan_data.clan.flag_url }}" alt="–≠–º–±–ª–µ–º–∞" class="clan-view-emblem">
                {% else %}
                <div class="clan-view-emblem-placeholder">üè¥</div>
                {% endif %}
                <div>
                    <span class="clan-name" id="clanNameDisplay">{{ clan_data.clan.name }}</span>
                    {% if user.id == clan_data.clan.owner_id %}
                    <span style="font-size:0.85rem;color:#888;"> (–≤–ª–∞–¥–µ–ª–µ—Ü)</span>
                    {% endif %}
                    <p style="margin:4px 0 0; font-size:0.9rem; color:#666;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ clan_data.members|length }}</p>
                </div>
            </div>
        </div>

        {% if user.id == clan_data.clan.owner_id %}
        <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∫–ª–∞–Ω–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) -->
        <div class="clan-block">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞</h3>
            <form id="clanEditForm" class="clan-edit-form" enctype="multipart/form-data">
                <div class="form-row">
                    <div>
                        <label>–≠–º–±–ª–µ–º–∞</label>
                        {% if clan_data.clan.flag_url %}
                        <img id="clanFlagPreview" src="{{ clan_data.clan.flag_url }}" alt="–≠–º–±–ª–µ–º–∞" class="clan-view-emblem" style="display:block;margin-bottom:6px;">
                        {% else %}
                        <div id="clanFlagPreview" class="clan-view-emblem-placeholder" style="margin-bottom:6px;">üè¥</div>
                        {% endif %}
                        <input type="file" name="flag" accept="image/*" id="clanFlagInput">
                    </div>
                    <div style="flex:1; min-width:180px;">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞</label>
                        <input type="text" name="name" value="{{ clan_data.clan.name }}" minlength="2" required>
                    </div>
                </div>
                <button type="submit" class="clan-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
        {% endif %}

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="clan-block">
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–ª–∞–Ω–∞</h3>
            <button type="button" class="clan-members-toggle" onclick="document.getElementById('membersList').classList.toggle('open')">
                –ü–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ({{ clan_data.members|length }})
            </button>
            <div id="membersList" class="members-list">
                {% for m in clan_data.members %}
                <div class="member-item">
                    {% if m.avatar_url %}
                    <img src="{{ m.avatar_url }}" alt="" class="member-avatar">
                    {% else %}
                    <div class="member-avatar-placeholder">üë§</div>
                    {% endif %}
                    <div class="member-info">
                        <span>{{ m.character_name }} ({{ m.username }}){% if m.is_owner %} ‚òÖ{% endif %}</span>
                        <span class="member-level">–£—Ä. {{ m.level }}</span>
                    </div>
                    {% if user.id == clan_data.clan.owner_id and not m.is_owner %}
                    <button class="kick-btn" data-user-id="{{ m.id }}">–ò—Å–∫–ª—é—á–∏—Ç—å</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –æ–±–ª–∞—Å—Ç–∏ -->
        <div class="clan-block">
            <h3>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –æ–±–ª–∞—Å—Ç–∏</h3>
            <button type="button" class="clan-members-toggle" onclick="document.getElementById('territoriesList').classList.toggle('open')">
                –ü–æ–∫–∞–∑–∞—Ç—å –æ–±–ª–∞—Å—Ç–∏
            </button>
            <div id="territoriesList" class="territories-list">
                {% for t in clan_data.territories %}
                <div class="territory-item">{{ t.display_name }} ‚Äî —Å–∏–ª–∞ {{ t.strength }}</div>
                {% endfor %}
                {% if not clan_data.territories %}
                <p style="color:#888; margin:8px 0 0;">–ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π</p>
                {% endif %}
            </div>
        </div>

        {% if user.id == clan_data.clan.owner_id and clan_data.pending_requests %}
        <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
        <div class="clan-block">
            <h3>–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>
            <div id="pendingList" class="pending-list open">
                {% for r in clan_data.pending_requests %}
                <div class="pending-item" data-request-id="{{ r.id }}">
                    <span>{{ r.character_name }} ({{ r.username }})</span>
                    <span>
                        <button class="accept-btn" onclick="handleAccept({{ r.id }})">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="reject-btn" onclick="handleReject({{ r.id }})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –í—ã—Ö–æ–¥ –∏–∑ –∫–ª–∞–Ω–∞ -->
        <div class="clan-block">
            <button type="button" class="clan-btn danger" onclick="openLeaveModal()">–í—ã–π—Ç–∏ –∏–∑ –∫–ª–∞–Ω–∞</button>
        </div>
        {% elif pending_request %}
        <div class="clan-block">
            <p class="no-clan-msg">–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –∫–ª–∞–Ω –ø–æ–¥–∞–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è.</p>
            <button type="button" class="clan-btn" onclick="cancelRequest()">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
        {% else %}
        <div class="clan-block">
            <p class="no-clan-msg">–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.</p>
            <button type="button" class="clan-btn" onclick="openJoinModal()">–í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω</button>
            <button type="button" class="clan-btn" onclick="openCreateModal()">–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω</button>
        </div>
        {% endif %}
    </div>

    <div class="nav-links">
        <a href="{{ url_for('index') }}" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('territory_battle_page') }}" class="back-link">–ë–∏—Ç–≤–∞ –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</a>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–ª–∞–Ω–∞ -->
<div class="modal-overlay" id="leaveModal">
    <div class="modal-box">
        <h3>–í—ã–π—Ç–∏ –∏–∑ –∫–ª–∞–Ω–∞?</h3>
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω?</p>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeLeaveModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-confirm danger" onclick="confirmLeave()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –∫–ª–∞–Ω -->
<div class="modal-overlay" id="joinModal">
    <div class="modal-box">
        <h3>–í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω</h3>
        <select id="joinClanSelect"></select>
        <div class="modal-buttons">
            <button type="button" class="btn-cancel" onclick="closeJoinModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn-confirm" onclick="confirmJoin()">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–Ω–∞ -->
<div class="modal-overlay" id="createModal">
    <div class="modal-box">
        <h3>–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω</h3>
        <form id="createClanForm" class="create-clan-form">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞</label>
            <input type="text" name="name" required minlength="2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <label>–¶–≤–µ—Ç</label>
            <input type="color" name="color" value="#6b7280">
            <label>–§–ª–∞–≥ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)</label>
            <input type="file" name="flag" accept="image/*">
        </form>
        <div class="modal-buttons">
            <button type="button" class="btn-cancel" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn-confirm" onclick="confirmCreate()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('profileForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const fd = new FormData(this);
    fd.append('character_name', this.querySelector('[name=character_name]').value);
    fetch('{{ url_for("api_cabinet_profile") }}', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
                if (data.avatar_url) {
                    const img = document.getElementById('avatarImg');
                    if (img) img.src = data.avatar_url;
                    else location.reload();
                }
            } else alert(data.error || '–û—à–∏–±–∫–∞');
        });
});

document.getElementById('clanEditForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    var form = this;
    var clanId = {{ clan_data.clan.id if clan_data and clan_data.clan else 'null' }};
    if (!clanId) return;
    var fd = new FormData();
    fd.append('name', form.querySelector('[name=name]').value);
    var flagInput = form.querySelector('[name=flag]');
    if (flagInput && flagInput.files[0]) fd.append('flag', flagInput.files[0]);
    fetch('/api/clan/' + clanId + '/update', { method: 'POST', body: fd })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('–ö–ª–∞–Ω –æ–±–Ω–æ–≤–ª—ë–Ω');
                document.getElementById('clanNameDisplay').textContent = data.clan.name;
                var flagUrl = data.clan.flag_url;
                if (flagUrl) {
                    var preview = document.getElementById('clanFlagPreview');
                    if (preview && preview.tagName === 'IMG') preview.src = flagUrl;
                    else if (preview) { var img = document.createElement('img'); img.id = 'clanFlagPreview'; img.src = flagUrl; img.className = 'clan-view-emblem'; img.style.cssText = 'display:block;margin-bottom:6px;'; preview.parentNode.replaceChild(img, preview); }
                    var infoEmblem = document.querySelector('.clan-block .clan-view .clan-view-emblem, .clan-block .clan-view .clan-view-emblem-placeholder');
                    if (infoEmblem) { var disp = document.createElement('img'); disp.className = 'clan-view-emblem'; disp.src = flagUrl; disp.alt = '–≠–º–±–ª–µ–º–∞'; infoEmblem.parentNode.replaceChild(disp, infoEmblem); }
                }
                if (flagInput) flagInput.value = '';
            } else { alert(data.error || '–û—à–∏–±–∫–∞'); }
        })
        .catch(function() { alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); });
});

{% if clan_data %}
document.querySelectorAll('.kick-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('–ò—Å–∫–ª—é—á–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
        const uid = this.dataset.userId;
        fetch(`/api/clan/{{ clan_data.clan.id }}/kick/${uid}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert(data.error || '–û—à–∏–±–∫–∞');
            });
    });
});
{% endif %}

function openLeaveModal() {
    var m = document.getElementById('leaveModal');
    if (m) { m.style.display = 'flex'; m.style.visibility = 'visible'; m.classList.add('open'); document.body.appendChild(m); }
}
function closeLeaveModal() {
    var m = document.getElementById('leaveModal');
    if (m) { m.classList.remove('open'); m.style.display = ''; m.style.visibility = ''; }
}
function confirmLeave() {
    fetch('{{ url_for("api_clan_leave") }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else { alert(data.error || '–û—à–∏–±–∫–∞'); closeLeaveModal(); }
        });
}

function openJoinModal() {
    var modal = document.getElementById('joinModal');
    var sel = document.getElementById('joinClanSelect');
    if (!modal) modal = document.querySelector('.modal-overlay#joinModal');
    if (!modal) return;
    sel = modal.querySelector('select') || document.getElementById('joinClanSelect');
    if (sel) sel.innerHTML = '<option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞... ‚Äî</option>';
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.classList.add('open');
    document.body.appendChild(modal);
    fetch('{{ url_for("api_clans_list") }}')
        .then(function(r) {
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–ª–∞–Ω–æ–≤');
            return r.json();
        })
        .then(function(clans) {
            var s = document.getElementById('joinClanSelect');
            if (!s) return;
            var list = Array.isArray(clans) ? clans : [];
            s.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞–Ω ‚Äî</option>' +
                list.map(function(c) { return '<option value="' + c.id + '">' + (c.name || '') + '</option>'; }).join('');
        })
        .catch(function(err) {
            var s = document.getElementById('joinClanSelect');
            if (s) s.innerHTML = '<option value="">‚Äî –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî</option>';
            alert(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–æ–≤');
        });
}
function closeJoinModal() {
    var m = document.getElementById('joinModal');
    if (m) { m.classList.remove('open'); m.style.display = ''; m.style.visibility = ''; }
}
function confirmJoin() {
    const cid = document.getElementById('joinClanSelect').value;
    if (!cid) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞–Ω'); return; }
    fetch('{{ url_for("api_clan_join_request") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clan_id: parseInt(cid) })
    }).then(r => r.json())
      .then(data => {
          if (data.success) location.reload();
          else alert(data.error || '–û—à–∏–±–∫–∞');
      });
}

function cancelRequest() {
    fetch('{{ url_for("api_clan_cancel_request") }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert(data.error || '–û—à–∏–±–∫–∞');
        });
}

{% if clan_data %}
function handleAccept(rid) {
    fetch(`/api/clan/{{ clan_data.clan.id }}/accept/${rid}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); else alert(data.error); });
}
function handleReject(rid) {
    fetch(`/api/clan/{{ clan_data.clan.id }}/reject/${rid}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); else alert(data.error); });
}
{% endif %}

function openCreateModal() {
    var m = document.getElementById('createModal');
    if (m) { m.style.display = 'flex'; m.style.visibility = 'visible'; m.classList.add('open'); document.body.appendChild(m); }
}
function closeCreateModal() {
    var m = document.getElementById('createModal');
    if (m) { m.classList.remove('open'); m.style.display = ''; m.style.visibility = ''; }
}
function confirmCreate() {
    const form = document.getElementById('createClanForm');
    if (!form) return;
    const fd = new FormData();
    fd.append('name', form.querySelector('[name=name]').value || '');
    fd.append('color', form.querySelector('[name=color]').value || '#6b7280');
    const file = form.querySelector('[name=flag]');
    if (file && file.files[0]) fd.append('flag', file.files[0]);
    fetch('{{ url_for("api_clan_create") }}', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert(data.error || '–û—à–∏–±–∫–∞');
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'));
}

</script>
{% endblock %}
