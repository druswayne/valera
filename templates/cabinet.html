{% extends "base.html" %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –í–∞–ª–µ—Ä–∞ –≤ –ø–µ—â–µ—Ä–µ{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body { font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, 'Times New Roman', serif; }

.cabinet-page {
    min-height: 100vh;
    width: 100%;
    padding: 20px;
    color: #e8dcc4;
    background: #3d2914 linear-gradient(180deg, rgba(61,41,20,0.97) 0%, #2c1810 50%, #1a0f08 100%);
    position: relative;
}
.cabinet-page .cabinet-inner { max-width: 800px; margin: 0 auto; }
.cabinet-page::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
}
.cabinet-page > * { position: relative; z-index: 1; }

.cabinet-page h1 {
    font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
    text-align: center;
    margin: 0 0 24px;
    font-size: 2rem;
    font-weight: 700;
    color: #d4a84b;
    text-shadow: 0 0 20px rgba(212,168,75,0.3), 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 0.08em;
}

.cabinet-top-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
}
.cabinet-top-nav .back-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #d4a84b;
    text-decoration: none;
    padding: 10px 18px;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    border: 2px solid #5c4033;
    border-radius: 4px;
    font-family: 'Cinzel', Georgia, serif;
    font-size: 0.9rem;
    font-weight: bold;
    letter-spacing: 0.04em;
    transition: color 0.2s, border-color 0.2s, box-shadow 0.2s;
    min-height: 44px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.cabinet-top-nav .back-link:hover {
    color: #e8c86a;
    border-color: #8b6914;
    box-shadow: 0 0 12px rgba(212,168,75,0.25);
}
.cabinet-top-nav .logout-link {
    margin-left: auto;
    color: #c4a574;
    border-color: #6b5344;
}
.cabinet-top-nav .logout-link:hover {
    color: #e8a050;
    border-color: #8b5a3c;
}

.cabinet-section {
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    border: 2px solid #5c4033;
    box-shadow: inset 0 1px 0 rgba(212,168,75,0.12), 0 4px 12px rgba(0,0,0,0.35);
}
.cabinet-section h2 {
    font-family: 'Cinzel', Georgia, serif;
    color: #d4a84b;
    margin: 0 0 16px;
    font-size: 1.25rem;
    letter-spacing: 0.04em;
}
.section-title-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 4px;
}
.section-title-row h2 { margin: 0; }

.profile-row { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
.avatar-wrap {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    background: #2c1810;
    border: 2px solid #5c4033;
    flex-shrink: 0;
    cursor: pointer;
    position: relative;
    box-shadow: 0 0 0 1px rgba(212,168,75,0.25);
}
.avatar-wrap:hover { opacity: 0.9; filter: brightness(1.1); }
.avatar-wrap img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
.avatar-wrap .avatar-placeholder-inner {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; pointer-events: none; color: #c4b098;
}

.name-edit-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 2px 6px;
    margin-left: 4px;
    font-size: 1rem;
    opacity: 0.7;
    vertical-align: middle;
    color: #d4a84b;
}
.name-edit-btn:hover { opacity: 1; color: #e8c86a; }
.name-edit-inline { display: none; align-items: center; gap: 8px; margin: 8px 0 0; flex-wrap: wrap; }
.name-edit-inline.open { display: flex; }
.name-edit-inline input {
    padding: 8px 12px;
    border: 2px solid #5c4033;
    border-radius: 4px;
    min-width: 160px;
    background: #2c1810;
    color: #e8dcc4;
    font-family: inherit;
}
.name-edit-inline input:focus { outline: none; border-color: #8b6914; }
.name-edit-inline button {
    padding: 8px 16px;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
}
.name-edit-inline button:hover { color: #e8c86a; border-color: #8b6914; }
.name-edit-inline .name-edit-cancel {
    background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%);
    color: #b8a088;
}
.name-edit-inline .name-edit-cancel:hover { color: #e8dcc4; }

.profile-info { flex: 1; min-width: 200px; color: #e8dcc4; }
.profile-info p { margin: 6px 0; }
.profile-info strong { color: #d4a84b; }

.stats-row { display: flex; gap: 20px; flex-wrap: wrap; }
.stat-item {
    background: linear-gradient(145deg, #3d2914 0%, #2c1810 100%);
    padding: 14px 20px;
    border-radius: 6px;
    border: 2px solid #5c4033;
    flex: 1;
    min-width: 140px;
}
.stat-item strong { display: block; color: #d4a84b; font-size: 0.9rem; margin-bottom: 4px; font-family: 'Cinzel', Georgia, serif; }
.stat-item span { font-size: 1.5rem; font-weight: bold; color: #e8dcc4; }

.skills-block { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(92,64,51,0.6); }
.skills-block h4 { margin: 0 0 12px; font-size: 1rem; color: #d4a84b; font-family: 'Cinzel', Georgia, serif; }
.skill-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; position: relative; }
.skill-row label { min-width: 100px; font-weight: bold; color: #c4b098; }
.skill-row .val { min-width: 2.5em; text-align: center; font-weight: bold; color: #d4a84b; }
.skill-btn {
    width: 36px;
    height: 36px;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: linear-gradient(145deg, #3d2914 0%, #2c1810 100%);
    color: #d4a84b;
    font-size: 1.1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s, border-color 0.2s;
}
.skill-btn:hover:not(:disabled) { color: #e8c86a; border-color: #8b6914; }
.skill-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.skill-save-btn {
    padding: 10px 20px;
    margin-top: 12px;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%);
    color: #d4a84b;
    font-weight: bold;
    cursor: pointer;
    font-family: 'Cinzel', Georgia, serif;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.skill-save-btn:hover:not(:disabled) { color: #e8c86a; border-color: #8b6914; }
.skill-save-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.skill-points-block { margin-top: 8px; }
.skill-points-hint { font-size: 0.9rem; color: #b8a088; margin-top: 6px; }
.skill-row .stat-help {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 1px solid #5c4033;
    background: #3d2914;
    color: #d4a84b;
    font-size: 0.85rem;
    font-weight: bold;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-left: 2px;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
}
.skill-row .stat-help:hover { color: #e8c86a; border-color: #8b6914; background: #4a3520; }
.skill-row .stat-help.active { border-color: #d4a84b; background: #4a3520; color: #e8c86a; }
.stat-tooltip {
    display: none;
    position: absolute;
    left: 0;
    top: 100%;
    margin-top: 4px;
    white-space: normal;
    padding: 10px 14px;
    max-width: 336px;
    background: linear-gradient(145deg, #2c1810 0%, #1a0f08 100%);
    border: 2px solid #5c4033;
    border-radius: 6px;
    color: #e8dcc4;
    font-size: 0.9rem;
    line-height: 1.4;
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
    z-index: 100;
}
.stat-tooltip.show { display: block; }
.skill-row .stat-label-wrap { display: inline-flex; align-items: center; gap: 0; position: relative; }
.level-block { margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(92,64,51,0.6); }
.level-block p { margin: 6px 0; }
.level-progress-wrap {
    background: #2c1810;
    border-radius: 4px;
    height: 12px;
    overflow: hidden;
    margin: 8px 0;
    border: 1px solid #5c4033;
}
.level-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #8b6914, #d4a84b);
    border-radius: 3px;
    transition: width 0.3s;
}
.energy-display { margin: 10px 0 0; }
.energy-hint { font-size: 0.85rem; color: #b8a088; }

/* –ë–ª–æ–∫ –±–∞–ª–∞–Ω—Å–∞ –ù—É–º–æ–≤ ‚Äî –≤ –≤–µ—Ä—Ö–Ω–µ–º –ø—Ä–∞–≤–æ–º —É–≥–ª—É –±–ª–æ–∫–∞ ¬´–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è¬ª */
.nums-balance-block {
    margin-left: auto;
    background: linear-gradient(145deg, #5c4020 0%, #4a3018 50%, #3d2814 100%);
    border: 2px solid #d4a84b;
    border-radius: 10px;
    padding: 14px 20px;
    box-shadow: 0 0 20px rgba(212, 168, 75, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 4px 12px rgba(0, 0, 0, 0.35);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    min-width: 140px;
}
.nums-balance-block .nums-balance-main {
    display: flex;
    align-items: baseline;
    gap: 4px;
}
.nums-balance-block .nums-value {
    font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: #e8c86a;
    text-shadow: 0 0 12px rgba(232, 200, 106, 0.45), 0 2px 4px rgba(0, 0, 0, 0.3);
}
.nums-balance-block .nums-suffix {
    color: #d4a84b;
    font-size: 1.1rem;
    font-weight: 600;
}
.nums-balance-block .nums-tooltip-wrap {
    position: relative;
    flex-shrink: 0;
}
.nums-balance-block .stat-help {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 1px solid #5c4033;
    background: #3d2914;
    color: #d4a84b;
    font-size: 0.85rem;
    font-weight: bold;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
}
.nums-balance-block .stat-help:hover { color: #e8c86a; border-color: #8b6914; background: #4a3520; }
.nums-balance-block .stat-help.active { border-color: #d4a84b; background: #4a3520; color: #e8c86a; }
.nums-balance-block .stat-tooltip {
    left: auto;
    right: 0;
    min-width: 260px;
    max-width: 320px;
}

/* –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–µ –±–ª–æ–∫–∏ */
.cabinet-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    cursor: pointer;
    user-select: none;
    margin-bottom: 0;
}
.cabinet-section-header h2 { margin: 0; }
.cabinet-section-body { margin-top: 16px; }
.cabinet-section.collapsed .cabinet-section-body { display: none; }
.cabinet-section.collapsed .section-toggle { transform: rotate(-90deg); }
.section-toggle {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    color: #d4a84b;
    font-size: 1.2rem;
    cursor: pointer;
    transition: transform 0.2s;
    padding: 0;
    line-height: 1;
}
.section-toggle:hover { color: #e8c86a; }

/* –ë–ª–æ–∫ ¬´–ë–∞–ª–∞–Ω—Å –∏ –õ–∞–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤¬ª */
.balance-shop-section .balance-display-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 16px;
}
.balance-shop-section .balance-display-row .nums-balance-block {
    margin-left: 0;
    width: 100%;
    box-sizing: border-box;
    justify-content: flex-start;
}
.balance-shop-section .shop-toggle-btn {
    padding: 10px 20px;
    border-radius: 6px;
    border: 2px solid #5c4033;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
}
.balance-shop-section .shop-toggle-btn:hover { color: #e8c86a; border-color: #8b6914; }
.shop-grid-wrap { display: none; margin-top: 16px; }
.shop-grid-wrap.open { display: block; }
.shop-category-block { margin-bottom: 24px; }
.shop-category-block h4 { color: #c4a574; font-size: 1rem; margin: 0 0 12px; font-family: 'Cinzel', Georgia, serif; }
.shop-tiles {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 16px;
}
.shop-item-tile {
    background: linear-gradient(145deg, #3d2914 0%, #2c1810 100%);
    border: 2px solid #5c4033;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.shop-item-tile:hover { border-color: #d4a84b; box-shadow: 0 0 12px rgba(212,168,75,0.2); }
.shop-item-tile img { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
.shop-item-tile .tile-placeholder { width: 64px; height: 64px; margin: 0 auto 8px; background: #2c1810; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #5c4033; }
.shop-item-tile .tile-name { font-weight: bold; color: #e8dcc4; font-size: 0.9rem; margin-bottom: 4px; }
.shop-item-tile .tile-price { color: #d4a84b; font-size: 0.9rem; }

.inventory-tiles {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 12px;
}
.inventory-tile {
    background: linear-gradient(145deg, #3d2914 0%, #2c1810 100%);
    border: 2px solid #5c4033;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    opacity: 0.85;
}
.inventory-tile img { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; margin-bottom: 6px; }
.inventory-tile .tile-placeholder { width: 48px; height: 48px; margin: 0 auto 6px; background: #2c1810; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #5c4033; }
.inventory-tile .tile-name { font-size: 0.8rem; color: #b8a088; }
.inventory-empty { color: #b8a088; padding: 16px; text-align: center; }

/* –ú–æ–¥–∞–ª–∫–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –ª–∞–≤–∫–µ */
.shop-item-modal .modal-box { max-width: 420px; }
.shop-item-modal .item-image { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; margin: 0 auto 12px; display: block; }
.shop-item-modal .item-image-placeholder { width: 120px; height: 120px; margin: 0 auto 12px; background: #2c1810; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #5c4033; }
.shop-item-modal .item-price { font-size: 1.25rem; color: #8b6914; font-weight: bold; margin: 12px 0; }
.shop-item-modal .btn-buy { padding: 12px 24px; border-radius: 6px; border: 2px solid #5c4033; background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%); color: #d4a84b; font-weight: bold; cursor: pointer; font-family: 'Cinzel', Georgia, serif; }
.shop-item-modal .btn-buy:hover:not(:disabled) { color: #e8c86a; border-color: #8b6914; }
.shop-item-modal .btn-buy:disabled { opacity: 0.5; cursor: not-allowed; }

.clan-info { margin-bottom: 12px; }
.clan-name { font-weight: bold; color: #d4a84b; font-size: 1.1rem; font-family: 'Cinzel', Georgia, serif; }
.clan-block {
    padding: 18px;
    margin-bottom: 16px;
    background: linear-gradient(145deg, #3d2914 0%, #2c1810 100%);
    border-radius: 6px;
    border: 2px solid #5c4033;
}
.clan-block:last-child { margin-bottom: 0; }
.clan-block h3 { margin: 0 0 12px; font-size: 1rem; color: #d4a84b; font-family: 'Cinzel', Georgia, serif; }
.clan-view { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.clan-view-emblem {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #5c4033;
    flex-shrink: 0;
    background: #2c1810;
}
.clan-view-emblem-placeholder {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #2c1810;
    border: 2px solid #5c4033;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    flex-shrink: 0;
}
.clan-edit-form .form-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start; margin-bottom: 14px; }
.clan-edit-form label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: #c4b098; }
.clan-edit-form input[type="text"] {
    width: 100%;
    max-width: 240px;
    padding: 10px 14px;
    border: 2px solid #5c4033;
    border-radius: 4px;
    background: #2c1810;
    color: #e8dcc4;
    font-family: inherit;
}
.clan-edit-form input[type="text"]:focus { outline: none; border-color: #8b6914; }
.clan-edit-form input[type="file"] { font-size: 0.9rem; color: #c4b098; }

.clan-members-toggle, .clan-btn {
    padding: 10px 18px;
    margin: 4px 8px 4px 0;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
    transition: color 0.2s, border-color 0.2s;
}
.clan-btn:hover, .clan-members-toggle:hover { color: #e8c86a; border-color: #8b6914; }
.clan-btn.danger {
    border-color: #8b4545;
    background: linear-gradient(145deg, #5c3434 0%, #4a2828 100%);
    color: #e8c0c0;
}
.clan-btn.danger:hover { color: #ffe0e0; border-color: #a05555; }

.members-list, .territories-list, .pending-list, .clan-chat-content { margin-top: 12px; display: none; }
.members-list.open, .territories-list.open, .pending-list.open, .clan-chat-content.open { display: block; }
.member-item, .territory-item, .pending-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    margin: 8px 0;
    background: rgba(44,24,16,0.6);
    border-radius: 6px;
    border: 1px solid #5c4033;
    color: #e8dcc4;
}
.member-item { gap: 12px; }
.member-item .member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    background: #2c1810;
    border: 2px solid #5c4033;
    flex-shrink: 0;
}
.member-item .member-avatar-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2c1810;
    border: 2px solid #5c4033;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}
.member-item .member-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 2px; }
.member-item .member-level { font-size: 0.8rem; color: #d4a84b; font-weight: bold; }
.member-item .kick-btn, .pending-item .accept-btn, .pending-item .reject-btn {
    padding: 8px 14px;
    border-radius: 4px;
    border: 2px solid;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
}
.member-item .kick-btn {
    background: linear-gradient(145deg, #5c3434 0%, #4a2828 100%);
    border-color: #8b4545;
    color: #e8c0c0;
}
.pending-item .accept-btn {
    background: linear-gradient(145deg, #3d5c34 0%, #2d4a24 100%);
    border-color: #5c8b45;
    color: #c8e0b8;
    margin-right: 8px;
}
.pending-item .reject-btn {
    background: linear-gradient(145deg, #5c3434 0%, #4a2828 100%);
    border-color: #8b4545;
    color: #e8c0c0;
}

/* –ß–∞—Ç —Å –∫–ª–∞–Ω–æ–º */
.clan-chat-block { margin-top: 0; }
.clan-chat-messages {
    max-height: 280px;
    overflow-y: auto;
    margin: 12px 0;
    padding: 10px;
    background: rgba(44,24,16,0.6);
    border-radius: 6px;
    border: 1px solid #5c4033;
    display: flex;
    flex-direction: column;
}
.clan-chat-msg {
    padding: 8px 10px;
    margin-bottom: 8px;
    background: rgba(61,41,20,0.5);
    border-radius: 4px;
    border-left: 3px solid #8b6914;
    font-size: 0.95rem;
    max-width: 80%;
}
.clan-chat-msg-own {
    align-self: flex-end;
    background: rgba(90,60,30,0.7);
    border-left: none;
    border-right: 3px solid #d4a84b;
    text-align: right;
}
.clan-chat-msg:last-child { margin-bottom: 0; }
.clan-chat-msg .chat-author { font-weight: bold; color: #d4a84b; margin-right: 8px; }
.clan-chat-msg .chat-time { font-size: 0.8rem; color: #b8a088; margin-left: 6px; }
.clan-chat-form {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}
.clan-chat-form input[type="text"] {
    flex: 1;
    min-width: 160px;
    padding: 10px 14px;
    border: 2px solid #5c4033;
    border-radius: 4px;
    background: #2c1810;
    color: #e8dcc4;
    font-family: inherit;
}
.clan-chat-form input[type="text"]:focus { outline: none; border-color: #8b6914; }
.clan-chat-form button {
    padding: 10px 20px;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: linear-gradient(145deg, #4a3520 0%, #3d2914 100%);
    color: #d4a84b;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
    cursor: pointer;
}
.clan-chat-form button:hover { color: #e8c86a; border-color: #8b6914; }
.clan-chat-form button:disabled { opacity: 0.6; cursor: not-allowed; }
.clan-chat-empty { color: #b8a088; padding: 12px; text-align: center; font-size: 0.95rem; }

.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    padding: 20px;
}
.modal-overlay.open {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}
.modal-box {
    background: linear-gradient(180deg, #f4e4bc 0%, #e8d5a3 50%, #dcc898 100%);
    padding: 28px;
    border-radius: 4px;
    max-width: 420px;
    width: 90%;
    box-shadow: 0 0 0 3px #5c4033, 0 12px 40px rgba(0,0,0,0.5);
    border: 2px solid #3d2914;
    color: #2c1810;
}
.modal-box h3 { margin: 0 0 16px; font-family: 'Cinzel Decorative', 'Cinzel', Georgia, serif; color: #3d2914; }
.modal-box p { color: #2c1810; }
.modal-box .modal-buttons { margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end; }
.modal-box button {
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Cinzel', Georgia, serif;
}
.modal-box .btn-cancel {
    background: linear-gradient(180deg, #c4b098 0%, #a89070 100%);
    border: 2px solid #5c4033;
    color: #2c1810;
}
.modal-box .btn-confirm {
    background: linear-gradient(145deg, #5c4033 0%, #4a3520 100%);
    border: 2px solid #3d2914;
    color: #d4a84b;
}
.modal-box .btn-confirm:hover { color: #e8c86a; }
.modal-box .btn-confirm.danger {
    background: linear-gradient(145deg, #5c3434 0%, #4a2828 100%);
    color: #e8c0c0;
}
.modal-box select {
    width: 100%;
    padding: 12px;
    margin: 12px 0;
    border-radius: 4px;
    border: 2px solid #5c4033;
    background: rgba(255,255,255,0.6);
    color: #2c1810;
    font-family: inherit;
}
.create-clan-form input, .create-clan-form label { display: block; margin: 8px 0; width: 100%; }
.create-clan-form input[type="text"] {
    padding: 10px 14px;
    border: 2px solid #5c4033;
    border-radius: 4px;
    background: rgba(255,255,255,0.6);
    color: #2c1810;
}
.create-clan-form input[type="color"] { height: 40px; padding: 4px; cursor: pointer; }
.create-clan-form input[type="file"] { padding: 8px; }
.no-clan-msg { color: #b8a088; margin-bottom: 12px; }

@media (max-width: 600px) {
    .cabinet-page { padding: 12px; }
    .cabinet-page h1 { font-size: 1.35rem; margin-bottom: 16px; }
    .section-title-row { flex-direction: column; align-items: stretch; gap: 8px; }
    .nums-balance-block { padding: 14px 16px; margin-left: 0; }
    .nums-balance-block .nums-value { font-size: 1.5rem; }
    .nums-balance-block .nums-suffix { font-size: 1.1rem; }
    .cabinet-top-nav { flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .cabinet-top-nav .back-link { width: 100%; }
    .cabinet-section { padding: 16px; margin-bottom: 16px; }
    .cabinet-section h2 { font-size: 1.1rem; }
    .profile-row { flex-direction: column; align-items: flex-start; gap: 16px; }
    .profile-info { min-width: 0; width: 100%; }
    .profile-info p { word-break: break-word; }
    .name-edit-inline { flex-direction: column; align-items: stretch; }
    .name-edit-inline input { min-width: 0; width: 100%; box-sizing: border-box; }
    .stats-row { flex-direction: column; gap: 12px; }
    .stat-item { width: 100%; }
    .level-block { margin-top: 8px; padding-top: 8px; }
    .level-xp-text { font-size: 0.9rem; }
    .skills-block { margin-top: 12px; padding-top: 12px; }
    .skill-row { gap: 6px; margin-bottom: 8px; }
    .skill-row label { min-width: 80px; font-size: 0.9rem; }
    .skill-save-btn { width: 100%; justify-content: center; min-height: 44px; }
    .energy-display { font-size: 0.9rem; }
    .clan-block { padding: 12px; margin-bottom: 12px; }
    .clan-view { flex-direction: column; align-items: flex-start; }
    .clan-edit-form .form-row { flex-direction: column; }
    .clan-edit-form input[type="text"] { max-width: 100%; }
    .clan-members-toggle, .clan-btn { width: 100%; text-align: center; margin: 4px 0; min-height: 44px; display: flex; align-items: center; justify-content: center; }
    .member-item { flex-wrap: wrap; gap: 8px; }
    .member-item .kick-btn { width: 100%; }
    .pending-item { flex-wrap: wrap; }
    .pending-item .accept-btn, .pending-item .reject-btn { min-height: 40px; }
    .clan-chat-form { flex-direction: column; }
    .clan-chat-form input[type="text"] { min-width: 0; width: 100%; }
    .clan-chat-form button { width: 100%; min-height: 44px; }
    .modal-box { margin: 16px; max-height: calc(100vh - 32px); overflow-y: auto; padding: 20px; }
}
</style>
{% endblock %}

{% block content %}
<div class="cabinet-page">
<div class="cabinet-inner">
    <nav class="cabinet-top-nav">
        <a href="{{ url_for('index') }}" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="{{ url_for('territory_battle_page') }}" class="back-link">–ë–∏—Ç–≤–∞ –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</a>
        <a href="{{ url_for('territory_clans_top') }}" class="back-link">–¢–æ–ø –∫–ª–∞–Ω–æ–≤</a>
        <a href="{{ url_for('logout') }}" class="back-link logout-link">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</a>
    </nav>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

    <div class="cabinet-section" data-section="personal">
        <div class="cabinet-section-header" data-toggle-section>
            <h2>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <button type="button" class="section-toggle" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñº</button>
        </div>
        <div class="cabinet-section-body">
        <div class="profile-row">
            <div class="avatar-wrap" id="avatarWrap" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">
                <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                {% if avatar_url %}
                <img src="{{ avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" id="avatarImg">
                {% else %}
                <div class="avatar-placeholder-inner" id="avatarPlaceholder">üë§</div>
                {% endif %}
            </div>
            <div class="profile-info">
                <p><strong>–õ–æ–≥–∏–Ω:</strong> {{ user.username }}</p>
                <p><strong>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</strong> <span id="characterNameDisplay">{{ user.character_name or user.username }}</span> <button type="button" class="name-edit-btn" id="nameEditBtn" aria-label="–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è">‚úèÔ∏è</button></p>
                <div class="name-edit-inline" id="nameEditInline">
                    <input type="text" id="characterNameInput" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" maxlength="200">
                    <button type="button" id="nameEditSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="name-edit-cancel" id="nameEditCancel">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div class="level-block">
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> {{ user.level }}</p>
                    <p class="level-xp-text">–û–ø—ã—Ç –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: {{ user.xp_in_current_level }} / {{ user.xp_needed_for_next_level }}</p>
                    <div class="level-progress-wrap">
                        <div class="level-progress-fill" style="width: {{ (user.xp_in_current_level / user.xp_needed_for_next_level * 100) if user.xp_needed_for_next_level else 100 }}%;"></div>
                    </div>
                </div>
                <p class="energy-display"><strong>–≠–Ω–µ—Ä–≥–∏—è:</strong> <span id="energyCurrent">{{ user.current_energy_value }}</span> / <span id="energyMax">{{ user.energy }}</span> <span class="energy-hint">(–≤–æ—Å—Å—Ç. –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω)</span></p>
                <div class="skills-block">
                    <h4>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h4>
                    <div class="skill-row">
                        <span class="stat-label-wrap">
                            <label>–ê—Ç–∞–∫–∞</label>
                            <button type="button" class="stat-help" id="helpAttack" aria-label="–û–ø–∏—Å–∞–Ω–∏–µ">?</button>
                            <span class="stat-tooltip" id="tooltipAttack">–£—Ä–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–Ω–æ—Å–∏—Ç—Å—è –ø—Ä–∏ –∑–∞—Ö–≤–∞—Ç–µ –æ–±–ª–∞—Å—Ç–∏.</span>
                        </span>
                        <button type="button" class="skill-btn" id="skillDamageMinus" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å –∞—Ç–∞–∫—É">‚àí</button>
                        <span class="val" id="skillDamageVal">{{ user.damage }}</span>
                        <button type="button" class="skill-btn" id="skillDamagePlus" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å –∞—Ç–∞–∫—É">+</button>
                    </div>
                    <div class="skill-row">
                        <span class="stat-label-wrap">
                            <label>–ó–∞—â–∏—Ç–∞</label>
                            <button type="button" class="stat-help" id="helpDefense" aria-label="–û–ø–∏—Å–∞–Ω–∏–µ">?</button>
                            <span class="stat-tooltip" id="tooltipDefense">–û—á–∫–∏ –≤–ª–∏—è–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞—à –∫–ª–∞–Ω –ø–æ–ª—É—á–∞–µ—Ç –ø—Ä–∏ –∑–∞—â–∏—Ç–µ –æ–±–ª–∞—Å—Ç–∏.</span>
                        </span>
                        <button type="button" class="skill-btn" id="skillDefenseMinus" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å –∑–∞—â–∏—Ç—É">‚àí</button>
                        <span class="val" id="skillDefenseVal">{{ user.defense }}</span>
                        <button type="button" class="skill-btn" id="skillDefensePlus" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞—â–∏—Ç—É">+</button>
                    </div>
                    <div class="skill-row">
                        <span class="stat-label-wrap">
                            <label>–ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è</label>
                            <button type="button" class="stat-help" id="helpEnergy" aria-label="–û–ø–∏—Å–∞–Ω–∏–µ">?</button>
                            <span class="stat-tooltip" id="tooltipEnergy">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –æ–±–ª–∞—Å—Ç–µ–π. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω).</span>
                        </span>
                        <button type="button" class="skill-btn" id="skillEnergyMinus" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å –º–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—é">‚àí</button>
                        <span class="val" id="skillEnergyVal">{{ user.energy }}</span>
                        <button type="button" class="skill-btn" id="skillEnergyPlus" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å –º–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—é">+</button>
                    </div>
                    <div id="skillPointsBlock" class="skill-points-block" style="display: {{ 'none' if user.skill_points_available == 0 else 'block' }};">
                        <p id="skillPointsHint" class="skill-points-hint">–û—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤: <span id="skillPointsAvail">{{ user.skill_points_available }}</span></p>
                        <button type="button" class="skill-save-btn" id="skillSaveBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="cabinet-section balance-shop-section collapsed" data-section="balance-shop">
        <div class="cabinet-section-header" data-toggle-section>
            <h2>–ë–∞–ª–∞–Ω—Å –∏ –õ–∞–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
            <button type="button" class="section-toggle" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñº</button>
        </div>
        <div class="cabinet-section-body">
            <div class="balance-display-row">
                <div class="nums-balance-block" aria-label="–ë–∞–ª–∞–Ω—Å –ù—É–º–æ–≤">
                    <div class="nums-balance-main">
                        <span class="nums-value" id="numsBalanceDisplay">{{ user.nums_balance or 0 }}</span>
                        <span class="nums-suffix">–ù—É–º–æ–≤</span>
                    </div>
                    <span class="stat-label-wrap nums-tooltip-wrap">
                        <button type="button" class="stat-help" id="helpNums" aria-label="–û–ø–∏—Å–∞–Ω–∏–µ">?</button>
                        <span class="stat-tooltip" id="tooltipNums">–ù—É–º—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –±–∏—Ç–≤–µ –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é. –ù–∞–≥—Ä–∞–¥–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞–Ω–∏—è.</span>
                    </span>
                </div>
                <button type="button" class="shop-toggle-btn" id="shopToggleBtn">–õ–∞–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</button>
            </div>
            <div class="shop-grid-wrap" id="shopGridWrap">
                <div class="shop-category-block" id="shopCategoryEnhancement">
                    <h4>–£—Å–∏–ª–µ–Ω–∏—è</h4>
                    <div class="shop-tiles" id="shopTilesEnhancement"></div>
                </div>
                <div class="shop-category-block" id="shopCategoryCurse">
                    <h4>–ü—Ä–æ–∫–ª—è—Ç–∏—è</h4>
                    <div class="shop-tiles" id="shopTilesCurse"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="cabinet-section collapsed" data-section="inventory">
        <div class="cabinet-section-header" data-toggle-section>
            <h2>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
            <button type="button" class="section-toggle" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñº</button>
        </div>
        <div class="cabinet-section-body">
            <div class="inventory-tiles" id="inventoryTiles"></div>
            <p class="inventory-empty" id="inventoryEmpty" style="display: none;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ü–æ–∫—É–ø–∞–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –ª–∞–≤–∫–µ.</p>
        </div>
    </div>

    <div class="cabinet-section collapsed" data-section="stats">
        <div class="cabinet-section-header" data-toggle-section>
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏—Ç–≤—ã –∑–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é</h2>
            <button type="button" class="section-toggle" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñº</button>
        </div>
        <div class="cabinet-section-body">
        <div class="stats-row">
            <div class="stat-item">
                <strong>–£—Ä–æ–Ω –Ω–∞–Ω–µ—Å—ë–Ω–Ω—ã–π –¥—Ä—É–≥–∏–º –∫–ª–∞–Ω–∞–º</strong>
                <span id="statDamage">{{ user.total_damage_dealt }}</span>
            </div>
            <div class="stat-item">
                <strong>–û—á–∫–∏ –≤–ª–∏—è–Ω–∏—è –∫–ª–∞–Ω—É (–∑–∞—â–∏—Ç–∞)</strong>
                <span id="statInfluence">{{ user.total_influence_points }}</span>
            </div>
        </div>
        </div>
    </div>

    <div class="cabinet-section collapsed" data-section="clan">
        <div class="cabinet-section-header" data-toggle-section>
            <h2>–ö–ª–∞–Ω</h2>
            <button type="button" class="section-toggle" aria-label="–°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å">‚ñº</button>
        </div>
        <div class="cabinet-section-body">
        {% if clan_data %}
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ -->
        <div class="clan-block">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ</h3>
            <div class="clan-view">
                {% if clan_data.clan.flag_url %}
                <img id="clanFlagDisplay" src="{{ clan_data.clan.flag_url }}" alt="–≠–º–±–ª–µ–º–∞" class="clan-view-emblem">
                {% else %}
                <div class="clan-view-emblem-placeholder">üè¥</div>
                {% endif %}
                <div>
                    <span class="clan-name" id="clanNameDisplay">{{ clan_data.clan.name }}</span>
                    {% if user.id == clan_data.clan.owner_id %}
                    <span style="font-size:0.85rem;color:#b8a088;"> (–≤–ª–∞–¥–µ–ª–µ—Ü)</span>
                    {% endif %}
                    <p style="margin:4px 0 0; font-size:0.9rem; color:#b8a088;">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {{ clan_data.members|length }}</p>
                </div>
            </div>
        </div>

        {% if user.id == clan_data.clan.owner_id %}
        <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∫–ª–∞–Ω–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) -->
        <div class="clan-block">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞</h3>
            <form id="clanEditForm" class="clan-edit-form" enctype="multipart/form-data">
                <div class="form-row">
                    <div>
                        <label>–≠–º–±–ª–µ–º–∞</label>
                        {% if clan_data.clan.flag_url %}
                        <img id="clanFlagPreview" src="{{ clan_data.clan.flag_url }}" alt="–≠–º–±–ª–µ–º–∞" class="clan-view-emblem" style="display:block;margin-bottom:6px;">
                        {% else %}
                        <div id="clanFlagPreview" class="clan-view-emblem-placeholder" style="margin-bottom:6px;">üè¥</div>
                        {% endif %}
                        <input type="file" name="flag" accept="image/*" id="clanFlagInput">
                    </div>
                    <div style="flex:1; min-width:180px;">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞</label>
                        <input type="text" value="{{ clan_data.clan.name }}" readonly disabled style="opacity:0.9; cursor:not-allowed;" title="–°–æ–∑–¥–∞—Ç–µ–ª—å –∫–ª–∞–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">
                        <p style="margin:4px 0 0; font-size:0.8rem; color:#b8a088;">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.</p>
                    </div>
                </div>
                <button type="submit" class="clan-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
        {% endif %}

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="clan-block">
            <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–ª–∞–Ω–∞</h3>
            <button type="button" class="clan-members-toggle" onclick="document.getElementById('membersList').classList.toggle('open')">
                –ü–æ–∫–∞–∑–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ({{ clan_data.members|length }})
            </button>
            <div id="membersList" class="members-list">
                {% for m in clan_data.members %}
                <div class="member-item">
                    {% if m.avatar_url %}
                    <img src="{{ m.avatar_url }}" alt="" class="member-avatar">
                    {% else %}
                    <div class="member-avatar-placeholder">üë§</div>
                    {% endif %}
                    <div class="member-info">
                        <span>{{ m.character_name }}{% if m.is_owner %} ‚òÖ{% endif %}</span>
                        <span class="member-level">–£—Ä. {{ m.level }}</span>
                    </div>
                    {% if user.id == clan_data.clan.owner_id and not m.is_owner %}
                    <button class="kick-btn" data-user-id="{{ m.id }}">–ò—Å–∫–ª—é—á–∏—Ç—å</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ß–∞—Ç —Å –∫–ª–∞–Ω–æ–º -->
        <div class="clan-block clan-chat-block">
            <h3>–ß–∞—Ç —Å –∫–ª–∞–Ω–æ–º</h3>
            <button type="button" id="clanChatToggleBtn" class="clan-members-toggle" onclick="var el=document.getElementById('clanChatContent'); var btn=document.getElementById('clanChatToggleBtn'); el.classList.toggle('open'); if(el.classList.contains('open')){ var m=document.getElementById('clanChatMessages'); if(m) m.scrollTop=m.scrollHeight; btn.textContent='–°–∫—Ä—ã—Ç—å —á–∞—Ç'; } else { btn.textContent='–ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç'; }">
                –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç
            </button>
            <div id="clanChatContent" class="clan-chat-content">
                <div id="clanChatMessages" class="clan-chat-messages">
                    <div class="clan-chat-empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶</div>
                </div>
                <div class="clan-chat-form">
                    <input type="text" id="clanChatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" maxlength="2000" autocomplete="off">
                    <button type="button" id="clanChatSendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –æ–±–ª–∞—Å—Ç–∏ -->
        <div class="clan-block">
            <h3>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –æ–±–ª–∞—Å—Ç–∏</h3>
            <button type="button" class="clan-members-toggle" onclick="document.getElementById('territoriesList').classList.toggle('open')">
                –ü–æ–∫–∞–∑–∞—Ç—å –æ–±–ª–∞—Å—Ç–∏
            </button>
            <div id="territoriesList" class="territories-list">
                {% for t in clan_data.territories %}
                <div class="territory-item">{{ t.display_name }} ‚Äî —Å–∏–ª–∞ {{ t.strength }}</div>
                {% endfor %}
                {% if not clan_data.territories %}
                <p style="color:#b8a088; margin:8px 0 0;">–ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π</p>
                {% endif %}
            </div>
        </div>

        {% if user.id == clan_data.clan.owner_id and clan_data.pending_requests %}
        <!-- –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
        <div class="clan-block" id="clan-join-requests">
            <h3>–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>
            <div id="pendingList" class="pending-list open">
                {% for r in clan_data.pending_requests %}
                <div class="pending-item" data-request-id="{{ r.id }}">
                    <span>{{ r.character_name }} ({{ r.username }})</span>
                    <span>
                        <button class="accept-btn" onclick="handleAccept({{ r.id }})">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="reject-btn" onclick="handleReject({{ r.id }})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –í—ã—Ö–æ–¥ –∏–∑ –∫–ª–∞–Ω–∞ -->
        <div class="clan-block">
            <button type="button" class="clan-btn danger" onclick="openLeaveModal()">–í—ã–π—Ç–∏ –∏–∑ –∫–ª–∞–Ω–∞</button>
        </div>
        {% elif pending_request %}
        <div class="clan-block">
            <p class="no-clan-msg">–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –∫–ª–∞–Ω –ø–æ–¥–∞–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è.</p>
            <button type="button" class="clan-btn" onclick="cancelRequest()">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
        {% else %}
        <div class="clan-block">
            <p class="no-clan-msg">–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.</p>
            <button type="button" class="clan-btn" onclick="openJoinModal()">–í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω</button>
            <button type="button" class="clan-btn" onclick="openCreateModal()">–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω</button>
        </div>
        {% endif %}
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block modals %}
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–ª–∞–Ω–∞ -->
<div class="modal-overlay" id="leaveModal">
    <div class="modal-box">
        <h3>–í—ã–π—Ç–∏ –∏–∑ –∫–ª–∞–Ω–∞?</h3>
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω?</p>
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeLeaveModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn-confirm danger" onclick="confirmLeave()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –∫–ª–∞–Ω -->
<div class="modal-overlay" id="joinModal">
    <div class="modal-box">
        <h3>–í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω</h3>
        <select id="joinClanSelect"></select>
        <div class="modal-buttons">
            <button type="button" class="btn-cancel" onclick="closeJoinModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn-confirm" onclick="confirmJoin()">–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) -->
<div class="modal-overlay" id="skillSavedModal">
    <div class="modal-box">
        <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</h3>
        <p>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.</p>
        <div class="modal-buttons">
            <button type="button" class="btn-confirm" id="skillSavedOkBtn">–•–æ—Ä–æ—à–æ</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞–Ω–∞ -->
<div class="modal-overlay" id="createModal">
    <div class="modal-box">
        <h3>–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω</h3>
        <form id="createClanForm" class="create-clan-form">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞</label>
            <input type="text" name="name" required minlength="2" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <label>–¶–≤–µ—Ç</label>
            <input type="color" name="color" value="#6b7280">
            <label>–§–ª–∞–≥ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)</label>
            <input type="file" name="flag" accept="image/*">
        </form>
        <div class="modal-buttons">
            <button type="button" class="btn-cancel" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn-confirm" onclick="confirmCreate()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–≤–∞—Ä–∞ –ª–∞–≤–∫–∏ -->
<div class="modal-overlay shop-item-modal" id="shopItemModal">
    <div class="modal-box">
        <h3 id="shopItemModalTitle">–¢–æ–≤–∞—Ä</h3>
        <div id="shopItemModalImageWrap"></div>
        <p id="shopItemModalDesc" style="margin: 12px 0; color: #2c1810;"></p>
        <p class="item-price" id="shopItemModalPrice"></p>
        <div class="modal-buttons">
            <button type="button" class="btn-cancel" id="shopItemModalClose">–ó–∞–∫—Ä—ã—Ç—å</button>
            <button type="button" class="btn-confirm btn-buy" id="shopItemModalBuy" disabled>–ö—É–ø–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var totalSkillPoints = {{ user.skill_points_total }};
    var skillState = {
        damage: {{ user.damage_skill or 0 }},
        defense: {{ user.defense_skill or 0 }},
        energy: {{ user.energy_skill or 0 }}
    };
    var savedState = {
        damage: {{ user.damage_skill or 0 }},
        defense: {{ user.defense_skill or 0 }},
        energy: {{ user.energy_skill or 0 }}
    };
    function spent() { return skillState.damage + skillState.defense + skillState.energy; }
    function available() { return Math.max(0, totalSkillPoints - spent()); }
    function hasUnsavedChanges() {
        return skillState.damage !== savedState.damage || skillState.defense !== savedState.defense || skillState.energy !== savedState.energy;
    }
    function updateSkillUI() {
        var baseDamage = 5, baseDefense = 5, baseEnergy = 10;
        document.getElementById('skillDamageVal').textContent = baseDamage + skillState.damage;
        document.getElementById('skillDefenseVal').textContent = baseDefense + skillState.defense;
        document.getElementById('skillEnergyVal').textContent = baseEnergy + skillState.energy;
        var dispDamage = document.getElementById('displayDamage');
        if (dispDamage) dispDamage.textContent = baseDamage + skillState.damage;
        var av = available();
        var pointsBlock = document.getElementById('skillPointsBlock');
        var pointsHint = document.getElementById('skillPointsHint');
        if (pointsBlock) pointsBlock.style.display = (av > 0 || hasUnsavedChanges()) ? 'block' : 'none';
        if (pointsHint) pointsHint.style.display = av > 0 ? 'block' : 'none';
        document.getElementById('skillPointsAvail').textContent = av;
        document.getElementById('skillDamagePlus').disabled = av <= 0;
        document.getElementById('skillDefensePlus').disabled = av <= 0;
        document.getElementById('skillEnergyPlus').disabled = av <= 0;
        document.getElementById('skillDamageMinus').disabled = skillState.damage <= savedState.damage;
        document.getElementById('skillDefenseMinus').disabled = skillState.defense <= savedState.defense;
        document.getElementById('skillEnergyMinus').disabled = skillState.energy <= savedState.energy;
    }
    function skillPlus(stat) {
        if (available() <= 0) return;
        skillState[stat]++;
        updateSkillUI();
    }
    function skillMinus(stat) {
        if (skillState[stat] <= savedState[stat]) return;
        skillState[stat]--;
        updateSkillUI();
    }
    document.getElementById('skillDamagePlus')?.addEventListener('click', function() { skillPlus('damage'); });
    document.getElementById('skillDamageMinus')?.addEventListener('click', function() { skillMinus('damage'); });
    document.getElementById('skillDefensePlus')?.addEventListener('click', function() { skillPlus('defense'); });
    document.getElementById('skillDefenseMinus')?.addEventListener('click', function() { skillMinus('defense'); });
    document.getElementById('skillEnergyPlus')?.addEventListener('click', function() { skillPlus('energy'); });
    document.getElementById('skillEnergyMinus')?.addEventListener('click', function() { skillMinus('energy'); });

    (function() {
        var helpPairs = [
            { btn: 'helpAttack', tooltip: 'tooltipAttack' },
            { btn: 'helpDefense', tooltip: 'tooltipDefense' },
            { btn: 'helpEnergy', tooltip: 'tooltipEnergy' },
            { btn: 'helpNums', tooltip: 'tooltipNums' }
        ];
        function closeAllTooltips() {
            helpPairs.forEach(function(p) {
                var t = document.getElementById(p.tooltip);
                var b = document.getElementById(p.btn);
                if (t) t.classList.remove('show');
                if (b) b.classList.remove('active');
            });
        }
        helpPairs.forEach(function(p) {
            var btn = document.getElementById(p.btn);
            var tooltip = document.getElementById(p.tooltip);
            if (!btn || !tooltip) return;
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                var isOpen = tooltip.classList.contains('show');
                closeAllTooltips();
                if (!isOpen) {
                    tooltip.classList.add('show');
                    btn.classList.add('active');
                }
            });
        });
        document.addEventListener('click', closeAllTooltips);
    })();
    document.getElementById('skillSaveBtn')?.addEventListener('click', function() {
        var btn = this;
        btn.disabled = true;
        fetch('{{ url_for("api_cabinet_skills") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                damage_skill: skillState.damage,
                defense_skill: skillState.defense,
                energy_skill: skillState.energy
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                savedState.damage = skillState.damage;
                savedState.defense = skillState.defense;
                savedState.energy = skillState.energy;
                var dispD = document.getElementById('displayDamage');
                if (dispD) dispD.textContent = data.damage;
                document.getElementById('skillDamageVal').textContent = data.damage;
                document.getElementById('skillDefenseVal').textContent = data.defense;
                document.getElementById('skillEnergyVal').textContent = data.energy;
                document.getElementById('skillPointsAvail').textContent = data.skill_points_available;
                if (data.current_energy !== undefined) {
                    var ec = document.getElementById('energyCurrent');
                    if (ec) ec.textContent = data.current_energy;
                }
                if (data.energy !== undefined) {
                    var em = document.getElementById('energyMax');
                    if (em) em.textContent = data.energy;
                }
                updateSkillUI();
                openSkillSavedModal();
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞');
            }
        })
        .catch(function() { alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); })
        .finally(function() { btn.disabled = false; });
    });
    updateSkillUI();

    var skillSavedTimer = null;
    function openSkillSavedModal() {
        var m = document.getElementById('skillSavedModal');
        if (!m) return;
        if (skillSavedTimer) clearTimeout(skillSavedTimer);
        m.style.display = 'flex';
        m.style.visibility = 'visible';
        m.classList.add('open');
        document.body.appendChild(m);
        skillSavedTimer = setTimeout(function() {
            skillSavedTimer = null;
            closeSkillSavedModal();
        }, 5000);
    }
    function closeSkillSavedModal() {
        var m = document.getElementById('skillSavedModal');
        if (m) {
            m.classList.remove('open');
            m.style.display = '';
            m.style.visibility = '';
        }
    }
    document.getElementById('skillSavedOkBtn')?.addEventListener('click', function() {
        if (skillSavedTimer) clearTimeout(skillSavedTimer);
        skillSavedTimer = null;
        closeSkillSavedModal();
    });
})();

(function() {
    var avatarWrap = document.getElementById('avatarWrap');
    var avatarFileInput = document.getElementById('avatarFileInput');
    if (avatarWrap && avatarFileInput) {
        avatarWrap.addEventListener('click', function() { avatarFileInput.click(); });
        avatarFileInput.addEventListener('change', function() {
            if (!this.files || !this.files[0]) return;
            var fd = new FormData();
            fd.append('avatar', this.files[0]);
            fd.append('character_name', (document.getElementById('characterNameDisplay') || {}).textContent || '');
            fetch('{{ url_for("api_cabinet_profile") }}', { method: 'POST', body: fd })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        if (data.avatar_url) {
                            var img = document.getElementById('avatarImg');
                            var placeholder = document.getElementById('avatarPlaceholder');
                            if (img) {
                                img.src = data.avatar_url;
                            } else if (placeholder) {
                                var newImg = document.createElement('img');
                                newImg.id = 'avatarImg';
                                newImg.alt = '–ê–≤–∞—Ç–∞—Ä';
                                newImg.src = data.avatar_url;
                                placeholder.parentNode.replaceChild(newImg, placeholder);
                            }
                        }
                    } else { alert(data.error || '–û—à–∏–±–∫–∞'); }
                })
                .catch(function() { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); });
            this.value = '';
        });
    }
})();

(function() {
    var nameDisplay = document.getElementById('characterNameDisplay');
    var nameEditBtn = document.getElementById('nameEditBtn');
    var nameEditInline = document.getElementById('nameEditInline');
    var nameInput = document.getElementById('characterNameInput');
    var nameEditSave = document.getElementById('nameEditSave');
    var nameEditCancel = document.getElementById('nameEditCancel');
    if (!nameEditBtn || !nameEditInline || !nameInput) return;
    function showNameEdit() {
        nameInput.value = (nameDisplay && nameDisplay.textContent) ? nameDisplay.textContent.trim() : '';
        nameEditInline.classList.add('open');
        nameInput.focus();
    }
    function hideNameEdit() {
        nameEditInline.classList.remove('open');
    }
    function saveName() {
        var val = nameInput.value.trim();
        var fd = new FormData();
        fd.append('character_name', val);
        fetch('{{ url_for("api_cabinet_profile") }}', { method: 'POST', body: fd })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    if (nameDisplay) nameDisplay.textContent = val || nameDisplay.textContent;
                    hideNameEdit();
                } else { alert(data.error || '–û—à–∏–±–∫–∞'); }
            })
            .catch(function() { alert('–û—à–∏–±–∫–∞'); });
    }
    nameEditBtn.addEventListener('click', showNameEdit);
    nameEditSave.addEventListener('click', saveName);
    nameEditCancel.addEventListener('click', hideNameEdit);
    nameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); saveName(); }
        if (e.key === 'Escape') { e.preventDefault(); hideNameEdit(); }
    });
})();

document.getElementById('clanEditForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    var form = this;
    var clanId = {{ clan_data.clan.id if clan_data and clan_data.clan else 'null' }};
    if (!clanId) return;
    var fd = new FormData();
    var flagInput = form.querySelector('[name=flag]');
    if (flagInput && flagInput.files[0]) fd.append('flag', flagInput.files[0]);
    fetch('/api/clan/' + clanId + '/update', { method: 'POST', body: fd })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                alert('–ö–ª–∞–Ω –æ–±–Ω–æ–≤–ª—ë–Ω');
                document.getElementById('clanNameDisplay').textContent = data.clan.name;
                var flagUrl = data.clan.flag_url;
                if (flagUrl) {
                    var preview = document.getElementById('clanFlagPreview');
                    if (preview && preview.tagName === 'IMG') preview.src = flagUrl;
                    else if (preview) { var img = document.createElement('img'); img.id = 'clanFlagPreview'; img.src = flagUrl; img.className = 'clan-view-emblem'; img.style.cssText = 'display:block;margin-bottom:6px;'; preview.parentNode.replaceChild(img, preview); }
                    var infoEmblem = document.querySelector('.clan-block .clan-view .clan-view-emblem, .clan-block .clan-view .clan-view-emblem-placeholder');
                    if (infoEmblem) { var disp = document.createElement('img'); disp.className = 'clan-view-emblem'; disp.src = flagUrl; disp.alt = '–≠–º–±–ª–µ–º–∞'; infoEmblem.parentNode.replaceChild(disp, infoEmblem); }
                }
                if (flagInput) flagInput.value = '';
            } else { alert(data.error || '–û—à–∏–±–∫–∞'); }
        })
        .catch(function() { alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); });
});

{% if clan_data %}
document.querySelectorAll('.kick-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('–ò—Å–∫–ª—é—á–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) return;
        const uid = this.dataset.userId;
        fetch(`/api/clan/{{ clan_data.clan.id }}/kick/${uid}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert(data.error || '–û—à–∏–±–∫–∞');
            });
    });
});
{% endif %}

function openLeaveModal() {
    var m = document.getElementById('leaveModal');
    if (m) { m.style.display = 'flex'; m.style.visibility = 'visible'; m.classList.add('open'); document.body.appendChild(m); }
}
function closeLeaveModal() {
    var m = document.getElementById('leaveModal');
    if (m) { m.classList.remove('open'); m.style.display = ''; m.style.visibility = ''; }
}
function confirmLeave() {
    fetch('{{ url_for("api_clan_leave") }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else { alert(data.error || '–û—à–∏–±–∫–∞'); closeLeaveModal(); }
        });
}

function openJoinModal() {
    var modal = document.getElementById('joinModal');
    var sel = document.getElementById('joinClanSelect');
    if (!modal) modal = document.querySelector('.modal-overlay#joinModal');
    if (!modal) return;
    sel = modal.querySelector('select') || document.getElementById('joinClanSelect');
    if (sel) sel.innerHTML = '<option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞... ‚Äî</option>';
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.classList.add('open');
    document.body.appendChild(modal);
    fetch('{{ url_for("api_clans_list") }}')
        .then(function(r) {
            if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–ª–∞–Ω–æ–≤');
            return r.json();
        })
        .then(function(clans) {
            var s = document.getElementById('joinClanSelect');
            if (!s) return;
            var list = Array.isArray(clans) ? clans : [];
            s.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞–Ω ‚Äî</option>' +
                list.map(function(c) { return '<option value="' + c.id + '">' + (c.name || '') + '</option>'; }).join('');
        })
        .catch(function(err) {
            var s = document.getElementById('joinClanSelect');
            if (s) s.innerHTML = '<option value="">‚Äî –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî</option>';
            alert(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–æ–≤');
        });
}
function closeJoinModal() {
    var m = document.getElementById('joinModal');
    if (m) { m.classList.remove('open'); m.style.display = ''; m.style.visibility = ''; }
}
function confirmJoin() {
    const cid = document.getElementById('joinClanSelect').value;
    if (!cid) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞–Ω'); return; }
    fetch('{{ url_for("api_clan_join_request") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ clan_id: parseInt(cid) })
    }).then(r => r.json())
      .then(data => {
          if (data.success) location.reload();
          else alert(data.error || '–û—à–∏–±–∫–∞');
      });
}

function cancelRequest() {
    fetch('{{ url_for("api_clan_cancel_request") }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert(data.error || '–û—à–∏–±–∫–∞');
        });
}

{% if clan_data %}
function handleAccept(rid) {
    fetch(`/api/clan/{{ clan_data.clan.id }}/accept/${rid}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); else alert(data.error); });
}
function handleReject(rid) {
    fetch(`/api/clan/{{ clan_data.clan.id }}/reject/${rid}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => { if (data.success) location.reload(); else alert(data.error); });
}
{% endif %}

function openCreateModal() {
    var m = document.getElementById('createModal');
    if (m) { m.style.display = 'flex'; m.style.visibility = 'visible'; m.classList.add('open'); document.body.appendChild(m); }
}
function closeCreateModal() {
    var m = document.getElementById('createModal');
    if (m) { m.classList.remove('open'); m.style.display = ''; m.style.visibility = ''; }
}
function confirmCreate() {
    const form = document.getElementById('createClanForm');
    if (!form) return;
    const fd = new FormData();
    fd.append('name', form.querySelector('[name=name]').value || '');
    fd.append('color', form.querySelector('[name=color]').value || '#6b7280');
    const file = form.querySelector('[name=flag]');
    if (file && file.files[0]) fd.append('flag', file.files[0]);
    fetch('{{ url_for("api_clan_create") }}', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert(data.error || '–û—à–∏–±–∫–∞');
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'));
}

var CURRENT_USER_ID = {{ user.id }};

(function clanChat() {
    var container = document.getElementById('clanChatMessages');
    if (!container) return;
    var input = document.getElementById('clanChatInput');
    var sendBtn = document.getElementById('clanChatSendBtn');
    var chatUrl = '{{ url_for("api_clan_chat_list") }}';
    var chatMessages = [];
    var hasMore = false;
    var loading = false;
    var loadingMore = false;

    function formatTime(iso) {
        if (!iso) return '';
        var d = new Date(iso);
        return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
            d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function msgToHtml(m) {
        var ownClass = (m.user_id === CURRENT_USER_ID) ? ' clan-chat-msg-own' : '';
        return '<div class="clan-chat-msg' + ownClass + '" data-id="' + m.id + '">' +
            '<span class="chat-author">' + escapeHtml(m.author_name) + '</span>' +
            '<span class="chat-time">' + escapeHtml(formatTime(m.created_at)) + '</span>' +
            '<div class="chat-text">' + escapeHtml(m.text) + '</div></div>';
    }

    function renderAll() {
        if (chatMessages.length === 0) {
            container.innerHTML = '<div class="clan-chat-empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
            return;
        }
        container.innerHTML = chatMessages.map(msgToHtml).join('');
        container.scrollTop = container.scrollHeight;
    }

    function prependMessages(newMsgs) {
        if (!newMsgs || newMsgs.length === 0) return;
        var oldScrollHeight = container.scrollHeight;
        var oldScrollTop = container.scrollTop;
        var fragment = newMsgs.map(msgToHtml).join('');
        var emptyEl = container.querySelector('.clan-chat-empty');
        if (emptyEl) {
            container.innerHTML = fragment;
        } else {
            container.insertAdjacentHTML('afterbegin', fragment);
        }
        container.scrollTop = container.scrollHeight - oldScrollHeight + oldScrollTop;
    }

    function appendMessages(newMsgs) {
        if (!newMsgs || newMsgs.length === 0) return;
        var wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 20;
        var emptyEl = container.querySelector('.clan-chat-empty');
        if (emptyEl) {
            container.innerHTML = newMsgs.map(msgToHtml).join('');
        } else {
            newMsgs.forEach(function(m) {
                container.insertAdjacentHTML('beforeend', msgToHtml(m));
            });
        }
        if (wasAtBottom) container.scrollTop = container.scrollHeight;
    }

    function loadClanChat(appendNewOnly) {
        if (appendNewOnly) {
            if (chatMessages.length === 0) return;
            var newestId = chatMessages[chatMessages.length - 1].id;
            fetch(chatUrl + '?after_id=' + newestId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success && data.messages && data.messages.length > 0) {
                        data.messages.forEach(function(m) { chatMessages.push(m); });
                        appendMessages(data.messages);
                    }
                });
            return;
        }
        if (loading) return;
        loading = true;
        fetch(chatUrl + '?limit=20')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading = false;
                if (data.success) {
                    chatMessages = data.messages || [];
                    hasMore = !!data.has_more;
                    renderAll();
                } else {
                    container.innerHTML = '<div class="clan-chat-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
                }
            })
            .catch(function() {
                loading = false;
                if (container.querySelector('.clan-chat-empty') && container.textContent.indexOf('–ó–∞–≥—Ä—É–∑–∫–∞') !== -1)
                    container.innerHTML = '<div class="clan-chat-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</div>';
            });
    }

    function loadMore() {
        if (!hasMore || loadingMore || chatMessages.length === 0) return;
        var oldestId = chatMessages[0].id;
        loadingMore = true;
        fetch(chatUrl + '?limit=20&before_id=' + oldestId)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loadingMore = false;
                if (data.success && data.messages && data.messages.length > 0) {
                    hasMore = !!data.has_more;
                    data.messages.forEach(function(m) { chatMessages.unshift(m); });
                    prependMessages(data.messages);
                } else {
                    hasMore = false;
                }
            });
    }

    container.addEventListener('scroll', function() {
        if (container.scrollTop < 80 && hasMore && !loadingMore) loadMore();
    });

    function sendMessage() {
        var text = (input && input.value || '').trim();
        if (!text) return;
        if (sendBtn) sendBtn.disabled = true;
        fetch(chatUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (sendBtn) sendBtn.disabled = false;
                if (data.success && data.message) {
                    input.value = '';
                    chatMessages.push(data.message);
                    appendMessages([data.message]);
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            })
            .catch(function() {
                if (sendBtn) sendBtn.disabled = false;
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
    }

    loadClanChat();
    setInterval(function() { loadClanChat(true); }, 10000);

    if (sendBtn) sendBtn.addEventListener('click', sendMessage);
    if (input) input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
    });
})();

(function() {
    if (window.location.hash !== '#clan-join-requests') return;
    var el = document.getElementById('clan-join-requests');
    if (!el) return;
    setTimeout(function() {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
})();

(function() {
    document.querySelectorAll('[data-toggle-section]').forEach(function(header) {
        var section = header.closest('.cabinet-section');
        if (!section) return;
        header.addEventListener('click', function() {
            section.classList.toggle('collapsed');
        });
    });
    var shopToggleBtn = document.getElementById('shopToggleBtn');
    var shopGridWrap = document.getElementById('shopGridWrap');
    if (shopToggleBtn && shopGridWrap) {
        shopToggleBtn.addEventListener('click', function() {
            shopGridWrap.classList.toggle('open');
        });
    }
    var balanceDisplay = document.getElementById('numsBalanceDisplay');
    function getBalance() { return parseInt(balanceDisplay ? balanceDisplay.textContent : 0, 10) || 0; }
    function setBalance(v) { if (balanceDisplay) balanceDisplay.textContent = v; }

    function renderShopTiles(items) {
        var enh = document.getElementById('shopTilesEnhancement');
        var cur = document.getElementById('shopTilesCurse');
        if (!enh || !cur) return;
        enh.innerHTML = '';
        cur.innerHTML = '';
        (items.enhancement || []).forEach(function(it) { enh.appendChild(createTile(it)); });
        (items.curse || []).forEach(function(it) { cur.appendChild(createTile(it)); });
    }
    function createTile(it) {
        var div = document.createElement('div');
        div.className = 'shop-item-tile';
        div.setAttribute('data-item-id', it.id);
        if (it.image_url) {
            var img = document.createElement('img');
            img.src = it.image_url;
            img.alt = it.name;
            div.appendChild(img);
        } else {
            var ph = document.createElement('div');
            ph.className = 'tile-placeholder';
            ph.textContent = 'üì¶';
            div.appendChild(ph);
        }
        var name = document.createElement('div');
        name.className = 'tile-name';
        name.textContent = it.name;
        div.appendChild(name);
        var price = document.createElement('div');
        price.className = 'tile-price';
        price.textContent = it.price + ' –ù—É–º–æ–≤';
        div.appendChild(price);
        return div;
    }
    function loadShop() {
        fetch('{{ url_for("api_shop_items") }}')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success && data.items) renderShopTiles(data.items);
            });
    }
    function loadInventory() {
        fetch('{{ url_for("api_cabinet_inventory") }}')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var container = document.getElementById('inventoryTiles');
                var empty = document.getElementById('inventoryEmpty');
                if (!container) return;
                container.innerHTML = '';
                var list = (data.success && data.inventory) ? data.inventory : [];
                if (list.length === 0) {
                    if (empty) empty.style.display = 'block';
                    return;
                }
                if (empty) empty.style.display = 'none';
                list.forEach(function(p) {
                    var div = document.createElement('div');
                    div.className = 'inventory-tile';
                    if (p.image_url) {
                        var img = document.createElement('img');
                        img.src = p.image_url;
                        img.alt = p.name;
                        div.appendChild(img);
                    } else {
                        var ph = document.createElement('div');
                        ph.className = 'tile-placeholder';
                        ph.textContent = 'üì¶';
                        div.appendChild(ph);
                    }
                    var name = document.createElement('div');
                    name.className = 'tile-name';
                    name.textContent = p.name;
                    div.appendChild(name);
                    container.appendChild(div);
                });
            });
    }
    loadShop();
    loadInventory();

    var shopItemModal = document.getElementById('shopItemModal');
    var shopItemModalTitle = document.getElementById('shopItemModalTitle');
    var shopItemModalImageWrap = document.getElementById('shopItemModalImageWrap');
    var shopItemModalDesc = document.getElementById('shopItemModalDesc');
    var shopItemModalPrice = document.getElementById('shopItemModalPrice');
    var shopItemModalBuy = document.getElementById('shopItemModalBuy');
    var shopItemModalClose = document.getElementById('shopItemModalClose');
    var currentShopItemId = null;

    document.getElementById('shopGridWrap')?.addEventListener('click', function(e) {
        var tile = e.target.closest('.shop-item-tile');
        if (!tile) return;
        var id = tile.getAttribute('data-item-id');
        if (!id) return;
        fetch('{{ url_for("api_shop_item_detail", item_id=0) }}'.replace('/0', '/' + id))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (!data.success || !data.item) return;
                var item = data.item;
                currentShopItemId = item.id;
                shopItemModalTitle.textContent = item.name;
                shopItemModalImageWrap.innerHTML = '';
                if (item.image_url) {
                    var img = document.createElement('img');
                    img.className = 'item-image';
                    img.src = item.image_url;
                    img.alt = item.name;
                    shopItemModalImageWrap.appendChild(img);
                } else {
                    var ph = document.createElement('div');
                    ph.className = 'item-image-placeholder';
                    ph.textContent = 'üì¶';
                    shopItemModalImageWrap.appendChild(ph);
                }
                shopItemModalDesc.textContent = item.description || '‚Äî';
                shopItemModalPrice.textContent = item.price + ' –ù—É–º–æ–≤';
                var balance = getBalance();
                shopItemModalBuy.disabled = balance < item.price;
                shopItemModal.classList.add('open');
                shopItemModal.style.display = 'flex';
            });
    });
    function closeShopItemModal() {
        shopItemModal.classList.remove('open');
        shopItemModal.style.display = 'none';
        currentShopItemId = null;
    }
    shopItemModalClose?.addEventListener('click', closeShopItemModal);
    shopItemModal?.addEventListener('click', function(e) {
        if (e.target === shopItemModal) closeShopItemModal();
    });
    shopItemModalBuy?.addEventListener('click', function() {
        if (!currentShopItemId || this.disabled) return;
        this.disabled = true;
        fetch('{{ url_for("api_shop_purchase") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: currentShopItemId })
        })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    setBalance(data.balance);
                    loadInventory();
                    closeShopItemModal();
                } else {
                    alert(data.error || '–û—à–∏–±–∫–∞');
                }
            })
            .catch(function() { alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); })
            .finally(function() { shopItemModalBuy.disabled = false; });
    });
})();

</script>
{% endblock %}
